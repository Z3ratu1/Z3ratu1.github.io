<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.z3ratu1.cn","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="zer0ptsCTF2023只用上班一天，好耶。一堆前端题，又是一场xss大师赛，不会做捏。因为打了点输出就可以记录了题目感觉质量都还行，确实也如他们所说，没有要猜的题。难度，我能做出来，所以应该不算很难。嗯感觉如果打两天的话就能ak了，可惜。不过ak也和我没什么关系 warmup profile签到，其实也还是有一定的难度的。目标是登录admin的账户获取flag。 使用了一个叫sequeliz">
<meta property="og:type" content="article">
<meta property="og:title" content="zer0ptsCTF2023">
<meta property="og:url" content="https://blog.z3ratu1.cn/zer0ptsCTF2023.html">
<meta property="og:site_name" content="Z3ratu1&#39;s blog">
<meta property="og:description" content="zer0ptsCTF2023只用上班一天，好耶。一堆前端题，又是一场xss大师赛，不会做捏。因为打了点输出就可以记录了题目感觉质量都还行，确实也如他们所说，没有要猜的题。难度，我能做出来，所以应该不算很难。嗯感觉如果打两天的话就能ak了，可惜。不过ak也和我没什么关系 warmup profile签到，其实也还是有一定的难度的。目标是登录admin的账户获取flag。 使用了一个叫sequeliz">
<meta property="og:locale">
<meta property="article:published_time" content="2023-07-17T08:20:41.000Z">
<meta property="article:modified_time" content="2023-07-17T14:00:35.327Z">
<meta property="article:author" content="Z3ratu1">
<meta property="article:tag" content="wp">
<meta property="article:tag" content="XSS">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.z3ratu1.cn/zer0ptsCTF2023.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>zer0ptsCTF2023 | Z3ratu1's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Z3ratu1's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Welcome</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/Z3ratu1" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://blog.z3ratu1.cn/zer0ptsCTF2023.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
      <meta itemprop="name" content="Z3ratu1">
      <meta itemprop="description" content="与其感慨路难行，不如现在出发">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z3ratu1's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          zer0ptsCTF2023
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-07-17 16:20:41 / 修改时间：22:00:35" itemprop="dateCreated datePublished" datetime="2023-07-17T16:20:41+08:00">2023-07-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">刷题记录</span></a>
                </span>
            </span>

          
            <span id="/zer0ptsCTF2023.html" class="post-meta-item leancloud_visitors" data-flag-title="zer0ptsCTF2023" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/zer0ptsCTF2023.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/zer0ptsCTF2023.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="zer0ptsCTF2023"><a href="#zer0ptsCTF2023" class="headerlink" title="zer0ptsCTF2023"></a>zer0ptsCTF2023</h1><p>只用上班一天，好耶。一堆前端题，又是一场xss大师赛，不会做捏。因为打了点输出就可以记录了<br>题目感觉质量都还行，确实也如他们所说，没有要猜的题。难度，我能做出来，所以应该不算很难。嗯<br>感觉如果打两天的话就能ak了，可惜。不过ak也和我没什么关系</p>
<h2 id="warmup-profile"><a href="#warmup-profile" class="headerlink" title="warmup profile"></a>warmup profile</h2><p>签到，其实也还是有一定的难度的。目标是登录admin的账户获取flag。</p>
<p>使用了一个叫<code>sequelize</code>的库连接数据库，顶级防御，无SQL注入，且登录注册时严格校验了输入不为空且类型为字符串，看起来就觉得只有delete那块可能有洞</p>
<pre class=" language-JavaScript"><code class="language-JavaScript">app.post('/user/:username/delete', needAuth, async (req, res) => {
    const { username } = req.params;
    const { username: loggedInUsername } = req.session;
    if (loggedInUsername !== 'admin' && loggedInUsername !== username) {
        flash(req, 'general user can only delete itself');
        return res.redirect('/');
    }

    // find user to be deleted
    const user = await User.findOne({
        where: { username }
    });

    await User.destroy({
        where: { ...user?.dataValues }
    });

    // user is deleted, so session should be logged out
    req.session.destroy();
    return res.redirect('/');
});
</code></pre>
<p>但是只有admin用户才能删任意用户，普通用户只能删自己。删除是通过寻找到当前用户实例再删的。实际上用户名不允许重复，直接使用用户名删也是可以的，所以这就是漏洞所在。</p>
<p>可以开两浏览器同时登陆一个账号，第一个浏览器先自我删号，第二个浏览器再删号，这时find就没法找到对应的用户数据了，而destroy的where字段传入空对象时，会将整个数据库删掉，接下来重新注册一个admin账户即可获取flag</p>
<p>该题显然环境不能共享，所以是所有web题里唯一一个启动docker的独立环境。</p>
<h2 id="jqi"><a href="#jqi" class="headerlink" title="jqi"></a>jqi</h2><p>代码量也不大，就是能用jq进行查询，然后flag被放在环境变量里面，过滤也不是很严格，并且最后需要是一个盲注。</p>
<p>jq是一个能够处理json的特殊工具，玄学json查询语法<br>这个题和我没什么关系，天哥秒了</p>
<pre class=" language-javascript"><code class="language-javascript">    <span class="token keyword">const</span> KEYS <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token string">'author'</span><span class="token punctuation">,</span> <span class="token string">'flag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token string">'keys'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> KEYS<span class="token punctuation">;</span>
    <span class="token keyword">const</span> conds <span class="token operator">=</span> <span class="token string">'conds'</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>query <span class="token operator">?</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>conds<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// build query for selecting keys</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>KEYS<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> keysQuery <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>key <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// build query for filtering results</span>
    <span class="token keyword">let</span> condsQuery <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> cond <span class="token keyword">of</span> conds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">[</span>str<span class="token punctuation">,</span> key<span class="token punctuation">]</span> <span class="token operator">=</span> cond<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' in '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>KEYS<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'invalid key'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// check if the query is trying to break string literal</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span> <span class="token operator">||</span> str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'\\('</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'hacking attempt detected'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        condsQuery <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`| select(.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | contains("</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>str<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"))`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token string">`[.challenges[] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>condsQuery<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> | {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keysQuery<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}]`</span></span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> jq<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token string">'./data.json'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> output<span class="token punctuation">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'something wrong'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[+] result:'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conds<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'sorry, you cannot use filters in demo version'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        reply<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>本来是在想有没有可能任意文件读，或者jq.run那里能不能直接注入rce之类的，看半天没有用<br>keys和conds都用户可控，使用了cond后就没有回显了，只能盲注。天哥发现jq可以直接使用<code>$ENV.FLAG</code>直接访问环境变量，那现在就只要找个注入了</p>
<p>这里的过滤禁用了引号，还禁用了<code>\\(</code>，后面这个禁用不知道有什么用。禁用引号并且还能同时控制多段内容，使用经典的反斜杠转义配合注释符即可进行注入，翻了下文档注释符是井号<code>#</code>。</p>
<p>所以令cond为<code>\+in+name,))+|+payload]%23+in+flag</code>即可完成逃逸，不过这样子会导致查询的内容有一个限制条件是<code>contains(&quot;xxxxxxx&quot;)</code>，其中的内容是被我们转义引号吞掉的大量合法内容，这种情况下查出来的一定是一个空结果，所以还得找其他办法。比如使用or关键字就能保证后续的操作能够继续执行</p>
<p>最后一点是盲注，首先需要一位位的进行查询，这里有一个explode关键字，可以将字符串转换为ascii码，其次是需要在查询正确或失败时产生一个错误，才能使得服务端有不同的回显，实现盲注流程。</p>
<p>这里直接抄天哥最后的payload</p>
<pre><code>a\ in name,) or ($ENV.FLAG|explode|.[0] ==111))|$ENV.FLAG|.aaa]# in tags
</code></pre>
<p>然后二分写出来的时候估计硬爆早爆完了，所以直接硬爆</p>
<h2 id="Plain-Blog"><a href="#Plain-Blog" class="headerlink" title="Plain Blog"></a>Plain Blog</h2><p>XSS题，一个前后端分离，后端用ruby写的怪东西<br>留言板，可以随便写留言，但是没有xss，有一个bot，bot可以帮用户点1k个赞，或者修改post的属性<br>目标是获取到1万亿个赞，此时就会将post中的permission属性下的flag修改为true，即可使用该post获取flag。该但是题目中有顶级限制，如果当前like加上获取到的like超过5000，就不会再往上加了，一开始以为是整数溢出之类的，后来测了一下，ruby好像溢出不动，能按到300多位十进制，超出这个数后会变成正无穷，反正就是不溢出。所以正常点赞这条路肯定是走不通的。应当考虑如何直接把permission的flag修改为true</p>
<pre class=" language-ruby"><code class="language-ruby">    likes <span class="token operator">=</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'likes'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_i
    <span class="token keyword">if</span> <span class="token operator">!</span>is_admin <span class="token operator">&amp;&amp;</span> likes <span class="token operator">!=</span> <span class="token number">1</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'you can add only one like at one time'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'like'</span><span class="token punctuation">]</span> <span class="token operator">+</span> likes<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token constant">MAX_LIKES</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'too much likes'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>
    posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'like'</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> likes

    <span class="token comment" spellcheck="true"># get 1,000,000,000,000 likes to capture the flag!</span>
    <span class="token keyword">if</span> posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'like'</span><span class="token punctuation">]</span> <span class="token operator">>=</span> 1_000_000_000_000
        posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'permission'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'flag'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>
    <span class="token keyword">end</span>
</code></pre>
<p>这里有一个put路由，就可以修改用户post的属性，但仅支持put方法请求。。。</p>
<pre class=" language-ruby"><code class="language-ruby">put <span class="token string">'/api/post/:id'</span> <span class="token keyword">do</span>
    token <span class="token operator">=</span> request<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'HTTP_AUTHORIZATION'</span><span class="token punctuation">]</span>
    is_admin <span class="token operator">=</span> token <span class="token operator">==</span> <span class="token constant">ADMIN_KEY</span>

    id <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>posts<span class="token punctuation">.</span>key<span class="token operator">?</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'no such post'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>

    id <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token constant">SAMPLE_IDS</span><span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'sample post should not be updated'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> <span class="token operator">!</span>is_admin <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">[</span><span class="token string">'permission'</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'only admin can change the parameter'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>

    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">||</span> params<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'error'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'no title and content specified'</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_json
    <span class="token keyword">end</span>

    posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>merge<span class="token operator">!</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token keyword">return</span> posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>to_json
<span class="token keyword">end</span>
</code></pre>
<p>但是只有admin用户可以修改用户的permission属性，所以目标应该是让bot帮我们发出对应的请求。注意这里虽然只检查了这几个属性，但最后是直接将用户输入进行merge进去的，也就是可以给post添加任何属性，这里的post数据类型类似于python的字典，所以是可以随便加其他内容的。比如把like改到一万亿，可惜改了也没有用，过不了加法处的检测。</p>
<p>转到前端，看一眼不能xss的情况下怎么让bot发送请求吧。bot访问页面后会点击点赞按钮。所以这个过程中会有如下的代码被调用。</p>
<pre class=" language-javascript"><code class="language-javascript">
        <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> body<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
                method<span class="token punctuation">,</span>
                mode<span class="token punctuation">:</span> <span class="token string">'cors'</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> baseUrl <span class="token operator">=</span> isAdmin <span class="token operator">?</span> <span class="token string">'&lt;?= API_BASE_URL_FOR_ADMIN ?>'</span> <span class="token punctuation">:</span> <span class="token string">'&lt;?= API_BASE_URL ?>'</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addLike</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> likes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'likes'</span><span class="token punctuation">,</span> likes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/api/post/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/like`</span></span><span class="token punctuation">,</span> formData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">renderPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> page <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'index'</span><span class="token punctuation">;</span>
            isAdmin <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">.</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>page <span class="token operator">===</span> <span class="token string">'post'</span> <span class="token operator">&amp;&amp;</span> params<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> ids <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token punctuation">{</span>
                    title<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> like<span class="token punctuation">:</span> <span class="token string">'number'</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> posts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> post<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">of</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`/api/post/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ToDo: implement error handling</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>post<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            data <span class="token operator">=</span> res<span class="token punctuation">.</span>post<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment" spellcheck="true">// to allow duplicate id but show only once</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>id <span class="token keyword">in</span> posts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        post <span class="token operator">=</span> posts<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// type check</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// we don't care the types of properties other than title, content, and like</span>
                            <span class="token comment" spellcheck="true">// because we don't use them</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> types <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">!==</span> types<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            post<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                content<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>id<span class="token punctuation">,</span> post<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    content<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">renderPost</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> post<span class="token punctuation">,</span> isAdmin <span class="token operator">?</span> <span class="token number">1000</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>renderPage在页面onload的时候触发，完成后bot会点赞，触发addLike函数。</p>
<p>renderPage会从hash中获取id，并使用逗号分隔循环get访问后端，将得到的结果依次赋值，最后进行渲染。<br>这里的注释其实给出了蛮多提示，比如那个todo就是一个明显的漏洞点，在for循环里面如果拿到了错误数据至少得continue掉后面的内容，而这里是直接忽略。然后后面那个有点奇怪的赋值，看起来就很原型链污染。加上这里的注释提到不管title, content, and like以外的键值对，更是给污染提供了操作的余地。</p>
<p>但显然，如果id为<code>__proto__</code>，就可以通过data进行原型链污染，加上之前提到过 ，后端的put路由使用merge进行赋值，可以给数据添加任意键值对，但是id为<code>__proto__</code>时必然无法查询到对应的数据，这时就要用到todo注释处的直接跳过，可以提供id为<code>uuid,__proto__</code>，这样子data会在第一轮查询时被赋值，而查询<code>__proto__</code>时会因为<code>res.post</code>不存在而被跳过赋值，继续使用之前的data，实现污染。</p>
<p>写一个简单脚本将特定的post添加键值对。</p>
<pre><code>url = &quot;http://plain-blog.2023.zer0pts.com:8400/api/post/8c835b2d-9207-4445-9ed9-4f2eed19a2ab&quot;
res = requests.put(url, data=&#123;&quot;headers[X-HTTP-Method-Override]&quot;: &quot;PUT&quot;, &quot;title&quot;: &quot;123&quot;, &quot;content&quot;: &quot;456&quot;&#125;)
print(res.text)
</code></pre>
<p>当然，bot段似乎还有一个过滤，不过仔细一看就会发现，其实是写的很抽象的</p>
<pre class=" language-javascript"><code class="language-javascript">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'[!] id:'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>这里只需要id中有一个uuid就行了，所以uuid后再接一个proto也能通过，可以顺利提交给bot。</p>
<p>污染完了就要看接下来怎么伪造请求了，由于后端的修改请求是PUT类型，而这里一共两个请求，一个是<code>request(&#39;GET&#39;, `/api/post/$&#123;id&#125;`)</code>，另一个是<code>request(&#39;POST&#39;, `/api/post/$&#123;id&#125;/like`, formData)</code>，两个的method都无法控制，并且request中指明了cors需要发送预检请求，后端有这样一段配置</p>
<pre class=" language-ruby"><code class="language-ruby">        requested_headers <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>env<span class="token punctuation">[</span><span class="token string">'HTTP_ACCESS_CONTROL_REQUEST_HEADERS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token regex">/\s/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># enumerate requested headers for Access-Control-Allow-Headers</span>
        requested_headers<span class="token punctuation">.</span>filter<span class="token operator">!</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
            h<span class="token punctuation">.</span><span class="token function">downcase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'authorization'</span> <span class="token operator">||</span> \
            h<span class="token punctuation">.</span><span class="token function">downcase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start_with<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">'x-'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># if it starts with X-, then it's safe, I think</span>
        <span class="token keyword">end</span>

        <span class="token comment" spellcheck="true"># admin uses Authorization header</span>
        <span class="token keyword">if</span> <span class="token operator">!</span>requested_headers<span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span>
            requested_headers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>

        headers \
            <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token operator">=</span><span class="token operator">></span> origin<span class="token punctuation">,</span>
            <span class="token string">'Access-Control-Allow-Headers'</span> <span class="token operator">=</span><span class="token operator">></span> requested_headers<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'Access-Control-Allow-Methods'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'GET, POST, OPTIONS'</span> <span class="token comment" spellcheck="true"># ToDo: add PUT method after implementing `PUT /api/post/:id` properly</span>
</code></pre>
<p>刚好没有配置put请求的cors，即使能发送put请求也会被跨域给拦截下来。但是这里同样有另一个很奇怪的配置，并且附上了很奇怪的注释</p>
<blockquote>
<p>h.downcase().start_with?(‘x-‘) # if it starts with X-, then it’s safe, I think</p>
</blockquote>
<p>我直接大胆猜测存在某个x-开头的http header具有奇怪的功能，然后就发现了它：<code>X-HTTP-Method-Override</code>，该header可以无视实际的请求类型，将该请求更改为其他的请求类型，如果能在请求中添加这个header，get请求也能变成put请求，而由于实际上还是get请求，cors也能通过，简直完美。同理，request中因为是get请求，不会有body，污染还能顺带污染一个body上去，把需要修改的内容也塞进去，无敌。已经通了</p>
<p>起码我吃晚饭前是这么想的。然后吃晚饭后发现并打不通</p>
<p>payload应该是<code>uuid,__proto__,uuid</code>，然后bot会在第三个uuid时发送request，其中有被我污染的header和body，但是请求没有发出去，控制台上也没有任何报错。最后发现是代码在这里套了一层try catch，而catch的内容是<code>catch &#123;&#125;</code>，直接忽略了错误，这样子断点也打不下去，都不知道是发生了什么错误，最后手动在控制台复现，发现是这么个报错：<code>Request with GET/HEAD method cannot have body</code>，大坏，找了半天似乎发现这个点无法绕过，差点就感觉凉了。</p>
<p>最后是whj发现ruby的这个<code>sinatra</code>框架的params是可以接受get参数的，且get情况下<code>X-HTTP-Method-Override</code>没有用，但发现sinatra有一个特性是支持post中的<code>_method</code>字段，拥有和<code>X-HTTP-Method-Override</code>相同的功能，故尝试直接注入点赞处的post请求，使用query参数把后面的like吞掉，发送请求</p>
<p>最后试的时候发现我用<code>id=8c835b2d-9207-4445-9ed9-4f2eed19a2ab?,__proto__</code>发送请求，点赞时触发的回复内容是<code>&#39;no title and content specified&#39;</code>，也就是put路由下的回显，最后梭一把<code>id=8c835b2d-9207-4445-9ed9-4f2eed19a2ab?content=1111%26title=222%26permission[flag]=1,__proto__</code>完成利用</p>
<p>最后反复测了几次，感觉是<code>X-HTTP-Method-Override</code>只在post情况下生效，所以之前不成功。</p>
<h2 id="ScoreShare"><a href="#ScoreShare" class="headerlink" title="ScoreShare"></a>ScoreShare</h2><p>另一个前端题，这个题感觉最后差一点做出来，由于是第二天白天开始看的，中午十一点就结束了，最后也没做出来，结束之后也就算了</p>
<p>这个题用了一个玄学js框架来渲染，要求是进行xss。主要代码如下</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">defaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Use cache if available</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token keyword">return</span> window<span class="token punctuation">.</span>config<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Otherwise get config</span>
    <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">await</span> promise<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> window<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadScore</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/score/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> promise<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">defaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> abc <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadScore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'sid'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> abc<span class="token punctuation">;</span>

    <span class="token keyword">let</span> synth <span class="token operator">=</span> <span class="token punctuation">{</span> el<span class="token punctuation">:</span> <span class="token string">'#audio'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> config <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> config<span class="token punctuation">.</span>synth_options<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> option <span class="token operator">=</span> config<span class="token punctuation">.</span>synth_options<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> option<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>synth<span class="token punctuation">[</span>option<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">===</span> undefined<span class="token punctuation">)</span>
                    synth<span class="token punctuation">[</span>option<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> param <span class="token operator">=</span> synth<span class="token punctuation">[</span>option<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
                Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    param<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> option<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                synth<span class="token punctuation">[</span>option<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> option<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">new</span> <span class="token class-name">ABCJS<span class="token punctuation">.</span>Editor</span><span class="token punctuation">(</span><span class="token string">'abc'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> paper_id<span class="token punctuation">:</span> <span class="token string">'paper'</span><span class="token punctuation">,</span> synth <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>漏洞点在defaultConfig处，由于使用的是window.config，导致用户可以使用dom clobbering控制其内容，当前页面下有一个iframe，其内容用户可控</p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">sandbox</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>allow-same-origin<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ title }}<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ link }}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">></span></span>
</code></pre>
<p>令其name为config，即可控制window.config，然后在下面config.synth_options就可以一通操作</p>
<p>同时，前端代码有一个api路由，可以返回用户输入的string，此处的link填api路由就能完全控制iframe的内容</p>
<pre><code>@app.route(&quot;/api/score/&lt;sid&gt;&quot;)
def api_score(sid: str):
    abc = db().hget(sid, &#39;abc&#39;)
    if abc is None:
        return flask.abort(404)
    else:
        return flask.Response(abc)
</code></pre>
<p><a target="_blank" rel="external nofollow noopener noreferrer" href="https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/">使用 Dom Clobbering 扩展 XSS</a><br>看路队的博客，可以通过iframe src doc和a标签顶级套娃，一路控制属性，实现原型链污染。不过最后污染进去的是a标签的内容，不是很好完全控制，最后打了个污染但是xss不出来，凉。<br>我以前还以为srcdoc会跨域来着，居然不会，玄学。<br>抄一个天哥的payload，最后赛后天哥说可以通过污染warning属性来xss</p>
<pre><code>&lt;iframe name=synth_options srcdoc=&quot;&lt;iframe srcdoc=&#39;&lt;a id=value name=loopHandler href=23333&gt;test&lt;/a&gt;&lt;a id=value&gt;&lt;a id=value name=repeatTitle href=byc&gt;test&lt;/a&gt;&#39; name=&#39;__proto__&#39;&gt;&quot;&gt;&lt;/iframe&gt;
</code></pre>
<p>没仔细看，猛摆</p>
<h2 id="Neko-Note"><a href="#Neko-Note" class="headerlink" title="Neko Note"></a>Neko Note</h2><p>这个题我没看，好像是有一个简单的xss点，可以在a标签里面xss，使用onfocus和autofocus自动触发。然后好像是bot会先输入密码，再把密码删掉，最后再触发xss？最后反正是需要把那个密码恢复出来。一开始他们按的是history.back，觉得用回退键可以恢复，但是按了半天没效果</p>
<p>最后是全知全能的rmb拿出来一个究极<code>document.execCommand(&#39;undo&#39;);</code>，该命令约等于Ctrl+z，撤销修改，一键还原密码。<br>说起来这个命令感觉在以前那个shadow dom的题里面见过，好像是可以用find一类的命令当Ctrl+f用，以选中shadow dom内的元素</p>
<p>还得是rmb，太吊了8</p>
<h2 id="Ringtone"><a href="#Ringtone" class="headerlink" title="Ringtone"></a>Ringtone</h2><p>也没看，点开是个Chrome插件题就直接关了，插件一个字没写过，就懂一点点基础概念。</p>
<p>反正最后rmb究极输出，可惜在比赛结束后二十多分钟才做出来，可惜可惜。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/wp/" rel="tag"># wp</a>
              <a href="/tags/XSS/" rel="tag"># XSS</a>
              <a href="/tags/JavaScript/" rel="tag"># JavaScript</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E4%BA%91%E5%87%BD%E6%95%B0C2%E9%9A%90%E8%97%8F.html" rel="prev" title="云函数C2隐藏">
      <i class="fa fa-chevron-left"></i> 云函数C2隐藏
    </a></div>
      <div class="post-nav-item">
    <a href="/HackBrowserDataManual%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0.html" rel="next" title="HackBrowserDataManual开发日记">
      HackBrowserDataManual开发日记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#zer0ptsCTF2023"><span class="nav-number">1.</span> <span class="nav-text">zer0ptsCTF2023</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#warmup-profile"><span class="nav-number">1.1.</span> <span class="nav-text">warmup profile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jqi"><span class="nav-number">1.2.</span> <span class="nav-text">jqi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plain-Blog"><span class="nav-number">1.3.</span> <span class="nav-text">Plain Blog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ScoreShare"><span class="nav-number">1.4.</span> <span class="nav-text">ScoreShare</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Neko-Note"><span class="nav-number">1.5.</span> <span class="nav-text">Neko Note</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ringtone"><span class="nav-number">1.6.</span> <span class="nav-text">Ringtone</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z3ratu1" src="https://thirdqq.qlogo.cn/g?b=sdk&k=LSKHut5Wmfic1emlMT4FpuA&kti=ZMCGFwAAAAI&s=640&t=1673848139">
  <p class="site-author-name" itemprop="name">Z3ratu1</p>
  <div class="site-description" itemprop="description">与其感慨路难行，不如现在出发</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">187</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z3ratu1</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '7H8kg0XdWO8IbhOcu4K1JaAT-gzGzoHsz',
      appKey     : 'wPKQjkbVtvPaRR7gh2yjfLSi',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
